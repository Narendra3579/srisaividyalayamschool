<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Sai Vidyalayam - Admin Portal</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <style>
        body { font-family: 'Open Sans', sans-serif; overflow-x: hidden; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }
        
        .modal { transition: opacity 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; }
        
        .video-container { 
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; 
            background: #1e1e1e; border-radius: 20px; cursor: pointer; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .video-container iframe, .video-container video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            border: none !important; object-fit: cover;
        }

        /* PRINT STYLES */
        #printable-area { display: none; }
        @media print {
            body * { visibility: hidden !important; }
            #printable-area, #printable-area * { visibility: visible !important; }
            #printable-area { 
                display: block !important; position: absolute !important; 
                left: 0 !important; top: 0 !important; width: 100% !important; 
                background: white !important; color: black !important;
                margin: 0 !important; padding: 20px !important;
            }
        }

        /* LANDING PAGE ANIMATIONS */
        .cloud-slow { animation: drift 60s linear infinite; }
        .cloud-very-slow { animation: drift 90s linear infinite; }
        @keyframes drift { 
            from { transform: translateX(-150px); } 
            to { transform: translateX(950px); } 
        }

        .bird-fly { animation: flyAcross 40s linear infinite; }
        @keyframes flyAcross {
            from { transform: translate(-100px, 60px); }
            to { transform: translate(950px, 30px); }
        }
        .bird-wing { animation: flap 1.2s ease-in-out infinite alternate; transform-origin: center; }
        @keyframes flap {
            from { transform: scaleY(1); }
            to { transform: scaleY(0.2); }
        }

        .bus-drive { animation: driveAcross 18s linear infinite; transform-box: view-box; }
        @keyframes driveAcross { from { transform: translateX(850px); } to { transform: translateX(-250px); } }

        #hero-text-slider .slide { display: none; }
        #hero-text-slider .slide.active { display: block; animation: slideUpFade 0.8s ease-out; }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* BOOK OPENING SPLASH SCREEN */
        #cloud-loader {
            position: fixed; inset: 0; background: #ffffff; z-index: 1000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .book-wrap { width: 100px; height: 70px; position: relative; perspective: 500px; }
        .book-base { width: 100%; height: 100%; background: #f8fafc; border: 3px solid #1e3a8a; border-radius: 2px 5px 5px 2px; position: absolute; left: 0; top: 0; }
        .book-cover { width: 50%; height: 100%; background: #1e3a8a; position: absolute; right: 0; top: 0; transform-origin: left; border-radius: 0 5px 5px 0; animation: openBook 2.5s infinite ease-in-out; z-index: 2; }
        .book-page { width: 48%; height: 90%; background: white; position: absolute; right: 1%; top: 5%; border-left: 1px solid #cbd5e1; z-index: 1; }
        @keyframes openBook {
            0%, 20% { transform: rotateY(0deg); }
            50%, 75% { transform: rotateY(-155deg); }
            100% { transform: rotateY(0deg); }
        }

        .sync-pulse { width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.7; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.7; } }

        #status-toast {
            position: fixed; bottom: 20px; right: 20px; z-index: 200; 
            transform: translateY(100px); transition: transform 0.3s ease-out;
        }
        #status-toast.show { transform: translateY(0); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- SPLASH SCREEN -->
    <div id="cloud-loader">
        <div class="loader-container mb-6">
            <div class="book-wrap">
                <div class="book-base"></div>
                <div class="book-page"></div>
                <div class="book-cover"></div>
            </div>
        </div>
        <p id="loader-text" class="text-xs font-bold tracking-[0.3em] uppercase text-indigo-900">Sri Sai Vidyalayam</p>
    </div>

    <!-- TOAST NOTIFICATIONS -->
    <div id="status-toast" class="bg-indigo-950 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 font-bold border border-indigo-700">
        <span class="material-symbols-outlined text-amber-400" id="toast-icon">sync</span>
        <span id="toast-msg">Cloud Sync Active</span>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-indigo-950 text-white shadow-xl sticky top-0 z-40 no-print border-b border-indigo-800">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center space-x-4 cursor-pointer group" onclick="router.navigate('home')">
                    <div class="bg-white text-indigo-950 h-12 w-12 rounded-2xl flex items-center justify-center font-bold text-xl border-2 border-amber-400 transform group-hover:rotate-6 transition font-bold">SSV</div>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight leading-none uppercase">Sri Sai Vidyalayam</h1>
                        <p class="text-[9px] text-amber-400 uppercase tracking-[0.3em] font-black mt-1">Excellence in Education</p>
                    </div>
                </div>
                <div class="hidden md:flex space-x-2 items-center font-bold">
                    <button class="hover:bg-indigo-800/50 px-4 py-2 rounded-lg transition text-sm uppercase" onclick="router.navigate('home')">Home</button>
                    <button class="hover:bg-indigo-800/50 px-4 py-2 rounded-lg transition text-sm uppercase" onclick="router.navigate('updates')">Daily Updates</button>
                    <button class="bg-amber-500 hover:bg-amber-400 text-indigo-950 px-5 py-2.5 rounded-xl transition flex items-center gap-2 shadow-lg shadow-amber-500/20 text-xs uppercase font-bold" onclick="router.navigate('login')">
                        <span class="material-symbols-outlined text-lg">admin_panel_settings</span> Admin Login
                    </button>
                </div>
                <button class="md:hidden p-2 rounded-lg bg-indigo-800" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                    <span class="material-symbols-outlined text-3xl font-bold">menu</span>
                </button>
            </div>
        </div>
        <!-- MOBILE MENU -->
        <div class="hidden md:hidden bg-indigo-900 border-t border-indigo-800 p-4" id="mobile-menu">
            <button class="block w-full text-left py-3 px-4 rounded-xl hover:bg-indigo-800 mb-1" onclick="router.navigate('home'); document.getElementById('mobile-menu').classList.add('hidden')">Home</button>
            <button class="block w-full text-left py-3 px-4 rounded-xl hover:bg-indigo-800 mb-1" onclick="router.navigate('updates'); document.getElementById('mobile-menu').classList.add('hidden')">Daily Updates</button>
            <button class="block w-full text-left py-3 px-4 bg-amber-500 text-indigo-950 rounded-xl font-bold uppercase text-xs" onclick="router.navigate('login'); document.getElementById('mobile-menu').classList.add('hidden')">Admin Login</button>
        </div>
    </nav>

    <div id="app">
        <!-- VIEW: HOME -->
        <div id="view-home" class="min-h-screen hidden">
            <!-- HERO SECTION -->
            <section class="hero-bg pt-12 md:pt-20 pb-0 border-b border-slate-200 min-h-[550px] flex flex-col">
                <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center flex-1">
                    <div class="relative z-10 text-center lg:text-left space-y-6">
                        <span class="inline-block px-4 py-1.5 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-widest">Recognised by Govt of AP</span>
                        <div id="hero-text-slider" class="min-h-[220px]">
                            <div class="slide active">
                                <h2 class="text-5xl md:text-7xl font-extrabold text-indigo-950 leading-[1.1]">Pollution Free <br><span class="text-green-600 underline decoration-amber-400 underline-offset-8">Green Campus</span></h2>
                                <p class="text-lg text-slate-600 mt-4 font-medium leading-relaxed">A serene environment located away from city noise and dust, ensuring a healthy learning space.</p>
                            </div>
                            <div class="slide">
                                <h2 class="text-5xl md:text-7xl font-extrabold text-indigo-950 leading-[1.1]">Expert & <br><span class="text-orange-500 underline decoration-amber-400 underline-offset-8">Dedicated Faculty</span></h2>
                                <p class="text-lg text-slate-600 mt-4 font-medium leading-relaxed">Qualified subject experts committed to personalized attention and academic excellence.</p>
                            </div>
                            <div class="slide">
                                <h2 class="text-5xl md:text-7xl font-extrabold text-indigo-950 leading-[1.1]">Safe & Secure <br><span class="text-red-600 underline decoration-amber-400 underline-offset-8">No Traffic Risk</span></h2>
                                <p class="text-lg text-slate-600 mt-4 font-medium leading-relaxed">Located in a peaceful residential zone with zero heavy traffic risks for students.</p>
                            </div>
                        </div>
                        <button onclick="router.navigate('updates')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-2xl font-bold shadow-xl transition active:scale-95">View Daily Board</button>
                    </div>
                    <div class="relative h-[300px] md:h-[450px]">
                        <svg viewBox="0 0 800 500" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                            <circle cx="700" cy="80" r="45" fill="#FFF176" />
                            <!-- SLOW BIRDS -->
                            <g class="bird-fly">
                                <g transform="translate(0,0)"><path class="bird-wing" d="M0,0 Q5,-8 10,0 Q15,-8 20,0" stroke="#334155" stroke-width="2" fill="none" /></g>
                                <g transform="translate(50,25)"><path class="bird-wing" d="M0,0 Q5,-8 10,0 Q15,-8 20,0" stroke="#334155" stroke-width="2" fill="none" /></g>
                                <g transform="translate(-30,50)"><path class="bird-wing" d="M0,0 Q5,-8 10,0 Q15,-8 20,0" stroke="#334155" stroke-width="2" fill="none" /></g>
                            </g>
                            <!-- SKY BLUE CLOUDS -->
                            <g class="cloud-very-slow" opacity="0.7">
                                <g transform="translate(100,120)"><circle cx="0" cy="0" r="25" fill="#87CEEB" /><circle cx="30" cy="0" r="30" fill="#87CEEB" /><circle cx="60" cy="0" r="25" fill="#87CEEB" /></g>
                            </g>
                            <g class="cloud-slow" opacity="0.9">
                                <g transform="translate(450,60)"><circle cx="0" cy="0" r="15" fill="#87CEEB" /><circle cx="15" cy="0" r="20" fill="#87CEEB" /><circle cx="35" cy="0" r="15" fill="#87CEEB" /></g>
                            </g>
                            <rect x="0" y="400" width="800" height="100" fill="#334155" />
                            <g class="bus-drive">
                                <rect x="0" y="340" width="160" height="70" rx="12" fill="#fbbf24" />
                                <rect x="15" y="350" width="30" height="20" rx="2" fill="#f8fafc" opacity="0.8" />
                                <rect x="55" y="350" width="30" height="20" rx="2" fill="#f8fafc" opacity="0.8" />
                                <rect x="95" y="350" width="50" height="20" rx="2" fill="#f8fafc" opacity="0.8" />
                                <circle cx="40" cy="410" r="12" fill="#1e293b" />
                                <circle cx="120" cy="410" r="12" fill="#1e293b" />
                                <text x="80" y="385" font-family="sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#431407">SRI SAI VIDYALAYAM</text>
                            </g>
                        </svg>
                    </div>
                </div>
            </section>

            <!-- RECENT BLOG -->
            <section class="max-w-7xl mx-auto px-4 py-24 font-bold text-center">
                <h2 class="text-4xl font-black text-indigo-950 uppercase mb-8 border-b pb-4 inline-block">Recent Blog</h2>
                <div id="blog-posts-feed" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12 text-left"></div>
            </section>
        </div>

        <!-- VIEW: DAILY UPDATES -->
        <div id="view-updates" class="min-h-screen hidden bg-slate-50 py-12">
            <div class="max-w-5xl mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-black text-indigo-950 uppercase tracking-tighter">Daily Board & Notices</h2>
                    <p class="text-slate-500 mt-2 font-medium">Keep track of homework, tests, and school circulars.</p>
                </div>
                <div class="bg-indigo-950 rounded-[40px] shadow-2xl p-8 mb-12">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                        <h3 class="text-2xl font-black text-white uppercase flex items-center gap-3">
                            <span class="material-symbols-outlined text-amber-400 text-4xl">campaign</span> Class Wise Board
                        </h3>
                        <div class="w-full md:w-64">
                            <select id="board-class-filter" class="w-full bg-indigo-900 border border-indigo-700 text-white rounded-2xl p-4 font-bold outline-none" onchange="home.renderUpdates()"></select>
                        </div>
                    </div>
                    <ul id="board-updates-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></ul>
                </div>
                <div class="text-center">
                    <button onclick="router.navigate('home')" class="text-indigo-600 font-bold hover:underline">Back to Home</button>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN PANEL -->
        <div id="view-admin" class="min-h-screen bg-gray-50 flex flex-col md:flex-row hidden font-bold">
            <div class="bg-blue-900 text-white w-full md:w-64 flex-shrink-0 flex flex-col md:h-screen md:sticky top-0 no-print shadow-xl">
                <div class="p-6 border-b border-blue-800 font-black text-xl flex items-center gap-2">
                    <span class="material-symbols-outlined text-amber-400">school</span> Admin
                </div>
                <nav class="flex-1 p-4 space-y-1 font-bold">
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="dashboard" onclick="admin.switchTab('dashboard')"><span class="material-symbols-outlined">dashboard</span> Dashboard</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="admissions" onclick="admin.switchTab('admissions')"><span class="material-symbols-outlined">person_add</span> Admissions</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="students" onclick="admin.switchTab('students')"><span class="material-symbols-outlined">group</span> Records</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="dailyboard" onclick="admin.switchTab('dailyboard')"><span class="material-symbols-outlined">campaign</span> Daily Board</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="blog" onclick="admin.switchTab('blog')"><span class="material-symbols-outlined">post_add</span> Manage Blog</button>
                </nav>
                <div class="p-4 border-t border-blue-800">
                    <button onclick="auth_manager.logout()" class="w-full bg-red-800 text-white py-2 rounded-lg font-bold">Logout</button>
                </div>
            </div>

            <div class="flex-1 p-6 md:p-8 overflow-y-auto font-bold">
                <!-- DASHBOARD -->
                <div id="tab-dashboard" class="admin-content space-y-6">
                    <h2 class="text-2xl font-black font-bold">Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-blue-500 font-bold"><h4 class="text-[10px] font-black text-gray-400">Total Target</h4><div class="text-3xl font-black text-blue-900" id="stat-total">₹0</div></div>
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-orange-400 font-bold"><h4 class="text-[10px] font-black text-gray-400">Old Fee Due</h4><div class="text-3xl font-black text-orange-600" id="stat-old">₹0</div></div>
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-green-500 font-bold"><h4 class="text-[10px] font-black text-gray-400">Collected</h4><div class="text-3xl font-black text-green-600" id="stat-collected">₹0</div></div>
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-red-500 font-bold"><h4 class="text-[10px] font-black text-gray-400">Balance</h4><div class="text-3xl font-black text-red-600" id="stat-pending">₹0</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border h-80 font-bold"><canvas id="feeChart"></canvas></div>
                </div>

                <!-- ADMISSIONS -->
                <div id="tab-admissions" class="admin-content hidden space-y-6">
                    <h2 class="text-2xl font-black font-bold">New Admission</h2>
                    <form onsubmit="admin.submitAdmission(event)" class="bg-white rounded-3xl shadow-xl p-8 border grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-bold">Admission ID</label><input type="text" name="admnNo" class="w-full border-2 p-3 rounded-xl focus:border-blue-500 font-bold" required></div>
                        <div><label class="block text-sm font-bold">Grade</label><select id="admit-class" name="classGrade" class="w-full border-2 p-3 rounded-xl font-bold"></select></div>
                        <div><label class="block text-sm font-bold">Student Name</label><input type="text" name="name" class="w-full border-2 p-3 rounded-xl font-bold" required></div>
                        <div><label class="block text-sm font-bold">Father's Name / Guardian Name</label><input type="text" name="father" class="w-full border-2 p-3 rounded-xl font-bold" required></div>
                        <div class="col-span-full grid grid-cols-3 gap-4 border-t pt-6">
                            <div><label class="block text-[10px] font-bold">Yearly Fee</label><input type="number" id="admit-fee" name="totalFee" class="w-full border-2 p-3 font-black" required></div>
                            <div><label class="block text-[10px] font-bold">Old Fee</label><input type="number" name="oldDue" value="0" class="w-full border-2 p-3 text-orange-600"></div>
                            <div><label class="block text-[10px] font-bold">Initial Pay</label><input type="number" name="initialPay" value="0" class="w-full border-2 p-3 text-green-600 font-bold"></div>
                        </div>
                        <button type="submit" class="col-span-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">Confirm Registration</button>
                    </form>
                </div>

                <!-- RECORDS -->
                <div id="tab-students" class="admin-content hidden space-y-6">
                    <div class="flex justify-between items-center"><h2 class="text-2xl font-black font-bold">Records</h2>
                        <div class="flex gap-2">
                            <button onclick="printer.printMasterLedger()" class="bg-indigo-700 text-white px-5 py-2 rounded-xl font-bold">Print Ledger</button>
                            <button onclick="admin.exportExcel()" class="bg-indigo-950 text-white px-5 py-2 rounded-xl font-bold">Export Excel</button>
                        </div>
                    </div>
                    <div class="flex gap-2 font-bold"><select id="filter-class" class="border-2 rounded-xl bg-white px-4 font-bold" onchange="admin.renderStudents()"></select><input type="text" id="filter-search" class="border-2 rounded-xl flex-1 px-4 py-2 font-bold" placeholder="Search..." oninput="admin.renderStudents()"></div>
                    <div class="bg-white rounded-3xl shadow-xl overflow-x-auto"><table class="min-w-full text-sm font-bold"><thead class="bg-gray-50 border-b"><tr><th class="p-5 text-left font-bold">ID</th><th class="p-5 text-left font-bold">Name</th><th class="p-5 text-left font-bold">Class</th><th class="p-5 text-left text-orange-600 font-bold">Old Fee</th><th class="p-5 text-left font-bold">Balance</th><th class="p-5 text-right font-bold">Actions</th></tr></thead><tbody id="student-list-body" class="divide-y"></tbody></table></div>
                </div>

                <!-- DAILY BOARD MANAGEMENT -->
                <div id="tab-dailyboard" class="admin-content hidden space-y-6">
                    <h2 class="text-2xl font-black font-bold">Daily Board Management</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <form onsubmit="admin.addUpdate(event)" class="bg-white p-8 rounded-3xl shadow border space-y-4 font-bold">
                            <div class="grid grid-cols-2 gap-4"><select id="update-class" class="border p-3 rounded-xl font-bold"></select><select id="update-category" class="border p-3 rounded-xl font-bold"><option>Homework</option><option>Class Test</option><option>Event</option><option>General News</option></select></div>
                            <input type="date" id="update-date" class="w-full border p-3 rounded-xl font-bold" required>
                            <textarea id="update-text" class="w-full border p-4 rounded-xl h-32 font-bold" placeholder="Message..." required></textarea>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Post Notice</button>
                        </form>
                        <div class="bg-white p-6 rounded-3xl shadow h-[500px] overflow-y-auto font-bold"><ul id="admin-updates-list" class="space-y-3 font-bold"></ul></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFILE MODAL -->
        <div id="profile-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-70 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[3rem] shadow-2xl flex flex-col overflow-hidden font-bold">
                <div class="bg-blue-900 text-white p-6 flex justify-between items-center"><h2 id="modal-title" class="text-2xl font-black"></h2><button onclick="admin.closeModal()" class="text-white text-4xl">&times;</button></div>
                <div class="flex-1 overflow-y-auto p-10 bg-gray-50">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="space-y-6">
                            <div class="bg-white p-5 rounded-lg shadow border font-bold">
                                <p>Grade: <span id="modal-class"></span></p>
                                <p>Parent: <span id="modal-father"></span></p>
                            </div>
                            <div class="bg-blue-50 p-5 rounded-3xl border border-blue-200 font-bold">
                                <div class="flex justify-between font-bold"><span>Old Fee:</span> <span id="modal-fee-old"></span></div>
                                <div class="flex justify-between font-bold text-red-600"><span>Balance:</span> <span id="modal-fee-due"></span></div>
                            </div>
                            <button onclick="printer.printLedger()" class="w-full bg-white border-2 p-4 rounded-2xl font-bold shadow-sm">Print Ledger</button>
                            <button onclick="admin.showDeleteConfirm()" class="w-full bg-red-50 text-red-600 p-3 rounded-2xl font-bold uppercase text-[10px]">Delete Record</button>
                        </div>
                        <div class="lg:col-span-2 space-y-6 font-bold">
                            <form onsubmit="admin.payFee(event)" class="bg-white p-8 rounded-3xl shadow border grid grid-cols-2 gap-4 font-bold">
                                <input type="text" id="pay-rec" class="border p-3 rounded-xl" placeholder="Receipt #" required>
                                <input type="date" id="pay-date" class="border p-3 rounded-xl font-bold" required>
                                <select id="pay-category" class="border p-3 rounded-xl font-bold"><option>Academic Fee</option><option>Old Fee</option></select>
                                <input type="number" id="pay-amt" class="border-2 border-green-500 p-3 rounded-xl font-bold" placeholder="Amount" required>
                                <button type="submit" class="col-span-2 bg-green-600 text-white py-4 rounded-2xl font-bold">Record Payment</button>
                            </form>
                            <div class="bg-white rounded-3xl shadow border overflow-hidden font-bold"><table class="w-full text-xs text-left"><tbody id="modal-history" class="divide-y"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DELETE MODAL -->
        <div id="delete-modal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-80 hidden-modal modal font-bold">
            <div class="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl font-bold">
                <span class="material-symbols-outlined text-6xl text-red-600 mb-2">security</span>
                <h3 class="text-xl font-black mb-4 text-red-600 uppercase tracking-widest font-bold">Pin Required</h3>
                <input type="password" id="delete-password" class="w-full border-2 p-5 rounded-2xl text-center mb-8 font-black text-3xl" placeholder="••••">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="admin.closeDeleteModal()" class="bg-gray-100 py-3 rounded-2xl font-bold uppercase text-[10px]">Cancel</button>
                    <button onclick="admin.confirmDelete()" class="bg-red-600 text-white py-3 rounded-2xl font-bold uppercase text-[10px]">Delete</button>
                </div>
            </div>
        </div>

        <div id="printable-area"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Environment Setup
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(firebaseConfigRaw);
        
        let app, auth, db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sri-sai-vidyalayam';

        window.initCloud = async function() {
            if (!firebaseConfig.apiKey) {
                document.getElementById('loader-text').innerText = "Static Mode.";
                setTimeout(() => document.getElementById('cloud-loader').style.display = 'none', 1000);
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
                initSync();
                document.getElementById('cloud-loader').style.display = 'none';
            } catch (e) { document.getElementById('loader-text').innerHTML = "<span style='color:red;'>Link Broken.</span>"; }
        }

        const initSync = () => {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => {
                state.students = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
                if (document.getElementById('view-admin').offsetParent) { admin.renderDash(); admin.renderStudents(); }
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'updates'), (snap) => {
                state.updates = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() })).sort((a,b) => b.id - a.id);
                home.renderUpdates();
                if (document.getElementById('view-admin').offsetParent) admin.renderHistory();
            });
        };

        window.state = {
            isLoggedIn: false, activeStudentId: null, activeHomeCategory: 'All',
            fees: { "Nursery": 15000, "LKG": 16000, "UKG": 17000, "1st Class": 18000, "2nd Class": 19000, "3rd Class": 20000, "4th Class": 21000, "5th Class": 22000, "6th Class": 23000, "7th Class": 24000, "8th Class": 25000, "9th Class": 28000, "10th Class": 30000 },
            students: [], updates: [], blogPosts: []
        };

        window.ui = {
            showToast: (msg, isError = false) => {
                const toast = document.getElementById('status-toast');
                document.getElementById('toast-msg').innerText = msg;
                document.getElementById('toast-icon').innerText = isError ? 'error' : 'sync';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        };

        window.router = {
            navigate: (view) => {
                if(view === 'admin' && !state.isLoggedIn) return router.navigate('login');
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${view}`);
                if (target) target.classList.remove('hidden');
                if(view === 'home') home.init();
                if(view === 'admin') admin.init();
                window.scrollTo(0,0);
            }
        };

        window.auth_manager = {
            login: (e) => {
                e.preventDefault();
                if(document.getElementById('userid').value === 'admin' && document.getElementById('password').value === '123') {
                    state.isLoggedIn = true; router.navigate('admin');
                } else ui.showToast('Invalid PIN', true);
            },
            logout: () => { state.isLoggedIn = false; router.navigate('home'); }
        };

        window.home = {
            init: () => {
                const classOpts = Object.keys(state.fees).map(c => `<option value="${c}">${c}</option>`).join('');
                document.querySelectorAll('#board-class-filter, #home-class-filter').forEach(s => s.innerHTML = `<option value="All">All Classes</option>` + classOpts);
                home.renderUpdates(); home.startTextSlider();
            },
            startTextSlider: () => {
                let slides = document.querySelectorAll('#hero-text-slider .slide');
                let current = 0; if(window.textInterval) clearInterval(window.textInterval);
                if (slides.length <= 1) return;
                window.textInterval = setInterval(() => {
                    slides[current].classList.remove('active');
                    current = (current + 1) % slides.length;
                    slides[current].classList.add('active');
                }, 5000);
            },
            renderUpdates: () => {
                const clsHome = document.getElementById('home-class-filter')?.value || 'All';
                const clsBoard = document.getElementById('board-class-filter')?.value || 'All';
                
                const filteredHome = state.updates.filter(u => u.classGrade === 'All' || u.classGrade === clsHome);
                const filteredBoard = state.updates.filter(u => u.classGrade === 'All' || u.classGrade === clsBoard);

                const mapUpdate = (u) => `<div class="bg-white p-4 rounded-xl border-l-4 border-indigo-500 shadow-sm font-bold"><div class="text-[9px] uppercase text-slate-400 mb-1">${u.category} • ${u.date}</div><p class="text-sm font-bold text-indigo-900">${u.text}</p></div>`;

                const homeFeed = document.getElementById('updates-feed');
                if (homeFeed) homeFeed.innerHTML = filteredHome.map(mapUpdate).join('') || '<p class="text-white opacity-50">No updates.</p>';
                
                const boardList = document.getElementById('board-updates-list');
                if (boardList) boardList.innerHTML = filteredBoard.map(mapUpdate).join('') || '<p class="text-slate-400 text-center col-span-full">Empty Board.</p>';
            }
        };

        window.admin = {
            init: () => {
                const opts = Object.keys(state.fees).map(c => `<option value="${c}">${c}</option>`).join('');
                document.querySelectorAll('#admit-class, #filter-class, #update-class').forEach(s => s.innerHTML = (s.id.includes('filter') || s.id.includes('update') ? '<option value="All">All Classes</option>' : '') + opts);
                document.getElementById('update-date').valueAsDate = new Date();
                admin.renderDash(); admin.renderStudents();
            },
            switchTab: (tab) => {
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
            },
            renderDash: () => {
                let tT = 0, tP = 0, tO = 0;
                state.students.forEach(s => {
                    tT += (s.totalFee || 0) + (s.oldDue || 0); tP += (s.paid || 0);
                    const po = (s.history || []).filter(h => h.category === 'Old Fee').reduce((sum, h) => sum + h.amount, 0);
                    tO += Math.max(0, (s.oldDue || 0) - po);
                });
                document.getElementById('stat-total').innerText = `₹${tT.toLocaleString()}`;
                document.getElementById('stat-old').innerText = `₹${tO.toLocaleString()}`;
                document.getElementById('stat-collected').innerText = `₹${tP.toLocaleString()}`;
                document.getElementById('stat-pending').innerText = `₹${(tT-tP).toLocaleString()}`;
                
                const ctx = document.getElementById('feeChart').getContext('2d');
                if(window.feeChartObj) window.feeChartObj.destroy();
                window.feeChartObj = new Chart(ctx, { type: 'bar', data: { labels: ['Target', 'Paid', 'Due'], datasets: [{ label: 'Status', data: [tT, tP, tT-tP], backgroundColor: ['#1e3a8a', '#10b981', '#ef4444'] }] }, options: { maintainAspectRatio: false } });
            },
            submitAdmission: async (e) => {
                e.preventDefault();
                if (!db) return;
                const fd = new FormData(e.target);
                const sId = Date.now().toString();
                const data = { id: sId, admnNo: fd.get('admnNo'), name: fd.get('name'), father: fd.get('father'), contact: fd.get('contact'), classGrade: fd.get('classGrade'), totalFee: parseFloat(fd.get('totalFee')), oldDue: parseFloat(fd.get('oldDue') || 0), paid: 0, history: [] };
                const initPay = parseFloat(fd.get('initialPay') || 0);
                if (initPay > 0) { data.paid = initPay; data.history.push({ receiptNo: 'REC-'+sId.slice(-4), date: new Date().toISOString().split('T')[0], amount: initPay, category: 'Academic Fee' }); }
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sId), data);
                ui.showToast('Registered!'); e.target.reset(); admin.switchTab('students');
            },
            renderStudents: () => {
                const body = document.getElementById('student-list-body');
                const cls = document.getElementById('filter-class').value;
                const txt = document.getElementById('filter-search').value.toLowerCase();
                const filtered = state.students.filter(s => (cls === 'All' || s.classGrade === cls) && (s.name.toLowerCase().includes(txt) || s.admnNo.toLowerCase().includes(txt)));
                body.innerHTML = filtered.map(s => `<tr class="border-b font-bold" onclick="admin.openModal('${s.id}')"><td class="p-4">${s.admnNo}</td><td class="p-4 font-bold">${s.name}</td><td class="p-4">${s.classGrade}</td><td class="p-4 text-orange-600">₹${(s.oldDue||0).toLocaleString()}</td><td class="p-4 font-black">₹${((s.totalFee+s.oldDue)-s.paid).toLocaleString()}</td><td class="p-4 text-right"><button class="bg-blue-900 text-white px-3 py-1 rounded">Manage</button></td></tr>`).join('');
            },
            openModal: (id) => {
                state.activeStudentId = id; const s = state.students.find(x => x.id === id);
                document.getElementById('modal-title').innerText = s.name;
                document.getElementById('modal-class').innerText = s.classGrade;
                document.getElementById('modal-father').innerText = s.father;
                document.getElementById('modal-fee-old').innerText = `₹${(s.oldDue || 0).toLocaleString()}`;
                document.getElementById('modal-fee-due').innerText = `₹${((s.totalFee + s.oldDue) - s.paid).toLocaleString()}`;
                document.getElementById('modal-history').innerHTML = (s.history || []).map(h => `<tr class="font-bold"><td class="p-4">${h.date}</td><td class="p-4">${h.category}</td><td class="p-4 text-right">₹${h.amount.toLocaleString()}</td></tr>`).join('');
                document.getElementById('profile-modal').classList.remove('hidden-modal');
                document.getElementById('pay-rec').value = 'REC-' + Date.now().toString().slice(-6);
                document.getElementById('pay-date').valueAsDate = new Date();
            },
            payFee: async (e) => {
                e.preventDefault();
                const s = state.students.find(x => x.id === state.activeStudentId);
                const amt = parseFloat(document.getElementById('pay-amt').value);
                s.paid += amt;
                s.history.push({ receiptNo: document.getElementById('pay-rec').value, date: document.getElementById('pay-date').value, category: document.getElementById('pay-category').value, amount: amt });
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id), s);
                ui.showToast('Synced'); admin.openModal(s.id);
            },
            closeModal: () => document.getElementById('profile-modal').classList.add('hidden-modal'),
            showDeleteConfirm: () => { document.getElementById('delete-password').value = ''; document.getElementById('delete-modal').classList.remove('hidden-modal'); },
            closeDeleteModal: () => document.getElementById('delete-modal').classList.add('hidden-modal'),
            confirmDelete: async () => {
                if(document.getElementById('delete-password').value === '123' && db) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', state.activeStudentId));
                    admin.closeDeleteModal(); admin.closeModal(); ui.showToast('Deleted');
                } else ui.showToast('Invalid PIN', true);
            },
            addUpdate: async (e) => {
                e.preventDefault();
                const data = { id: Date.now(), text: document.getElementById('update-text').value, category: document.getElementById('update-category').value, classGrade: document.getElementById('update-class').value, date: document.getElementById('update-date').value };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'updates'), data);
                ui.showToast('Published'); e.target.reset();
            },
            renderHistory: () => {
                document.getElementById('admin-updates-list').innerHTML = state.updates.map(u => `<li class="bg-slate-50 p-4 rounded-xl flex justify-between items-center border font-bold"><div><div class="text-[9px] uppercase font-bold text-gray-400">${u.category}</div><div class="text-sm font-bold">${u.text}</div></div><button onclick="admin.deleteUpdate('${u.firestoreId}')" class="text-red-600"><span class="material-symbols-outlined">delete</span></button></li>`).join('');
            },
            deleteUpdate: async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'updates', id)); ui.showToast('Removed'); },
            exportExcel: () => { const d = state.students.map(s => ({"ID": s.admnNo, "Name": s.name, "Class": s.classGrade, "Balance": (s.totalFee + s.oldDue) - s.paid})); const ws = XLSX.utils.json_to_sheet(d); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Students"); XLSX.writeFile(wb, `SSV_Data.xlsx`); },
            exportData: () => { const b = new Blob([JSON.stringify(state)], {type: 'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'SSV_Backup.json'; a.click(); }
        };

        window.printer = {
            printMasterLedger: () => {
                const rows = state.students.map(s => `<tr class="font-bold"><td style="border:1px solid #000; padding:8px;">${s.name}</td><td style="border:1px solid #000; padding:8px;">${s.classGrade}</td><td style="border:1px solid #000; padding:8px; text-align:right;">₹${((s.totalFee+s.oldDue)-s.paid).toLocaleString()}</td></tr>`).join('');
                document.getElementById('printable-area').innerHTML = `<div style="padding:20px; color:#000;"><center><h1>Master Ledger</h1></center><table style="width:100%; border-collapse:collapse; border:1px solid #000;"><thead><tr style="background:#eee;"><th>Name</th><th>Class</th><th>Balance</th></tr></thead><tbody>${rows}</tbody></table></div>`;
                setTimeout(() => window.print(), 300);
            },
            printLedger: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                document.getElementById('printable-area').innerHTML = `<div style="padding:40px; color:#000; border:1px solid #000;"><center><h1>Statement</h1><p>${s.name} - ${s.classGrade}</p></center><hr/><p>Total Balance: ₹${((s.totalFee+s.oldDue)-s.paid).toLocaleString()}</p></div>`;
                setTimeout(() => window.print(), 300);
            }
        };

        // STARTUP
        (async () => {
            await window.initCloud();
            router.navigate('home');
        })();
    </script>
</body>
</html>
