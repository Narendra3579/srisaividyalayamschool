<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sri Sai Vidyalayam - Admin Portal</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    
    <style>
        body { font-family: 'Open Sans', sans-serif; overflow-x: hidden; width: 100%; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }
        
        .modal { transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); }
        
        .view-section { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #printable-area { display: none; }
        @media print {
            body * { visibility: hidden !important; }
            #printable-area, #printable-area * { visibility: visible !important; }
            #printable-area { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; background: white !important; color: black !important; padding: 20px !important; }
        }

        .bus-drive { animation: driveAcross 15s linear infinite; transform-box: fill-box; }
        @keyframes driveAcross { from { transform: translateX(850px); } to { transform: translateX(-450px); } }
        
        .sun-rotate { animation: sunSpin 20s linear infinite; }
        @keyframes sunSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #hero-text-slider .slide { display: none; }
        #hero-text-slider .slide.active { display: block; animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1); }

        .sort-header { cursor: pointer; user-select: none; }
        .sort-header:hover { background-color: #f1f5f9; }

        #toast-container {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none;
        }
        .toast {
            background: #1e1b4b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            min-width: 250px;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .shake-element { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 w-full min-h-screen font-bold text-indigo-950">

    <div id="toast-container"></div>

    <!-- NAVBAR -->
    <nav class="bg-indigo-950 text-white shadow-xl sticky top-0 z-40 no-print border-b border-indigo-800 w-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 font-black">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center space-x-3 cursor-pointer group" onclick="router.navigate('home')">
                    <div class="bg-white text-indigo-950 h-10 w-10 rounded-xl flex items-center justify-center font-black text-lg border-2 border-amber-400 group-hover:rotate-6 transition duration-300">SSV</div>
                    <div>
                        <h1 class="text-lg md:text-xl font-black uppercase tracking-tight text-white font-bold">Sri Sai Vidyalayam</h1>
                        <p class="text-[9px] text-amber-400 uppercase font-black tracking-widest text-indigo-100/60 font-black">Excellence in Education</p>
                    </div>
                </div>
                
                <div class="hidden md:flex space-x-8 items-center font-black">
                    <button class="hover:text-amber-400 font-black uppercase text-xs transition-colors" onclick="router.navigate('home')">Home</button>
                    <button class="relative hover:text-amber-400 font-black uppercase text-xs transition-colors" onclick="router.navigate('updates')">School Board</button>
                    <button class="hover:text-amber-400 font-black uppercase text-xs transition-colors" onclick="home.scrollToContact()">Contact Us</button>
                    <button class="bg-amber-500 hover:bg-amber-400 text-indigo-950 px-5 py-2.5 rounded-xl transition-all duration-300 hover-lift flex items-center gap-2 text-xs font-black uppercase shadow-lg shadow-amber-500/20 font-black" onclick="router.navigate('login')">
                        <span class="material-symbols-outlined text-lg font-black font-black">admin_panel_settings</span> Admin
                    </button>
                </div>
                
                <button class="md:hidden p-2 text-white hover:bg-indigo-900 rounded-lg transition" onclick="toggleMobileMenu()">
                    <span class="material-symbols-outlined font-black">menu</span>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-indigo-900 border-t border-indigo-800 p-4 space-y-3 font-black text-indigo-50">
            <button class="block w-full text-left py-2 font-black hover:text-amber-400" onclick="router.navigate('home'); toggleMobileMenu()">Home</button>
            <button class="block w-full text-left py-2 font-black hover:text-amber-400 relative" onclick="router.navigate('updates'); toggleMobileMenu()">School Board</button>
            <button class="block w-full text-left py-2 font-black hover:text-amber-400" onclick="home.scrollToContact(); toggleMobileMenu()">Contact Us</button>
            <button class="block w-full bg-amber-500 text-indigo-950 p-3 rounded-xl font-black uppercase text-xs text-center font-black" onclick="router.navigate('login'); toggleMobileMenu()">Admin Login</button>
        </div>
    </nav>

    <div id="app" class="w-full">
        <!-- VIEW: HOME -->
        <div id="view-home" class="hidden view-section">
            <section class="py-12 md:py-24 bg-white overflow-hidden relative font-black text-indigo-950">
                <div class="absolute top-10 right-10 lg:right-20 text-amber-400 opacity-60 sun-rotate font-black">
                    <span class="material-symbols-outlined text-9xl lg:text-[10rem] font-black">wb_sunny</span>
                </div>
                <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center relative z-10">
                    <div class="space-y-8 font-black">
                        <span class="inline-block px-4 py-1.5 bg-indigo-100 text-indigo-700 rounded-full text-[10px] font-black uppercase tracking-widest animate-pulse font-black">Recognised by Govt of AP</span>
                        <div id="hero-text-slider" class="min-h-[160px]">
                            <div class="slide active">
                                <h2 class="text-4xl md:text-6xl font-black text-indigo-950 leading-tight tracking-tighter uppercase font-black">Pollution Free <br><span class="text-green-600 underline font-black">Green Campus</span></h2>
                                <p class="text-slate-600 mt-4 text-lg font-bold font-black">Empowering the next generation with values and quality education.</p>
                            </div>
                            <div class="slide">
                                <h2 class="text-4xl md:text-6xl font-black text-indigo-950 leading-tight tracking-tighter uppercase font-black">Expert & <br><span class="text-orange-600 underline font-black">Dedicated Faculty</span></h2>
                                <p class="text-slate-600 mt-4 text-lg font-bold font-black">Qualified experts providing personalized attention to every child.</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="router.navigate('updates')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-5 rounded-2xl font-black shadow-xl uppercase tracking-widest text-xs font-black">View Updates</button>
                            <a href="tel:8121218825" class="bg-amber-500 hover:bg-amber-400 text-indigo-950 px-10 py-5 rounded-2xl font-bold shadow-xl flex items-center gap-2 text-indigo-950 font-black">
                                <span class="material-symbols-outlined text-sm font-black font-black">call</span> Call Office
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <section class="py-20 bg-indigo-50">
                <div class="max-w-7xl mx-auto px-6 text-indigo-950 font-black">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-8 mb-12">
                        <h2 class="text-3xl font-black uppercase tracking-tighter font-black">School Announcements</h2>
                        <select id="home-class-filter" class="bg-white border-2 border-indigo-200 rounded-2xl px-6 py-3 font-black text-indigo-950 outline-none shadow-xl focus:border-indigo-600 transition-all cursor-pointer w-full md:min-w-[240px] font-black" onchange="home.handleClassChange(this.value)">
                            <option value="All">All Grades</option>
                        </select>
                    </div>
                    <div id="home-notices-preview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-indigo-950 font-black"></div>
                </div>
            </section>

            <section id="school-details-section" class="py-24 bg-indigo-950 text-white font-black overflow-hidden relative font-black">
                <div class="absolute inset-0 opacity-5 pointer-events-none">
                    <div class="absolute top-0 left-0 w-full h-full" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 40px 40px;"></div>
                </div>
                <div class="max-w-7xl mx-auto px-6 relative z-10 font-black">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-20 items-center font-black">
                        <div class="space-y-10 font-black text-indigo-100">
                            <h2 class="text-4xl md:text-5xl font-black uppercase tracking-tighter text-white font-black">Contact Credentials</h2>
                            <p class="text-indigo-200 mt-6 text-lg font-black font-black">Sri Sai Vidyalayam, Visakhapatnam. Established for providing quality primary and secondary education.</p>
                        </div>
                        <div class="bg-indigo-900/50 p-8 md:p-12 rounded-[3rem] border border-indigo-800 shadow-2xl space-y-8 text-indigo-100 font-bold font-black">
                            <div class="space-y-6 font-black text-indigo-50">
                                <div class="flex items-center gap-6 font-black">
                                    <span class="material-symbols-outlined text-4xl text-amber-400 font-black font-black">mail</span>
                                    <div><p class="text-[10px] text-indigo-400 uppercase font-black font-black">Official Email</p><p class="text-sm font-black mt-1 font-black">shriisaividyallayem@gmail.com</p></div>
                                </div>
                                <div class="flex items-center gap-6 font-black font-black">
                                    <span class="material-symbols-outlined text-4xl text-amber-400 font-black font-black">call</span>
                                    <div><p class="text-[10px] text-indigo-400 uppercase font-black font-black">Office Hotline</p><p class="text-sm font-black mt-1 font-black">+91 8121218825</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW: DAILY UPDATES -->
        <div id="view-updates" class="hidden view-section py-16 bg-slate-50 font-black text-indigo-950 min-h-screen">
            <div class="w-full px-6">
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12 font-bold text-indigo-950 font-black">
                    <h2 class="text-3xl font-black uppercase tracking-tighter font-black">School Board</h2>
                    <select id="board-class-filter" class="bg-white border-2 border-indigo-100 rounded-2xl px-8 py-4 font-black text-indigo-950 outline-none shadow-xl focus:border-indigo-600 cursor-pointer min-w-[240px] text-center font-black" onchange="home.handleClassChange(this.value)"></select>
                </div>
                <div id="board-updates-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-indigo-950 font-black"></div>
            </div>
        </div>

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="hidden view-section min-h-screen bg-indigo-50 flex items-center justify-center p-6 font-black">
            <div id="login-card" class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl font-black text-indigo-950">
                <div class="text-center mb-8 font-black">
                    <div class="bg-indigo-950 text-white w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 text-3xl font-black border-4 border-amber-400 shadow-xl font-black">SSV</div>
                    <h2 class="text-2xl font-black uppercase tracking-tight font-black">Admin Login</h2>
                </div>
                <form onsubmit="auth_manager.login(event)" class="space-y-6">
                    <div><label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest font-black">Username</label><input type="text" id="userid" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-indigo-600 transition-all font-black text-indigo-950" required></div>
                    <div><label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest font-black">Passkey</label><input type="password" id="password" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-indigo-600 transition-all font-black text-indigo-950 font-black" required></div>
                    <button type="submit" class="w-full bg-indigo-950 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-transform font-black">Log In</button>
                </form>
            </div>
        </div>

        <!-- VIEW: ADMIN PANEL -->
        <div id="view-admin" class="hidden view-section min-h-screen bg-slate-100 flex flex-col md:flex-row font-black">
            <aside class="bg-indigo-950 text-white w-full md:w-72 flex-shrink-0 md:h-screen md:sticky top-0 flex flex-col shadow-2xl text-indigo-100 font-black">
                <div class="p-8 border-b border-indigo-900 font-black text-xl flex items-center gap-3 tracking-tight uppercase font-black font-black"><span class="material-symbols-outlined font-black text-amber-400 font-black">dashboard</span> Portal Hub</div>
                <div class="p-6 border-b border-indigo-900 bg-indigo-900/30 font-black font-black">
                    <label class="text-[9px] text-indigo-300 uppercase block mb-3 font-black tracking-widest font-black font-black">Academic Session</label>
                    <select id="admin-year-selector" onchange="admin.handleYearChange(this.value)" class="w-full bg-indigo-950 text-amber-400 border border-indigo-700 rounded-xl p-3 text-[10px] font-black uppercase outline-none cursor-pointer font-black">
                        <option value="2023-2024">Year: 2023-24</option>
                        <option value="2024-2025" selected>Year: 2024-25</option>
                        <option value="2025-2026">Year: 2025-26</option>
                        <option value="2026-2027">Year: 2026-27</option>
                    </select>
                </div>
                <nav class="flex-1 p-6 space-y-2 overflow-y-auto text-sm font-black text-indigo-100 font-black">
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all font-black" onclick="admin.switchTab('dashboard')"><span class="material-symbols-outlined font-black">analytics</span> Dashboard</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all font-black font-black" onclick="admin.switchTab('admissions')"><span class="material-symbols-outlined font-black font-black font-black">person_add</span> Admissions</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all font-black font-black" onclick="admin.switchTab('students')"><span class="material-symbols-outlined font-black font-black font-black">groups</span> Database</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all font-black font-black" onclick="admin.switchTab('data_management')"><span class="material-symbols-outlined font-black font-black font-black">database</span> Data Tools</button>
                </nav>
                <div class="p-6 border-t border-indigo-900">
                    <button onclick="auth_manager.logout()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-red-700 transition-all uppercase text-xs tracking-widest font-black font-black">Exit</button>
                </div>
            </aside>

            <main class="flex-1 p-6 md:p-12 overflow-x-hidden text-indigo-950 font-black font-black">
                <!-- TAB: DASHBOARD -->
                <div id="tab-dashboard" class="admin-content hidden space-y-10 font-black">
                    <h2 class="text-3xl font-black uppercase tracking-tighter font-black text-indigo-950">Overview</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-6 font-black text-indigo-950">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-indigo-600 font-black font-black font-black font-black"><p class="text-[10px] text-slate-400 uppercase tracking-widest font-black font-black">Revenue Target</p><div class="text-2xl mt-2 font-black" id="stat-total">₹0</div></div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-green-500 font-black font-black font-black font-black font-black"><p class="text-[10px] text-slate-400 uppercase tracking-widest font-black font-black">Collected</p><div class="text-2xl mt-2 text-green-600 font-black" id="stat-collected">₹0</div></div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-red-500 font-black font-black font-black font-black font-black"><p class="text-[10px] text-slate-400 uppercase tracking-widest font-black font-black">Pending</p><div class="text-2xl mt-2 text-red-600 font-black" id="stat-pending">₹0</div></div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-amber-400 font-black font-black font-black font-black font-black font-black"><p class="text-[10px] text-slate-400 uppercase tracking-widest font-black font-black">Count</p><div class="text-2xl mt-2 text-amber-600 font-black" id="stat-count">0</div></div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-sm h-96 font-black font-black"><canvas id="feeChart"></canvas></div>
                </div>

                <!-- TAB: ADMISSIONS -->
                <div id="tab-admissions" class="admin-content hidden font-black text-indigo-950 font-black">
                    <h2 class="text-3xl font-black mb-10 uppercase tracking-tighter text-indigo-950 font-black" id="admission-title">New Admission</h2>
                    <form id="admissions-form" onsubmit="admin.registerStudent(event)" class="bg-white p-10 rounded-[3rem] shadow-sm grid grid-cols-1 md:grid-cols-2 gap-8 text-sm font-black text-indigo-950">
                        <input type="hidden" name="editId">
                        <div class="space-y-1 font-black">
                            <label class="text-slate-400 uppercase text-[10px] font-black tracking-widest flex justify-between font-black">Admission ID * <button type="button" onclick="admin.suggestNextAdmnNo()" class="text-indigo-600 hover:underline">Auto-Gen</button></label>
                            <input type="text" name="admnNo" id="admn-no-input" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none focus:bg-white font-black text-indigo-950" required>
                        </div>
                        <div class="space-y-1 font-black"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest font-black">Student Name *</label><input type="text" name="name" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none focus:bg-white font-black text-indigo-950" required></div>
                        <div class="space-y-1 font-black font-black"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest font-black">Class *</label><select id="admit-class-select" name="class" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none font-black text-indigo-950" required></select></div>
                        <div class="space-y-1 font-black"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest font-black">Father Name</label><input type="text" name="father" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none focus:bg-white font-black text-indigo-950 font-black"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1 font-black"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest font-black font-black">Total Fee *</label><input type="number" name="fee" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none font-black text-indigo-950 font-black" required></div>
                            <div class="space-y-1 font-black"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest font-black font-black">Old Fee *</label><input type="number" name="oldDue" value="0" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none font-black text-indigo-950 font-black" required></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 font-black">
                            <div class="space-y-1 font-black"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest font-black">Initial Pay *</label><input type="number" name="initialPay" value="0" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none text-green-600 font-black text-indigo-950 font-black" required></div>
                            <div class="space-y-1 font-black"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest font-black">Pay Mode *</label>
                                <select name="initialPayType" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none font-black text-indigo-950" required>
                                    <option value="Cash">Cash</option><option value="UPI">UPI</option><option value="Bank">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-span-full flex gap-4 text-indigo-950 font-black">
                            <button type="button" id="admit-cancel-btn" class="hidden flex-1 bg-slate-200 text-indigo-950 py-5 rounded-3xl font-black uppercase text-xs" onclick="admin.cancelAdmitEdit()">Cancel</button>
                            <button type="submit" id="admit-submit-btn" class="flex-[2] bg-indigo-600 text-white py-5 rounded-3xl font-black uppercase text-xs shadow-xl transition-all font-black">Register Student</button>
                        </div>
                    </form>
                </div>

                <!-- TAB: DATABASE -->
                <div id="tab-students" class="admin-content hidden space-y-8 font-black text-indigo-950 font-black">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <h2 class="text-3xl font-black uppercase tracking-tighter font-black">Student Database</h2>
                        <button onclick="printer.printMasterLedger()" class="bg-indigo-950 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-md flex items-center gap-2 text-indigo-100 font-black"><span class="material-symbols-outlined text-lg font-black font-black">print</span> Master Ledger</button>
                    </div>
                    <div class="bg-white rounded-[2rem] shadow-sm border overflow-hidden font-black">
                        <table class="w-full text-left text-sm font-black font-black">
                            <thead class="bg-indigo-50 border-b font-black font-black">
                                <tr class="font-black uppercase text-[10px] text-indigo-950">
                                    <th class="p-6">ID</th><th class="p-6">Name</th><th class="p-6">Class</th><th class="p-6 text-right">Due</th><th class="p-6 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y text-slate-700 font-black font-black font-black"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: DATA TOOLS -->
                <div id="tab-data_management" class="admin-content hidden space-y-10 font-black text-indigo-950">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 font-black font-black">
                        <div class="bg-white p-10 rounded-[3rem] shadow-sm border text-center font-black">
                            <h3 class="text-xl font-black uppercase font-black font-black">Excel Operations</h3>
                            <div class="mt-8 flex flex-col gap-4 font-black">
                                <div class="flex gap-4 font-black">
                                    <button onclick="admin.exportExcel()" class="flex-1 bg-emerald-50 text-emerald-700 p-5 rounded-3xl uppercase text-[10px] font-black border border-emerald-100">Download Spreadsheet</button>
                                    <button onclick="document.getElementById('excel-import-input').click()" class="flex-1 bg-emerald-600 text-white p-5 rounded-3xl uppercase text-[10px] font-black shadow-lg">Upload Bulk Data</button>
                                    <input type="file" id="excel-import-input" class="hidden" accept=".xlsx,.csv" onchange="admin.importBulkData(event)">
                                </div>
                                <hr class="my-4 opacity-50"/>
                                <h4 class="text-xs text-slate-400 uppercase font-black">Backup System (JSON)</h4>
                                <div class="flex gap-4">
                                    <button onclick="admin.exportJSON()" class="flex-1 bg-slate-100 p-5 rounded-3xl uppercase text-[10px] font-black">JSON Backup</button>
                                    <button onclick="document.getElementById('import-json-input').click()" class="flex-1 bg-indigo-900 text-white p-5 rounded-3xl uppercase text-[10px] font-black shadow-lg">Restore JSON</button>
                                    <input type="file" id="import-json-input" class="hidden" accept=".json" onchange="admin.importJSON(event)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- PROFILE MODAL -->
        <div id="student-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-6xl h-[90vh] rounded-[2.5rem] overflow-hidden flex flex-col shadow-2xl text-indigo-950 font-black font-black font-black font-black">
                <div class="p-8 bg-indigo-950 text-white flex justify-between items-center font-black font-black font-black font-black font-black">
                    <h2 id="modal-name" class="text-2xl font-black uppercase tracking-tighter"></h2>
                    <button onclick="admin.closeModal()" class="text-4xl hover:text-amber-400 transition-colors font-black">&times;</button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 bg-slate-50 grid grid-cols-1 lg:grid-cols-3 gap-8 text-sm">
                    <div class="space-y-6 font-black">
                        <div class="p-6 bg-white rounded-3xl shadow-sm border text-indigo-950 font-black font-black font-black font-black">
                            <p><strong>Class:</strong> <span id="modal-class" class="text-indigo-600 font-black font-black"></span></p>
                            <p class="text-2xl text-red-600 font-black mt-4 uppercase">Balance: <span id="modal-balance"></span></p>
                        </div>
                        <div class="flex flex-col gap-2 font-black font-black font-black">
                             <button onclick="printer.printReceipt()" class="w-full bg-indigo-900 text-white py-4 rounded-xl font-black shadow-lg">Print Formal Receipt</button>
                             <button onclick="admin.initiateEditFromModal()" class="w-full bg-indigo-100 text-indigo-950 py-4 rounded-xl font-black">Edit Student</button>
                             <button onclick="admin.requestDeleteFromModal()" class="w-full bg-red-50 text-red-600 py-4 rounded-xl font-black">Delete Account</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-8 font-black">
                        <form onsubmit="admin.recordPayment(event)" class="bg-white p-10 rounded-[2rem] shadow-sm grid grid-cols-2 gap-6 border-2 border-emerald-50 font-black">
                            <div class="col-span-2 text-[10px] uppercase text-slate-400 font-black font-black font-black">New Transaction</div>
                            <input type="number" id="pay-amt" placeholder="Amount (₹)" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 font-black text-2xl focus:bg-white outline-none" required>
                            <select id="pay-type" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 font-black focus:bg-white outline-none text-indigo-950">
                                <option value="Cash">Cash</option><option value="UPI">UPI</option><option value="Bank">Bank Transfer</option>
                            </select>
                            <input type="date" id="pay-date" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 focus:bg-white outline-none font-black text-indigo-950" required>
                            <input type="text" id="pay-remark" placeholder="Note (Receipt #)" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 focus:bg-white outline-none font-black text-indigo-950 font-black font-black">
                            <button type="submit" class="col-span-2 bg-green-600 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-green-700 transition-all shadow-lg text-indigo-100 font-black font-black font-black">Confirm Payment</button>
                        </form>
                        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 font-black font-black">
                            <table class="w-full text-left text-sm font-black"><tbody id="modal-history" class="divide-y text-slate-700 font-black"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONFIRM MODAL -->
        <div id="confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-80 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-sm p-10 rounded-[3rem] shadow-2xl text-center text-indigo-950 font-black font-black font-black font-black font-black font-black">
                <h3 id="confirm-title" class="text-xl font-black mb-4 uppercase font-black font-black">Are you sure?</h3>
                <p id="confirm-msg" class="text-xs text-slate-500 mb-8 font-black font-black font-black font-black">Action is irreversible.</p>
                <div class="flex gap-4 font-black">
                    <button id="confirm-cancel-btn" class="flex-1 py-4 bg-slate-100 rounded-2xl font-black text-indigo-950 uppercase font-black font-black font-black font-black">Cancel</button>
                    <button id="confirm-exec-btn" class="flex-1 py-4 bg-indigo-900 text-white rounded-2xl font-black uppercase shadow-lg font-black font-black font-black font-black">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINTING -->
    <div id="printable-area"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Firebase Setup
        const firebaseConfig = {
            apiKey: "AIzaSyCTBCeLms5kGsf966PB25I4H75i8BBxma0",
            authDomain: "sri-sai-vidyalayam-9a21e.firebaseapp.com",
            projectId: "sri-sai-vidyalayam-9a21e",
            storageBucket: "sri-sai-vidyalayam-9a21e.firebasestorage.app",
            messagingSenderId: "167964825322",
            appId: "1:167964825322:web:7d22c335f98dc468fda993",
            measurementId: "G-H28D1GK0HS"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sri-sai-v-portal';

        let unsubscribes = []; // Global scope fix

        window.state = {
            user: null, students: [], notices: [], 
            classes: ["Nursery", "LKG", "UKG", "1st Class", "2nd Class", "3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
            activeStudentId: null, selectedClass: 'All', selectedYear: '2024-2025'
        };

        // UI Helpers (Declared before module objects)
        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            if(!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'bg-red-600' : 'bg-indigo-950'}`;
            toast.innerHTML = `<span class="material-symbols-outlined">${type === 'error' ? 'error' : 'info'}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        window.askConfirm = (title, msg, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            if(!modal) return;
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            modal.classList.remove('hidden-modal');
            document.getElementById('confirm-cancel-btn').onclick = () => modal.classList.add('hidden-modal');
            document.getElementById('confirm-exec-btn').onclick = () => { onConfirm(); modal.classList.add('hidden-modal'); };
        };

        // Modules
        window.home = {
            init: () => {
                home.renderHomeNotices();
                home.startHeroSlider();
                const filter = document.getElementById('home-class-filter');
                if (filter) {
                    filter.innerHTML = '<option value="All">All Grades</option>' + state.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                    filter.value = state.selectedClass;
                }
            },
            handleClassChange: (val) => { state.selectedClass = val; home.renderHomeNotices(); home.renderUpdates(); },
            scrollToContact: () => document.getElementById('school-details-section')?.scrollIntoView({ behavior: 'smooth' }),
            renderHomeNotices: () => {
                const container = document.getElementById('home-notices-preview');
                if (!container) return;
                const filtered = state.notices.filter(n => state.selectedClass === 'All' || n.class === state.selectedClass).slice(0, 6);
                container.innerHTML = filtered.map(n => `<div class="bg-white p-6 rounded-3xl shadow-sm border-l-4 border-indigo-600 font-black"><h4>${n.class}</h4><p class="mt-2 text-slate-700 font-black">${n.content}</p></div>`).join('') || '<p class="col-span-full italic opacity-30 text-center font-black">No updates.</p>';
            },
            renderUpdates: () => {
                const list = document.getElementById('board-updates-list');
                if(!list) return;
                const filtered = state.notices.filter(n => state.selectedClass === 'All' || n.class === state.selectedClass);
                list.innerHTML = filtered.map(n => `<div class="bg-white p-8 rounded-3xl border-l-8 border-indigo-600 font-black font-black"><h4>${n.class}</h4><p>${n.content}</p></div>`).join('');
            },
            startHeroSlider: () => {
                let current = 0; const slides = document.querySelectorAll('#hero-text-slider .slide');
                if(window.heroInterval) clearInterval(window.heroInterval);
                if(slides.length > 1) {
                    window.heroInterval = setInterval(() => {
                        slides[current].classList.remove('active');
                        current = (current + 1) % slides.length;
                        slides[current].classList.add('active');
                    }, 4000);
                }
            }
        };

        window.admin = {
            init: () => {
                const selects = document.querySelectorAll('#admit-class-select, #record-class-filter');
                selects.forEach(s => {
                    const isFilter = s.id.includes('filter');
                    s.innerHTML = (isFilter ? '<option value="All">All Grades</option>' : '') + state.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                });
                admin.switchTab('dashboard');
            },
            handleYearChange: (val) => { state.selectedYear = val; startSync(); },
            switchTab: (tabId) => {
                document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.toggle('bg-indigo-900', btn.onclick.toString().includes(tabId)));
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`tab-${tabId}`);
                if (target) target.classList.remove('hidden');
                if (tabId === 'students') admin.renderStudentList();
                if (tabId === 'dashboard') admin.updateDashboard();
                if (tabId === 'admissions' && !document.querySelector('[name="editId"]').value) admin.suggestNextAdmnNo();
            },
            suggestNextAdmnNo: () => {
                const ids = state.students.map(s => parseInt((s.admnNo || s.ID || '0').toString().replace(/\D/g,'')) || 0).filter(id => id > 0);
                const input = document.getElementById('admn-no-input');
                if (input) input.value = ids.length > 0 ? Math.max(...ids) + 1 : 1001;
            },
            registerStudent: async (e) => {
                e.preventDefault(); if (!state.user) return;
                const fd = new FormData(e.target);
                const editId = fd.get('editId');
                const admnNo = fd.get('admnNo');
                const name = fd.get('name');
                const fee = parseFloat(fd.get('fee'));
                const oldDue = parseFloat(fd.get('oldDue'));
                const initialPay = parseFloat(fd.get('initialPay'));
                const payType = fd.get('initialPayType');

                if(!admnNo || !name || isNaN(fee)) return showToast("All * fields are mandatory", "error");
                
                const duplicate = state.students.find(s => String(s.admnNo || s.ID) === String(admnNo) && s.id !== editId);
                if(duplicate) return showToast(`Admission ID ${admnNo} in use`, "error");

                const yearKey = state.selectedYear.replace('-', '_');
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`);
                const data = { admnNo, name, class: fd.get('class'), father: fd.get('father') || '', fee, oldDue, paid: initialPay, timestamp: Date.now() };

                try {
                    if (editId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`, editId), data);
                        showToast("Updated Successfully");
                    } else {
                        data.history = [{ amount: initialPay, type: payType, timestamp: Date.now(), remark: "Initial Payment" }];
                        await addDoc(colRef, data);
                        showToast("Admission Complete", "success");
                    }
                    admin.switchTab('students');
                    e.target.reset();
                    admin.cancelAdmitEdit();
                } catch(e) { showToast("Save Error", "error"); }
            },
            renderStudentList: () => {
                const body = document.getElementById('student-list-body');
                if (!body) return;
                body.innerHTML = state.students.map(s => {
                    const sDue = (parseFloat(s.fee || s.Target_Fee || 0) + parseFloat(s.oldDue || s.Previous_Dues || 0)) - parseFloat(s.paid || s.Total_Paid || 0);
                    return `<tr class="border-b hover:bg-slate-50 cursor-pointer font-black font-black font-black" onclick="admin.openModal('${s.id}')">
                        <td class="p-6 font-mono text-xs font-black font-black">${s.admnNo || s.ID}</td>
                        <td class="p-6 uppercase font-black font-black">${s.name || s.Student}</td>
                        <td class="p-6 font-black font-black">${s.class || s.Grade || 'Nursery'}</td>
                        <td class="p-6 text-right text-red-600 font-black font-black">₹${sDue.toLocaleString()}</td>
                        <td class="p-6 text-center text-indigo-900 font-black font-black">DETAILS</td>
                    </tr>`;
                }).join('') || '<tr><td colspan="5" class="p-10 text-center italic font-black font-black">Registry is empty.</td></tr>';
            },
            recordPayment: async (e) => {
                e.preventDefault(); if (!state.user) return;
                const amt = parseFloat(document.getElementById('pay-amt').value);
                const type = document.getElementById('pay-type').value;
                const date = document.getElementById('pay-date').value;
                const remark = document.getElementById('pay-remark').value;
                const s = state.students.find(x => x.id === state.activeStudentId);
                
                const newPaid = (parseFloat(s.paid || 0) + amt);
                const newHistory = [...(s.history || []), { amount: amt, type, timestamp: new Date(date).getTime(), remark }];
                
                const yearKey = state.selectedYear.replace('-', '_');
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`, s.id), { paid: newPaid, history: newHistory });
                    showToast("Payment Registered", "success");
                    document.getElementById('pay-amt').value = "";
                } catch(e) { showToast("Save error", "error"); }
            },
            renderHistory: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                const body = document.getElementById('modal-history');
                if(!body || !s) return;
                body.innerHTML = (s.history || []).map(h => `
                    <tr class="border-b">
                        <td class="p-4 text-slate-400 text-xs">${new Date(h.timestamp).toLocaleDateString()}</td>
                        <td class="p-4 font-black">${h.remark || 'Fee Payment'}</td>
                        <td class="p-4 text-indigo-600 text-xs">${h.type || 'Cash'}</td>
                        <td class="p-4 text-right font-black font-black font-black">₹${parseFloat(h.amount).toLocaleString()}</td>
                    </tr>
                `).reverse().join('') || '<tr><td colspan="4" class="p-6 text-center italic opacity-30 font-black font-black">No transactions found.</td></tr>';
            },
            updateDashboard: () => {
                let total = 0, collected = 0;
                state.students.forEach(s => {
                    total += (parseFloat(s.fee || s.Target_Fee || 0) + parseFloat(s.oldDue || s.Previous_Dues || 0));
                    collected += parseFloat(s.paid || s.Total_Paid || 0);
                });
                if(document.getElementById('stat-total')) document.getElementById('stat-total').innerText = `₹${total.toLocaleString()}`;
                if(document.getElementById('stat-collected')) document.getElementById('stat-collected').innerText = `₹${collected.toLocaleString()}`;
                if(document.getElementById('stat-pending')) document.getElementById('stat-pending').innerText = `₹${(total - collected).toLocaleString()}`;
                if(document.getElementById('stat-count')) document.getElementById('stat-count').innerText = state.students.length;
            },
            openModal: (id) => {
                state.activeStudentId = id;
                const s = state.students.find(x => x.id === id);
                document.getElementById('modal-name').innerText = s.name || s.Student;
                document.getElementById('modal-class').innerText = s.class || s.Grade || 'Nursery';
                const sDue = (parseFloat(s.fee || 0) + parseFloat(s.oldDue || 0)) - parseFloat(s.paid || 0);
                document.getElementById('modal-balance').innerText = `₹${sDue.toLocaleString()}`;
                admin.renderHistory();
                document.getElementById('student-modal').classList.remove('hidden-modal');
            },
            closeModal: () => { document.getElementById('student-modal').classList.add('hidden-modal'); state.activeStudentId = null; },
            initiateEditFromModal: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                admin.closeModal(); admin.switchTab('admissions');
                const form = document.getElementById('admissions-form');
                form.editId.value = s.id; form.admnNo.value = s.admnNo || s.ID; form.name.value = s.name || s.Student;
                form.class.value = s.class || s.Grade; form.fee.value = s.fee || 0; form.oldDue.value = s.oldDue || 0;
                document.getElementById('admission-title').innerText = "Update Details";
                document.getElementById('admit-cancel-btn').classList.remove('hidden');
                document.getElementById('admit-initial-group').style.display = 'none';
            },
            cancelAdmitEdit: () => {
                const form = document.getElementById('admissions-form');
                form.reset(); form.editId.value = "";
                document.getElementById('admission-title').innerText = "New Admission";
                document.getElementById('admit-cancel-btn').classList.add('hidden');
                document.getElementById('admit-initial-group').style.display = 'block';
                admin.suggestNextAdmnNo();
            },
            requestDeleteFromModal: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                askConfirm("Delete Record?", `Permanently remove ${s.name}?`, async () => {
                    const yearKey = state.selectedYear.replace('-', '_');
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`, s.id));
                    showToast("Record Deleted"); admin.closeModal();
                });
            },
            exportExcel: () => {
                const data = state.students.map(s => ({
                    ID: s.admnNo || s.ID,
                    Student: s.name || s.Student,
                    Grade: s.class || s.Grade,
                    Fee: s.fee || 0,
                    Old_Fee: s.oldDue || 0,
                    Paid: s.paid || 0,
                    Due: (parseFloat(s.fee || 0) + parseFloat(s.oldDue || 0)) - parseFloat(s.paid || 0)
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Registry");
                XLSX.writeFile(wb, `SSV_Registry_${state.selectedYear}.xlsx`);
            },
            importBulkData: (event) => {
                const file = event.target.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    const yearKey = state.selectedYear.replace('-', '_');
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`);
                    
                    json.forEach(async row => {
                        const d = {
                            admnNo: String(row.ID || row.Admission_No || row.admnNo || ''),
                            name: String(row.Student || row.Name || row.name || ''),
                            class: String(row.Grade || row.Class || row.class || 'Nursery'),
                            fee: parseFloat(row.Fee || row.Total_Fee || row.fee || 0),
                            oldDue: parseFloat(row.Old_Fee || row.Previous_Dues || row.oldDue || 0),
                            paid: parseFloat(row.Paid || row.Total_Paid || row.paid || 0),
                            timestamp: Date.now()
                        };
                        if(d.name && d.admnNo) await addDoc(colRef, d);
                    });
                    showToast("Excel Import Started...");
                };
                reader.readAsArrayBuffer(file);
            },
            exportJSON: () => {
                const blob = new Blob([JSON.stringify(state.students, null, 2)], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${state.selectedYear}.json`; a.click();
            },
            importJSON: (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const students = JSON.parse(evt.target.result);
                        const yearKey = state.selectedYear.replace('-', '_');
                        for (const s of students) { delete s.id; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`), s); }
                        showToast("Restore Successful", "success");
                    } catch(err) { showToast("Invalid JSON", "error"); }
                };
                reader.readAsText(file);
            },
            bulkTransferStudents: async () => {
                if(state.students.length === 0) return showToast("No records to transfer", "error");
                const nextYear = state.selectedYear.split('-').map(y => parseInt(y) + 1).join('-');
                askConfirm("Promote Session?", `Move all students to session ${nextYear}?`, async () => {
                    const nextYearKey = nextYear.replace('-', '_');
                    const targetRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${nextYearKey}`);
                    for (const s of state.students) {
                        const currentIdx = state.classes.indexOf(s.class || s.Grade);
                        const nextClass = state.classes[currentIdx + 1] || "Passed Out";
                        const newData = { admnNo: s.admnNo || s.ID, name: s.name || s.Student, class: nextClass, fee: s.fee || 0, oldDue: 0, paid: 0, timestamp: Date.now() };
                        await addDoc(targetRef, newData);
                    }
                    showToast(`Successfully moved to ${nextYear}`, "success");
                });
            }
        };

        window.router = {
            navigate: (view) => {
                document.querySelectorAll('.view-section').forEach(el => { el.classList.add('hidden'); el.style.display = 'none'; });
                const target = document.querySelector(`#view-${view}`);
                if (target) {
                    target.classList.remove('hidden');
                    target.style.display = (view === 'login' || view === 'admin') ? 'flex' : 'block';
                }
                if (view === 'home' && window.home?.init) window.home.init();
                if (view === 'admin' && window.admin?.init) window.admin.init();
                window.scrollTo(0,0);
            }
        };

        window.auth_manager = {
            login: (e) => {
                e.preventDefault();
                if (document.getElementById('userid').value === 'admin' && document.getElementById('password').value === '123') {
                    state.isLoggedIn = true; router.navigate('admin');
                    showToast("Admin Session Started", "success");
                } else showToast("Tappu PIN", "error");
            },
            logout: () => { state.isLoggedIn = false; router.navigate('home'); }
        };

        window.printer = {
            printReceipt: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                const lastPay = (s.history && s.history.length > 0) ? s.history[s.history.length-1] : { amount: s.paid, type: 'Cash' };
                document.getElementById('printable-area').innerHTML = `
                    <div style="padding: 50px; border: 4px double #1e1b4b; background: white; color: #1e1b4b; font-family: sans-serif;">
                        <div style="text-align: center; border-bottom: 2px solid #1e1b4b; padding-bottom: 15px; margin-bottom: 30px;">
                            <h1 style="margin:0; font-size: 32px; text-transform: uppercase; font-weight: 900;">Sri Sai Vidyalayam</h1>
                            <p style="font-weight: bold;">Recognised by Govt of AP | Pendurthi, Visakhapatnam</p>
                            <p>Email: shriisaividyallayem@gmail.com</p>
                        </div>
                        <p><strong>Vidyarthi:</strong> ${s.name} | <strong>ID:</strong> ${s.admnNo || s.ID}</p>
                        <p><strong>Session:</strong> ${state.selectedYear}</p>
                        <p><strong>Payment Mode:</strong> ${lastPay.type || 'Direct'}</p>
                        <p><strong>Paid Amount:</strong> ₹${parseFloat(lastPay.amount || 0).toLocaleString()}</p>
                        <div style="margin-top: 80px; text-align: right;">
                            <div style="display:inline-block; border-top: 1px solid #1e1b4b; width: 220px; text-align: center; font-weight: 900; padding-top: 5px; text-transform: uppercase;">Principal Signature</div>
                        </div>
                    </div>
                `;
                window.print();
            },
            printMasterLedger: () => {
                document.getElementById('printable-area').innerHTML = `
                    <div style="padding: 40px; background: white; font-family: sans-serif; color: #1e1b4b;">
                        <h1 style="text-align:center;">Registry Summary - ${state.selectedYear}</h1>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: #1e1b4b; color: white;">
                                    <th style="padding: 10px; border: 1px solid #1e1b4b;">ID</th>
                                    <th style="padding: 10px; border: 1px solid #1e1b4b;">Name</th>
                                    <th style="padding: 10px; border: 1px solid #1e1b4b; text-align: right;">Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.students.map(s => `<tr><td style="border:1px solid #ddd; padding:8px;">${s.admnNo||s.ID}</td><td style="border:1px solid #ddd; padding:8px;">${s.name}</td><td style="border:1px solid #ddd; padding:8px; text-align: right;">₹${((parseFloat(s.fee||0)+parseFloat(s.oldDue||0))-parseFloat(s.paid||0)).toLocaleString()}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                window.print();
            }
        };

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth); 
            } catch (err) { await signInAnonymously(auth); }
        };

        const startSync = () => {
            if (!state.user) return;
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            const yearKey = state.selectedYear.replace('-', '_');
            const studentsRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`);
            const noticesRef = collection(db, 'artifacts', appId, 'public', 'data', `notices_${yearKey}`);

            unsubscribes.push(onSnapshot(studentsRef, (snap) => {
                state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (document.getElementById('view-admin').style.display !== 'none') admin.renderStudentList();
                if (state.activeStudentId) admin.renderHistory();
                admin.updateDashboard();
            }));
            unsubscribes.push(onSnapshot(noticesRef, (snap) => {
                state.notices = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp);
                home.renderHomeNotices();
                home.renderUpdates();
            }));
        };

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            if (u) startSync();
            if (!document.querySelector('.view-section:not(.hidden)')) router.navigate('home');
        });

        (async () => { await initAuth(); })();
    </script>
</body>
</html>
