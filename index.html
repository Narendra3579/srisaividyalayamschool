<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sri Sai Vidyalayam - Admin Portal</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    
    <style>
        body { font-family: 'Open Sans', sans-serif; overflow-x: hidden; width: 100%; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }
        
        /* Smooth Transitions */
        .modal { transition: opacity 0.3s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; }
        
        .view-section { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Media Queries & Containers */
        .video-container { 
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; 
            background: #0f172a; border-radius: 16px; cursor: pointer; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .video-container.vertical { padding-bottom: 177.77%; }
        .video-container iframe, .video-container video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            border: none !important; object-fit: cover;
        }

        /* Blog Slider Animations */
        .blog-slider-container { position: relative; width: 100%; overflow: hidden; }
        .blog-slider-track { display: flex; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .blog-slide { flex: 0 0 100%; padding: 0 10px; box-sizing: border-box; }

        /* Print Formatting */
        #printable-area { display: none; }
        @media print {
            body * { visibility: hidden !important; }
            #printable-area, #printable-area * { visibility: visible !important; }
            #printable-area { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; background: white !important; color: black !important; padding: 20px !important; }
        }

        /* Hero Animations */
        .bus-drive { animation: driveAcross 15s linear infinite; transform-box: fill-box; }
        @keyframes driveAcross { 
            from { transform: translateX(850px); } 
            to { transform: translateX(-450px); } 
        }
        
        .wheel-spin { animation: spin 2s linear infinite; transform-origin: center; transform-box: fill-box; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .cloud-drift { animation: cloudDrift 45s linear infinite; }
        @keyframes cloudDrift { from { transform: translateX(-150px); } to { transform: translateX(950px); } }

        .sun-rotate { animation: sunSpin 20s linear infinite; }
        @keyframes sunSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #hero-text-slider .slide { display: none; }
        #hero-text-slider .slide.active { display: block; animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* Splash Screen Layer */
        #cloud-loader {
            position: fixed; inset: 0; background: #f8fafc; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.4s ease;
        }

        /* Nav Badge Styling */
        .nav-badge {
            position: absolute; top: -5px; right: -10px; background: #ef4444; color: white;
            font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 9999px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} }
        
        .hover-lift { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hover-lift:hover { transform: translateY(-2px) scale(1.02); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 w-full min-h-screen">

    <!-- SPLASH SCREEN -->
    <div id="cloud-loader">
        <div class="mb-6 flex space-x-2">
            <div class="w-4 h-4 bg-indigo-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-4 h-4 bg-indigo-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-4 h-4 bg-indigo-600 rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
        </div>
        <p class="text-xs font-bold tracking-[0.3em] uppercase text-indigo-900 animate-pulse">Sri Sai Vidyalayam</p>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-indigo-950 text-white shadow-xl sticky top-0 z-40 no-print border-b border-indigo-800 w-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center space-x-3 cursor-pointer group" onclick="router.navigate('home')">
                    <div class="bg-white text-indigo-950 h-10 w-10 rounded-xl flex items-center justify-center font-bold text-lg border-2 border-amber-400 group-hover:rotate-6 transition duration-300">SSV</div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold uppercase tracking-tight">Sri Sai Vidyalayam</h1>
                        <p class="text-[9px] text-amber-400 uppercase font-black tracking-widest">Excellence in Education</p>
                    </div>
                </div>
                
                <div class="hidden md:flex space-x-6 items-center">
                    <button class="hover:text-amber-400 font-bold uppercase text-xs transition-colors" onclick="router.navigate('home')">Home</button>
                    <button class="relative hover:text-amber-400 font-bold uppercase text-xs transition-colors" onclick="router.navigate('updates')">
                        Daily Board
                        <span id="nav-updates-badge" class="nav-badge hidden">0</span>
                    </button>
                    <button class="bg-amber-500 hover:bg-amber-400 text-indigo-950 px-5 py-2.5 rounded-xl transition-all duration-300 hover-lift flex items-center gap-2 text-xs font-black uppercase shadow-lg shadow-amber-500/20" onclick="router.navigate('login')">
                        <span class="material-symbols-outlined text-lg">admin_panel_settings</span> Admin
                    </button>
                </div>
                
                <button class="md:hidden p-2 text-white hover:bg-indigo-900 rounded-lg transition" onclick="toggleMobileMenu()">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-indigo-900 border-t border-indigo-800 p-4 space-y-3">
            <button class="block w-full text-left py-2 font-bold hover:text-amber-400 transition" onclick="router.navigate('home'); toggleMobileMenu()">Home</button>
            <button class="block w-full text-left py-2 font-bold hover:text-amber-400 transition" onclick="router.navigate('updates'); toggleMobileMenu()">Daily Board</button>
            <button class="block w-full bg-amber-500 text-indigo-950 p-3 rounded-xl font-black uppercase text-xs text-center" onclick="router.navigate('login'); toggleMobileMenu()">Admin Login</button>
        </div>
    </nav>

    <div id="app" class="w-full">
        <!-- VIEW: HOME -->
        <div id="view-home" class="hidden view-section">
            <!-- Hero -->
            <section class="py-12 md:py-24 bg-white overflow-hidden relative">
                <!-- Decorative Elements -->
                <!-- Sun -->
                <div class="absolute top-10 right-10 lg:right-20 text-amber-400 opacity-60 pointer-events-none sun-rotate">
                    <span class="material-symbols-outlined text-9xl lg:text-[10rem]">wb_sunny</span>
                </div>

                <!-- Skyblue Clouds -->
                <div class="absolute top-10 left-1/4 text-sky-300 opacity-30 cloud-drift">
                    <span class="material-symbols-outlined text-7xl">cloud</span>
                </div>
                <div class="absolute top-32 right-1/3 text-sky-400 opacity-20 cloud-drift" style="animation-delay: -5s">
                    <span class="material-symbols-outlined text-9xl">cloud</span>
                </div>
                <div class="absolute top-64 left-10 text-sky-200 opacity-40 cloud-drift" style="animation-delay: -15s">
                    <span class="material-symbols-outlined text-6xl">cloud</span>
                </div>
                <div class="absolute top-20 right-10 text-sky-300 opacity-20 cloud-drift" style="animation-delay: -25s">
                    <span class="material-symbols-outlined text-8xl">cloud</span>
                </div>

                <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center relative z-10">
                    <div class="space-y-8">
                        <span class="inline-block px-4 py-1.5 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-widest animate-pulse">Recognised by Govt of AP</span>
                        <div id="hero-text-slider" class="min-h-[160px]">
                            <div class="slide active">
                                <h2 class="text-4xl md:text-6xl font-extrabold text-indigo-950 leading-tight">Pollution Free <br><span class="text-green-600 underline decoration-amber-400 underline-offset-8">Green Campus</span></h2>
                                <p class="text-slate-600 mt-4 text-lg">A serene environment located away from city noise, ensuring healthy learning for your child.</p>
                            </div>
                            <div class="slide">
                                <h2 class="text-4xl md:text-6xl font-extrabold text-indigo-950 leading-tight">Expert & <br><span class="text-orange-500 underline decoration-amber-400 underline-offset-8">Dedicated Faculty</span></h2>
                                <p class="text-slate-600 mt-4 text-lg">Qualified subject experts committed to personalized attention and academic excellence.</p>
                            </div>
                        </div>
                        <button onclick="router.navigate('updates')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-5 rounded-2xl font-bold shadow-xl transition-all hover-lift active:scale-95">Check School Board</button>
                    </div>
                    <div class="relative h-[300px] md:h-[400px]">
                        <svg viewBox="0 0 800 500" class="w-full h-full drop-shadow-2xl">
                            <!-- Road -->
                            <rect x="0" y="400" width="800" height="100" fill="#334155" />
                            <rect x="0" y="445" width="800" height="10" fill="#475569" />
                            <!-- Bus -->
                            <g class="bus-drive">
                                <rect x="0" y="320" width="180" height="90" rx="15" fill="#fbbf24" />
                                <rect x="0" y="380" width="180" height="5" fill="#1e293b" opacity="0.1" />
                                <rect x="20" y="335" width="35" height="25" rx="4" fill="#fff" opacity="0.9" />
                                <rect x="65" y="335" width="35" height="25" rx="4" fill="#fff" opacity="0.9" />
                                <rect x="110" y="335" width="50" height="25" rx="4" fill="#fff" opacity="0.9" />
                                <!-- Wheels -->
                                <g transform="translate(45, 410)">
                                    <circle r="15" fill="#1e293b" />
                                    <circle r="6" fill="#475569" class="wheel-spin" />
                                </g>
                                <g transform="translate(135, 410)">
                                    <circle r="15" fill="#1e293b" />
                                    <circle r="6" fill="#475569" class="wheel-spin" />
                                </g>
                                <text x="90" y="375" font-family="sans-serif" font-size="10" font-weight="900" text-anchor="middle" fill="#431407">SRI SAI VIDYALAYAM</text>
                            </g>
                        </svg>
                    </div>
                </div>
            </section>

            <!-- Highlights Carousel -->
            <section class="py-20 bg-slate-50">
                <div class="max-w-6xl mx-auto px-4 text-center">
                    <h2 class="text-3xl font-black text-indigo-950 uppercase mb-12 inline-block border-b-4 border-amber-400">Recent Highlights</h2>
                    <div class="flex items-center gap-4">
                        <button onclick="home.prevBlog()" class="p-4 bg-white rounded-full shadow-lg text-indigo-950 hover:bg-indigo-950 hover:text-white transition-all hover-lift">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <div class="blog-slider-container">
                            <div id="blog-posts-feed" class="blog-slider-track"></div>
                        </div>
                        <button onclick="home.nextBlog()" class="p-4 bg-white rounded-full shadow-lg text-indigo-950 hover:bg-indigo-950 hover:text-white transition-all hover-lift">
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- FOOTER: SCHOOL DETAILS -->
            <footer class="bg-indigo-950 text-indigo-100 pt-20 pb-12 w-full no-print border-t border-indigo-900/50">
                <div class="max-w-7xl mx-auto px-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 mb-16">
                        <!-- Branding -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-white text-indigo-950 h-10 w-10 rounded-xl flex items-center justify-center font-bold text-lg border-2 border-amber-400">SSV</div>
                                <h3 class="text-xl font-black uppercase text-white">Sri Sai Vidyalayam</h3>
                            </div>
                            <p class="text-sm opacity-70 leading-relaxed font-bold">Nurturing young minds in a pollution-free environment through holistic growth and academic excellence since inception.</p>
                        </div>
                        
                        <!-- Contact Info -->
                        <div class="space-y-6">
                            <h4 class="text-amber-400 uppercase tracking-widest text-[10px] font-black">Contact Details</h4>
                            <ul class="space-y-4 font-bold">
                                <li class="flex gap-3 items-start">
                                    <span class="material-symbols-outlined text-amber-500 text-lg">location_on</span>
                                    <span class="text-sm">Pulagalipalem, Pendurthi,<br>Visakhapatnam, AP - 531173</span>
                                </li>
                                <li class="flex gap-3 items-center">
                                    <span class="material-symbols-outlined text-amber-500 text-lg">call</span>
                                    <a href="tel:8121218825" class="text-sm hover:text-amber-400 transition-colors">8121218825</a>
                                </li>
                                <li class="flex gap-3 items-center">
                                    <span class="material-symbols-outlined text-amber-500 text-lg">mail</span>
                                    <a href="mailto:shriisaividyallayem@gmail.com" class="text-sm break-all hover:text-amber-400 transition-colors">shriisaividyallayem@gmail.com</a>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Quick Links -->
                        <div class="space-y-6">
                            <h4 class="text-amber-400 uppercase tracking-widest text-[10px] font-black">Quick Links</h4>
                            <ul class="space-y-3 font-bold text-sm">
                                <li><button onclick="router.navigate('home')" class="hover:text-amber-400 transition-colors">School Home</button></li>
                                <li><button onclick="router.navigate('updates')" class="hover:text-amber-400 transition-colors">Daily Notice Board</button></li>
                                <li><button onclick="router.navigate('login')" class="hover:text-amber-400 transition-colors">Admin Portal Access</button></li>
                            </ul>
                        </div>
                        
                        <!-- Operational Hours -->
                        <div class="space-y-6">
                            <h4 class="text-amber-400 uppercase tracking-widest text-[10px] font-black">Working Hours</h4>
                            <div class="bg-indigo-900/50 p-6 rounded-3xl border border-indigo-800 font-bold text-sm space-y-3">
                                <div class="flex justify-between border-b border-indigo-800 pb-2">
                                    <span class="opacity-70">Mon - Fri</span>
                                    <span class="text-white">8:30 - 4:30</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="opacity-70">Saturday</span>
                                    <span class="text-white">8:30 - 12:30</span>
                                </div>
                                <p class="text-[10px] text-amber-500 pt-2 uppercase tracking-tighter italic">* Sunday: Closed</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-indigo-900 pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-[10px] font-black uppercase tracking-widest opacity-40">
                        <p>© 2025 Sri Sai Vidyalayam. All rights reserved.</p>
                        <p>Recognised by Govt. of Andhra Pradesh</p>
                    </div>
                </div>
            </footer>
        </div>

        <!-- VIEW: DAILY UPDATES -->
        <div id="view-updates" class="hidden min-h-screen py-16 bg-slate-50 view-section">
            <div class="max-w-4xl mx-auto px-6">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-3xl font-black text-indigo-950 uppercase">Daily Notice Board</h2>
                    <select id="board-class-filter" class="bg-white border-2 border-slate-200 rounded-xl px-4 py-2 font-bold outline-none shadow-sm focus:border-indigo-500 transition-colors" onchange="home.renderUpdates()">
                        <option value="All">All Classes</option>
                    </select>
                </div>
                <div id="board-updates-list" class="space-y-6"></div>
                <div class="mt-12 text-center">
                    <button onclick="router.navigate('home')" class="text-indigo-600 font-bold hover:underline flex items-center justify-center gap-2 mx-auto">
                        <span class="material-symbols-outlined text-sm">arrow_back</span> Back to Home
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="hidden min-h-screen bg-indigo-50 flex items-center justify-center p-6 view-section">
            <div class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl">
                <div class="text-center mb-8">
                    <div class="bg-indigo-950 text-white w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 text-3xl font-bold border-4 border-amber-400 shadow-xl">SSV</div>
                    <h2 class="text-2xl font-bold uppercase tracking-tight text-indigo-950">Administrative Access</h2>
                </div>
                <form onsubmit="auth_manager.login(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-500 mb-2">Login Identifier</label>
                        <input type="text" id="userid" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-indigo-600 transition-all font-bold" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-500 mb-2">Security Passkey</label>
                        <input type="password" id="password" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-indigo-600 transition-all font-bold" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-950 text-white py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-indigo-900 transition-all active:scale-95 shadow-xl shadow-indigo-100">Sign In</button>
                </form>
            </div>
        </div>

        <!-- VIEW: ADMIN PANEL -->
        <div id="view-admin" class="hidden min-h-screen bg-slate-100 flex flex-col md:flex-row view-section">
            <aside class="bg-indigo-950 text-white w-full md:w-72 flex-shrink-0 md:h-screen md:sticky top-0 flex flex-col shadow-2xl">
                <div class="p-8 border-b border-indigo-900 font-black text-xl flex items-center gap-3">
                    <span class="material-symbols-outlined text-amber-400">dashboard</span> Admin Portal
                </div>
                <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('dashboard')"><span class="material-symbols-outlined">analytics</span> Dashboard</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('admissions')"><span class="material-symbols-outlined">person_add</span> Admissions</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('students')"><span class="material-symbols-outlined">groups</span> Student Records</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('data_management')"><span class="material-symbols-outlined">database</span> Data Backup</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('updates_manager')"><span class="material-symbols-outlined">campaign</span> Notice Board</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('blog_manager')"><span class="material-symbols-outlined">photo_library</span> Highlights</button>
                </nav>
                <div class="p-6 border-t border-indigo-900">
                    <button onclick="auth_manager.logout()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-red-700 transition-all active:scale-95"><span class="material-symbols-outlined">logout</span> Exit</button>
                </div>
            </aside>

            <main class="flex-1 p-6 md:p-12 overflow-x-hidden">
                <!-- Dashboard -->
                <div id="tab-dashboard" class="admin-content hidden space-y-10">
                    <h2 class="text-3xl font-black text-indigo-950">Financial Overview</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-indigo-600 hover-lift transition-all">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Total Revenue</p>
                            <div class="text-3xl font-black mt-2 text-indigo-950" id="stat-total">₹0</div>
                        </div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-green-500 hover-lift transition-all">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Collected</p>
                            <div class="text-3xl font-black mt-2 text-green-600" id="stat-collected">₹0</div>
                        </div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-red-500 hover-lift transition-all">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Outstanding</p>
                            <div class="text-3xl font-black mt-2 text-red-600" id="stat-pending">₹0</div>
                        </div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-amber-400 hover-lift transition-all">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Enrollments</p>
                            <div class="text-3xl font-black mt-2 text-amber-600" id="stat-count">0</div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-sm h-96">
                        <canvas id="feeChart"></canvas>
                    </div>
                </div>

                <!-- Admissions -->
                <div id="tab-admissions" class="admin-content hidden">
                    <h2 class="text-3xl font-black text-indigo-950 mb-10">New Enrollment</h2>
                    <form id="admissions-form" onsubmit="admin.registerStudent(event)" class="bg-white p-10 rounded-[3rem] shadow-sm grid grid-cols-1 md:grid-cols-2 gap-8 font-bold">
                        <div class="space-y-1"><label class="text-sm text-slate-400">Admission Number</label><input type="text" name="admnNo" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all" required></div>
                        <div class="space-y-1"><label class="text-sm text-slate-400">Student Name</label><input type="text" name="name" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all" required></div>
                        <div class="space-y-1"><label class="text-sm text-slate-400">Grade / Class</label><select id="admit-class-select" name="class" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all"></select></div>
                        <div class="space-y-1"><label class="text-sm text-slate-400">Parent/Guardian Name</label><input type="text" name="father" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all" required></div>
                        <div class="space-y-1"><label class="text-sm text-slate-400">Mobile Number</label><input type="tel" name="contact" maxlength="10" pattern="[0-9]{10}" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1"><label class="text-sm text-slate-400">Academic Fee</label><input type="number" name="fee" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all" required></div>
                            <div class="space-y-1"><label class="text-sm text-slate-400">Previous Dues</label><input type="number" name="oldDue" value="0" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all"></div>
                        </div>
                        <div class="space-y-1"><label class="text-sm text-slate-400">Initial Payment (Today)</label><input type="number" name="initialPay" value="0" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 focus:bg-white focus:border-indigo-200 transition-all text-green-600 font-black"></div>
                        <div class="space-y-1"><label class="text-sm text-slate-400">Concession Slip / Document</label><input type="file" id="admit-slip-input" accept="image/*,application/pdf" class="w-full border-2 border-slate-50 p-3 rounded-2xl bg-slate-50 focus:bg-white transition-all text-xs"></div>
                        <button type="submit" id="admit-submit-btn" class="col-span-full bg-indigo-600 text-white py-5 rounded-3xl font-black uppercase text-lg shadow-xl hover:bg-indigo-700 active:scale-95 transition-all mt-4">Save Enrollment</button>
                    </form>
                </div>

                <!-- Records -->
                <div id="tab-students" class="admin-content hidden space-y-8">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <h2 class="text-3xl font-black text-indigo-950">Student Database</h2>
                        <button onclick="printer.printMasterLedger()" class="bg-indigo-950 text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-2 text-sm shadow-md hover-lift transition-all">
                            <span class="material-symbols-outlined text-lg">print</span> Master Ledger
                        </button>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="record-search" placeholder="Search by name or admission number..." class="flex-1 p-5 rounded-3xl border-2 border-white shadow-sm font-bold focus:border-indigo-200 outline-none transition-all" oninput="admin.renderStudentList()">
                        <select id="record-class-filter" class="w-48 p-5 rounded-3xl border-2 border-white shadow-sm font-bold focus:border-indigo-200 outline-none transition-all" onchange="admin.renderStudentList()">
                            <option value="All">All Grades</option>
                        </select>
                    </div>
                    <div class="bg-white rounded-[2rem] shadow-sm overflow-hidden overflow-x-auto border border-slate-100">
                        <table class="w-full text-left">
                            <thead class="bg-indigo-50 border-b">
                                <tr class="font-black uppercase text-xs text-indigo-900">
                                    <th class="p-6">ID</th><th class="p-6">Name</th><th class="p-6">Class</th><th class="p-6">Contact</th><th class="p-6 text-right">Balance</th><th class="p-6 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y font-bold"></tbody>
                        </table>
                    </div>
                </div>

                <!-- DATA MANAGEMENT -->
                <div id="tab-data_management" class="admin-content hidden space-y-12">
                    <h2 class="text-3xl font-black text-indigo-950">Data Management & Backup</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <!-- Excel Section -->
                        <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 space-y-8">
                            <div class="flex items-center gap-3 text-emerald-600">
                                <span class="material-symbols-outlined text-4xl">table_chart</span>
                                <h3 class="text-2xl font-black uppercase">Excel / Spreadsheet</h3>
                            </div>
                            <p class="text-sm text-slate-500 font-bold leading-relaxed italic">Ideal for bulk entry of new students or external reporting.</p>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <button onclick="admin.exportExcel()" class="bg-slate-100 text-slate-800 p-5 rounded-3xl font-black uppercase text-xs flex items-center justify-center gap-3 hover:bg-slate-200 transition-all">
                                    <span class="material-symbols-outlined">download</span> Download Student Excel
                                </button>
                                
                                <div class="relative group">
                                    <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .xls, .csv" onchange="admin.importBulkData(event)">
                                    <button onclick="document.getElementById('import-file-input').click()" class="w-full bg-emerald-600 text-white p-5 rounded-3xl font-black uppercase text-xs flex items-center justify-center gap-3 hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-50">
                                        <span class="material-symbols-outlined">upload_file</span> Import from Excel/CSV
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- JSON Section -->
                        <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 space-y-8">
                            <div class="flex items-center gap-3 text-indigo-600">
                                <span class="material-symbols-outlined text-4xl">data_object</span>
                                <h3 class="text-2xl font-black uppercase">Full JSON Backup</h3>
                            </div>
                            <p class="text-sm text-slate-500 font-bold leading-relaxed italic">Advanced backup that preserves all payment history and document links.</p>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <button onclick="admin.exportJSON()" class="bg-indigo-50 text-indigo-900 p-5 rounded-3xl font-black uppercase text-xs flex items-center justify-center gap-3 hover:bg-indigo-100 transition-all">
                                    <span class="material-symbols-outlined text-lg">save</span> Export Database (JSON)
                                </button>
                                
                                <div class="relative group">
                                    <input type="file" id="import-json-input" class="hidden" accept=".json" onchange="admin.importJSON(event)">
                                    <button onclick="document.getElementById('import-json-input').click()" class="w-full bg-indigo-950 text-white p-5 rounded-3xl font-black uppercase text-xs flex items-center justify-center gap-3 hover:bg-indigo-900 transition-all shadow-lg shadow-indigo-100">
                                        <span class="material-symbols-outlined">restore</span> Restore Database (JSON)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Updates Manager -->
                <div id="tab-updates_manager" class="admin-content hidden grid grid-cols-1 lg:grid-cols-3 gap-12">
                    <div class="lg:col-span-1 space-y-8">
                        <h2 class="text-2xl font-black text-indigo-950">Post Notice</h2>
                        <form onsubmit="admin.addNotice(event)" class="bg-white p-8 rounded-[2rem] shadow-sm space-y-6 font-bold">
                            <div>
                                <label class="text-xs text-slate-400">Class / Grade</label>
                                <select id="notice-class-select" name="class" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1"></select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">Subject</label>
                                <select name="subject" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1">
                                    <option value="General News">General News</option>
                                    <option value="Telugu">Telugu</option>
                                    <option value="Hindi">Hindi</option>
                                    <option value="English">English</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Science">Science</option>
                                    <option value="Social">Social</option>
                                    <option value="E.V.S">E.V.S</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">Category</label>
                                <select name="category" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1">
                                    <option>Announcement</option>
                                    <option>Homework</option>
                                    <option>Exam Alert</option>
                                    <option>Holiday Notice</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">Details</label>
                                <textarea name="content" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1 h-32 focus:bg-white transition-all outline-none" required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-sm shadow-lg shadow-indigo-100">Publish Notice</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <h2 class="text-2xl font-black text-indigo-950">Existing Notices</h2>
                        <div id="admin-notices-list" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Blog Manager -->
                <div id="tab-blog_manager" class="admin-content hidden grid grid-cols-1 lg:grid-cols-3 gap-12">
                     <div class="lg:col-span-1 space-y-8">
                        <h2 class="text-2xl font-black text-indigo-950">Add Highlight</h2>
                        <form onsubmit="admin.addHighlight(event)" class="bg-white p-8 rounded-[2rem] shadow-sm space-y-6 font-bold">
                            <div><label class="text-xs text-slate-400">Title</label><input type="text" name="title" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1" required></div>
                            <div><label class="text-xs text-slate-400">Media Type</label><select name="type" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1"><option value="image">Photo</option><option value="youtube">YouTube</option></select></div>
                            <div><label class="text-xs text-slate-400">Media URL</label><input type="text" name="url" placeholder="https://..." class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1" required></div>
                            <button type="submit" class="w-full bg-orange-600 text-white py-4 rounded-2xl font-black uppercase text-sm">Post Highlight</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 space-y-8"><h2 class="text-2xl font-black text-indigo-950">Current Carousel</h2><div id="admin-highlights-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div></div>
                </div>
            </main>
        </div>

        <!-- MODAL: STUDENT PROFILE -->
        <div id="student-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[2.5rem] overflow-hidden flex flex-col font-bold shadow-2xl">
                <div class="p-8 bg-indigo-950 text-white flex justify-between items-center"><h2 id="modal-name" class="text-2xl font-black uppercase"></h2><button onclick="admin.closeModal()" class="text-4xl hover:text-amber-400 transition-colors">&times;</button></div>
                <div class="flex-1 overflow-y-auto p-8 bg-slate-50 grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-3xl shadow-sm space-y-3">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Details</p>
                            <p>Grade: <span id="modal-class" class="text-indigo-600"></span></p>
                            <p>Father: <span id="modal-father"></span></p>
                            <p>Mobile: <span id="modal-contact"></span></p>
                            <p class="text-2xl text-red-600 font-black mt-4">Balance: <span id="modal-balance"></span></p>
                            <div id="modal-slip-area" class="hidden pt-2"><button onclick="admin.viewConcessionSlip()" class="flex items-center gap-2 text-indigo-600 text-xs hover:underline uppercase font-black"><span class="material-symbols-outlined text-base">attachment</span> View Document</button></div>
                        </div>
                        <div class="space-y-2">
                            <button onclick="printer.printLedger()" class="w-full bg-white border-2 border-slate-200 py-4 rounded-2xl hover:bg-slate-100 hover-lift transition-all">Print Statement</button>
                            <button onclick="admin.initiateSecureDelete()" class="w-full text-red-600 text-xs uppercase py-2 hover:underline font-black">Delete Record</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <form onsubmit="admin.recordPayment(event)" class="bg-white p-8 rounded-[2rem] shadow-sm grid grid-cols-2 gap-6 border border-emerald-50">
                            <div class="col-span-2 text-xs uppercase font-black text-slate-400">Record Fee Collection</div>
                            <input type="number" id="pay-amt" placeholder="Amount (₹)" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 font-black text-xl focus:bg-white transition-all outline-none" required>
                            <input type="date" id="pay-date" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 focus:bg-white transition-all outline-none" required>
                            <input type="text" id="pay-remark" placeholder="Remark" class="col-span-2 border-2 border-slate-50 p-4 rounded-xl bg-slate-50 focus:bg-white transition-all outline-none">
                            <button type="submit" class="col-span-2 bg-green-600 text-white py-4 rounded-2xl font-black uppercase hover:bg-green-700 transition-all shadow-lg shadow-green-100">Confirm Payment</button>
                        </form>
                        <div class="bg-white rounded-[2rem] shadow-sm overflow-hidden border border-slate-100">
                            <div class="p-4 bg-slate-100 text-[10px] font-black uppercase tracking-widest text-slate-500">Transaction Log</div>
                            <table class="w-full text-left text-sm"><tbody id="modal-history" class="divide-y font-bold text-slate-700"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECURE DELETE PIN MODAL -->
        <div id="delete-pin-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-80 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-xs p-8 rounded-[2.5rem] shadow-2xl text-center font-bold">
                <span class="material-symbols-outlined text-red-600 text-6xl mb-4">lock_reset</span>
                <h3 class="text-xl font-black mb-2 uppercase tracking-tight">Security PIN</h3>
                <input type="password" id="delete-pin-input" class="w-full border-2 border-slate-100 p-4 rounded-2xl text-center font-black text-3xl mb-6 focus:border-red-600 outline-none transition-all" placeholder="••••">
                <div class="flex gap-3">
                    <button onclick="admin.closeDeleteModal()" class="flex-1 py-3 bg-slate-100 rounded-xl font-black text-xs uppercase tracking-widest">Cancel</button>
                    <button onclick="admin.executeSecureDelete()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-red-700 transition-all">Verify</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINTING AREA -->
    <div id="printable-area"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Firebase Setup
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(firebaseConfigRaw);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sri-sai-v-portal';

        // State Management
        window.state = {
            user: null, students: [], notices: [], highlights: [],
            activeStudentId: null, blogIndex: 0, isLoggedIn: false,
            classes: ["Nursery", "LKG", "UKG", "1st Class", "2nd Class", "3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"]
        };

        window.toggleMobileMenu = () => document.getElementById('mobile-menu').classList.toggle('hidden');

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        };

        // --- AUTH TRIGGER (IMMEDIATE LOAD) ---
        onAuthStateChanged(auth, (u) => {
            state.user = u;
            
            const loader = document.getElementById('cloud-loader');
            if(loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 400);
            }

            if (u) {
                startSync();
            } else {
                if(!document.querySelector('.view-section:not(.hidden)')) router.navigate('home');
            }
        });

        const startSync = () => {
            if (!state.user) return;
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => {
                state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                admin.updateDashboard(); 
                admin.renderStudentList();
                
                if(document.getElementById('view-login').offsetParent || !document.querySelector('.view-section:not(.hidden)')) {
                   router.navigate('home');
                }
            }, (err) => console.error("Sync Error:", err));

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'notices'), (snap) => {
                state.notices = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp);
                home.renderUpdates(); 
                admin.renderNotices();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'highlights'), (snap) => {
                state.highlights = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                home.renderHighlights(); 
                admin.renderHighlights();
            });
        };

        window.router = {
            navigate: (view) => {
                if(view === 'admin' && !state.isLoggedIn) return router.navigate('login');
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${view}`);
                if (target) {
                    target.classList.remove('hidden');
                }
                if (view === 'home') home.init();
                if (view === 'admin') admin.init();
                window.scrollTo(0,0);
            }
        };

        window.auth_manager = {
            login: (e) => {
                e.preventDefault();
                const uid = document.getElementById('userid').value;
                const pass = document.getElementById('password').value;
                if (uid === 'admin' && pass === '123') {
                    state.isLoggedIn = true; 
                    router.navigate('admin');
                } else alert('Access Denied');
            },
            logout: () => { state.isLoggedIn = false; router.navigate('home'); }
        };

        window.home = {
            init: () => {
                home.startHeroSlider();
                const filter = document.getElementById('board-class-filter');
                if(filter) filter.innerHTML = '<option value="All">All School Notices</option>' + state.classes.map(c => `<option value="${c}">${c}</option>`).join('');
            },
            startHeroSlider: () => {
                let current = 0; const slides = document.querySelectorAll('#hero-text-slider .slide');
                if(window.heroInterval) clearInterval(window.heroInterval);
                window.heroInterval = setInterval(() => {
                    if(!slides.length) return; slides[current].classList.remove('active');
                    current = (current + 1) % slides.length; slides[current].classList.add('active');
                }, 4500);
            },
            renderHighlights: () => {
                const track = document.getElementById('blog-posts-feed');
                if(!track) return;
                track.innerHTML = state.highlights.map((h, i) => `
                    <div class="blog-slide">
                        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-indigo-50">
                            ${h.type === 'youtube' ? `<div class="video-container" onclick="home.playVideo('${h.id}', '${h.url}')" id="vid-${h.id}"><div class="absolute inset-0 flex items-center justify-center bg-black/30 text-white"><span class="material-symbols-outlined text-6xl">play_circle</span></div></div>` : `<img src="${h.url}" class="w-full h-64 md:h-96 object-cover rounded-2xl shadow-inner bg-slate-50">`}
                            <div class="mt-6 text-left"><h3 class="font-black text-xl text-indigo-950 uppercase tracking-tight">${h.title}</h3></div>
                        </div>
                    </div>
                `).join('') || '<div class="w-full py-10 opacity-30 font-black text-center italic">Highlights Loading...</div>';
                state.blogIndex = 0; home.updateSlider();
            },
            playVideo: (id, url) => {
                const yId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
                document.getElementById(`vid-${id}`).innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${yId}?autoplay=1" frameborder="0" allowfullscreen></iframe>`;
            },
            nextBlog: () => { if(state.highlights.length > 1) { state.blogIndex = (state.blogIndex + 1) % state.highlights.length; home.updateSlider(); } },
            prevBlog: () => { if(state.highlights.length > 1) { state.blogIndex = (state.blogIndex - 1 + state.highlights.length) % state.highlights.length; home.updateSlider(); } },
            updateSlider: () => { const track = document.getElementById('blog-posts-feed'); if(track) track.style.transform = `translateX(-${state.blogIndex * 100}%)`; },
            renderUpdates: () => {
                const list = document.getElementById('board-updates-list');
                const filter = document.getElementById('board-class-filter').value;
                if(!list) return;
                const filtered = state.notices.filter(n => filter === 'All' || n.class === filter);
                list.innerHTML = filtered.map(n => `<div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-indigo-500 hover:shadow-md transition-shadow"><div class="flex justify-between items-start mb-2"><span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">${n.category} • ${new Date(n.timestamp).toLocaleDateString()}</span><span class="text-[9px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded font-black">${n.class}</span></div><p class="font-bold text-slate-700 text-lg">${n.subject && n.subject !== 'General News' ? '<span class="text-indigo-600 font-black">['+n.subject+'] </span>' : ''}${n.content}</p></div>`).join('') || '<div class="text-center py-10 text-slate-400 font-bold">No announcements yet.</div>';
            }
        };

        window.admin = {
            init: () => {
                const selects = document.querySelectorAll('#admit-class-select, #record-class-filter, #notice-class-select');
                selects.forEach(s => s.innerHTML = (s.id.includes('filter') || s.id.includes('notice') ? '<option value="All">All Classes</option>' : '') + state.classes.map(c => `<option value="${c}">${c}</option>`).join(''));
                admin.switchTab('dashboard');
                admin.updateDashboard();
            },
            switchTab: (tabId) => {
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`tab-${tabId}`);
                if(target) target.classList.remove('hidden');
                document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.toggle('bg-indigo-900', btn.onclick.toString().includes(tabId)));
            },
            updateDashboard: () => {
                let total = 0, collected = 0;
                state.students.forEach(s => { total += (s.fee + (s.oldDue || 0)); collected += (s.paid || 0); });
                document.getElementById('stat-total').innerText = `₹${total.toLocaleString()}`;
                document.getElementById('stat-collected').innerText = `₹${collected.toLocaleString()}`;
                document.getElementById('stat-pending').innerText = `₹${(total - collected).toLocaleString()}`;
                document.getElementById('stat-count').innerText = state.students.length;
                const ctx = document.getElementById('feeChart')?.getContext('2d');
                if(!ctx) return; if(window.dashChart) window.dashChart.destroy();
                window.dashChart = new Chart(ctx, { type: 'bar', data: { labels: ['Target', 'Collected', 'Due'], datasets: [{ data: [total, collected, total - collected], backgroundColor: ['#312e81', '#10b981', '#ef4444'], borderRadius: 12 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, animation: { duration: 1000 } } });
            },
            registerStudent: async (e) => {
                e.preventDefault(); const form = e.target; const btn = document.getElementById('admit-submit-btn');
                const fd = new FormData(form); const slipFile = document.getElementById('admit-slip-input').files[0];
                if (!state.user) return;
                btn.innerText = "Processing..."; btn.disabled = true;
                let slipBase64 = null;
                if(slipFile && slipFile.size < 800000) {
                    slipBase64 = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(slipFile); });
                }
                const initialPay = parseFloat(fd.get('initialPay') || 0);
                const data = { admnNo: fd.get('admnNo'), name: fd.get('name'), class: fd.get('class'), father: fd.get('father'), contact: fd.get('contact'), fee: parseFloat(fd.get('fee')), oldDue: parseFloat(fd.get('oldDue') || 0), paid: initialPay, history: initialPay > 0 ? [{ amount: initialPay, timestamp: Date.now(), remark: 'Initial Admission' }] : [], concessionSlip: slipBase64, timestamp: Date.now() };
                admin.switchTab('students'); form.reset(); btn.innerText = "Save Enrollment"; btn.disabled = false;
                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), data);
            },
            renderStudentList: () => {
                const body = document.getElementById('student-list-body'); const search = document.getElementById('record-search').value.toLowerCase();
                const filter = document.getElementById('record-class-filter').value;
                if(!body) return;
                const filtered = state.students.filter(s => (filter === 'All' || s.class === filter) && (s.name.toLowerCase().includes(search) || s.admnNo.includes(search)));
                body.innerHTML = filtered.map(s => `
                    <tr class="hover:bg-indigo-50/50 cursor-pointer transition-colors border-b" onclick="admin.openModal('${s.id}')">
                        <td class="p-6 font-mono text-[10px] text-slate-400">${s.admnNo}</td><td class="p-6 uppercase font-bold text-indigo-950">${s.name}</td>
                        <td class="p-6 text-slate-500">${s.class}</td><td class="p-6 text-slate-500">${s.contact}</td>
                        <td class="p-6 text-right text-red-600 font-black">₹${((s.fee + (s.oldDue || 0)) - (s.paid || 0)).toLocaleString()}</td>
                        <td class="p-6 text-right"><span class="material-symbols-outlined text-indigo-200">chevron_right</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="p-10 text-center text-slate-400 italic">No records.</td></tr>';
            },
            openModal: (id) => {
                state.activeStudentId = id; const s = state.students.find(x => x.id === id); if(!s) return;
                document.getElementById('modal-name').innerText = s.name; document.getElementById('modal-class').innerText = s.class;
                document.getElementById('modal-father').innerText = s.father; document.getElementById('modal-contact').innerText = s.contact;
                document.getElementById('modal-balance').innerText = `₹${((s.fee + (s.oldDue || 0)) - (s.paid || 0)).toLocaleString()}`;
                document.getElementById('modal-history').innerHTML = (s.history || []).map(h => `<tr class="border-b font-bold"><td class="p-4 text-slate-400 text-xs">${new Date(h.timestamp).toLocaleDateString()}</td><td class="p-4 text-xs font-bold">${h.remark || 'Academic Fee'}</td><td class="p-4 text-right text-green-600 font-black">₹${h.amount.toLocaleString()}</td><td class="p-4 text-right"><button onclick="printer.printReceipt('${h.timestamp}')"><span class="material-symbols-outlined">print</span></button></td></tr>`).reverse().join('');
                document.getElementById('modal-slip-area').classList.toggle('hidden', !s.concessionSlip);
                document.getElementById('student-modal').classList.remove('hidden-modal'); document.getElementById('pay-date').valueAsDate = new Date();
            },
            viewConcessionSlip: () => { const s = state.students.find(x => x.id === state.activeStudentId); if(s?.concessionSlip) { const w = window.open(); w.document.write(`<iframe src="${s.concessionSlip}" style="width:100%;height:100%;" frameborder="0"></iframe>`); } },
            closeModal: () => document.getElementById('student-modal').classList.add('hidden-modal'),
            initiateSecureDelete: () => { document.getElementById('delete-pin-input').value = ''; document.getElementById('delete-pin-modal').classList.remove('hidden-modal'); },
            closeDeleteModal: () => document.getElementById('delete-pin-modal').classList.add('hidden-modal'),
            executeSecureDelete: async () => { if (document.getElementById('delete-pin-input').value === '123') { const sId = state.activeStudentId; if (!state.user) return; admin.closeDeleteModal(); admin.closeModal(); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sId)); } else alert('PIN Incorrect'); },
            recordPayment: async (e) => {
                e.preventDefault(); if (!state.user) return; const amt = parseFloat(document.getElementById('pay-amt').value); const date = document.getElementById('pay-date').value; const s = state.students.find(x => x.id === state.activeStudentId); if(!s || isNaN(amt)) return;
                s.paid = (s.paid || 0) + amt; if(!s.history) s.history = []; s.history.push({ amount: amt, timestamp: new Date(date).getTime() || Date.now(), remark: document.getElementById('pay-remark').value });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id), { paid: s.paid, history: s.history }); admin.openModal(s.id); document.getElementById('pay-amt').value = '';
            },

            // --- DATA TOOLS ---
            exportExcel: () => {
                const rows = state.students.map(s => ({ ID: s.admnNo, Name: s.name, Class: s.class, Parent: s.father, Contact: s.contact, Fee: s.fee, OldDue: s.oldDue, Paid: s.paid, Balance: (s.fee + (s.oldDue || 0)) - (s.paid || 0) }));
                const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Students"); XLSX.writeFile(wb, "SSV_Export.xlsx");
            },
            importBulkData: (evt) => {
                const f = evt.target.files[0]; if(!f || !state.user) return;
                const r = new FileReader(); r.onload = (e) => {
                    const b = e.target.result; const w = XLSX.read(b, {type:'binary'});
                    const j = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                    j.forEach(async r => {
                        const d = { admnNo:String(r.ID||''), name:String(r.Name||''), class:String(r.Class||'Nursery'), father:String(r.Parent||''), contact:String(r.Contact||''), fee:parseFloat(r.Fee||0), oldDue:parseFloat(r.OldDue||0), paid:parseFloat(r.Paid||0), history:[], timestamp:Date.now() };
                        if(d.name) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), d);
                    });
                    alert('Excel Data Imported.'); evt.target.value = '';
                }; r.readAsBinaryString(f);
            },
            exportJSON: () => {
                const blob = new Blob([JSON.stringify(state.students, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url);
            },
            importJSON: async (e) => {
                const f = e.target.files[0]; if(!f || !state.user) return;
                const r = new FileReader(); r.onload = async (evt) => {
                    const j = JSON.parse(evt.target.result);
                    for (const s of j) { const id = s.id || Date.now().toString(); delete s.id; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), s); }
                    alert('Database Restored.'); e.target.value = '';
                }; r.readAsText(f);
            },

            addNotice: async (e) => { e.preventDefault(); if (!state.user) return; const fd = new FormData(e.target); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notices'), { class: fd.get('class'), subject: fd.get('subject'), category: fd.get('category'), content: fd.get('content'), timestamp: Date.now() }); e.target.reset(); },
            renderNotices: () => { const list = document.getElementById('admin-notices-list'); if(!list) return; list.innerHTML = state.notices.map(n => `<div class="bg-white p-5 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50 group hover:shadow-md transition-shadow"><div><div class="text-[9px] uppercase font-black text-indigo-400 tracking-tighter">${n.class} • ${n.category} ${n.subject && n.subject !== 'General News' ? '• ' + n.subject : ''}</div><div class="text-indigo-950 font-bold">${n.content.substring(0,80)}...</div></div><button onclick="admin.deleteNotice('${n.id}')" class="text-slate-300 hover:text-red-600 transition-colors"><span class="material-symbols-outlined">delete</span></button></div>`).join('') || '<div class="text-slate-300 py-10 font-bold text-center italic">Notice board empty.</div>'; },
            deleteNotice: async (id) => { if (!state.user) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notices', id)); },
            addHighlight: async (e) => { e.preventDefault(); if (!state.user) return; const fd = new FormData(e.target); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'highlights'), { title: fd.get('title'), type: fd.get('type'), url: fd.get('url') }); e.target.reset(); },
            renderHighlights: () => { const list = document.getElementById('admin-highlights-list'); if(!list) return; list.innerHTML = state.highlights.map(h => `<div class="bg-white p-4 rounded-2xl flex flex-col gap-3 shadow-sm border border-slate-50"><img src="${h.type === 'image' ? h.url : 'https://img.youtube.com/vi/'+(h.url.split('v=')[1]?.split('&')[0] || h.url.split('/').pop())+'/mqdefault.jpg'}" class="h-32 w-full object-cover rounded-xl bg-slate-50"><div class="flex justify-between items-center px-1"><span class="text-xs font-black truncate text-indigo-950">${h.title}</span><button onclick="admin.deleteHighlight('${h.id}')" class="text-red-400 hover:text-red-600 transition-colors"><span class="material-symbols-outlined text-sm">delete</span></button></div></div>`).join('') || '<div class="text-slate-300 py-10 font-bold text-center col-span-full italic">Highlights empty.</div>'; },
            deleteHighlight: async (id) => { if (!state.user) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'highlights', id)); }
        };

        window.printer = {
            printReceipt: (ts) => {
                const s = state.students.find(x => x.id === state.activeStudentId); const h = s.history.find(x => x.timestamp == ts);
                document.getElementById('printable-area').innerHTML = `<div style="border:4px double #000;padding:40px;font-family:sans-serif;max-width:600px;margin:auto;background:white;position:relative;"><div style="position:absolute;top:10px;right:10px;opacity:0.1;font-size:80px;font-weight:900;">SSV</div><h1 style="text-align:center;text-transform:uppercase;">Sri Sai Vidyalayam</h1><p style="text-align:center;font-weight:bold;border-bottom:1px solid #eee;padding-bottom:10px;">OFFICIAL FEE RECEIPT • ${new Date(h.timestamp).toLocaleDateString()}</p><p><b>Admission ID:</b> ${s.admnNo}</p><p><b>Student Name:</b> ${s.name}</p><p><b>Class:</b> ${s.class}</p><p><b>Remark:</b> ${h.remark || 'Fee'}</p><h2 style="background:#f4f4f4;padding:20px;text-align:center;">AMOUNT PAID: ₹${h.amount.toLocaleString()}</h2><p style="text-align:right;font-weight:bold;">Outstanding Balance: ₹${((s.fee+(s.oldDue||0))-s.paid).toLocaleString()}</p></div>`; window.print();
            },
            printLedger: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                document.getElementById('printable-area').innerHTML = `<div style="padding:40px;font-family:sans-serif;background:white;"><h1>Account Statement: ${s.name}</h1><p>ID: ${s.admnNo} | Class: ${s.class}</p><table style="width:100%;border-collapse:collapse;margin-top:20px;"><thead><tr style="background:#f4f4f4;"><th style="border:1px solid #ddd;padding:12px;text-align:left;">Date</th><th style="border:1px solid #ddd;padding:12px;text-align:left;">Description</th><th style="border:1px solid #ddd;padding:12px;text-align:right;">Amount</th></tr></thead><tbody>${s.history.map(h => `<tr><td style="border:1px solid #ddd;padding:12px;">${new Date(h.timestamp).toLocaleDateString()}</td><td style="border:1px solid #ddd;padding:12px;">${h.remark||'Academic Fee'}</td><td style="border:1px solid #ddd;padding:12px;text-align:right;">₹${h.amount.toLocaleString()}</td></tr>`).join('')}</tbody></table><div style="margin-top:20px;text-align:right;"><h2>Final Balance Due: ₹${((s.fee+(s.oldDue||0))-s.paid).toLocaleString()}</h2></div></div>`; window.print();
            },
            printMasterLedger: () => {
                document.getElementById('printable-area').innerHTML = `<div style="padding:40px;font-family:sans-serif;background:white;"><h1 style="text-align:center;">Sri Sai Vidyalayam - Master Fee Ledger</h1><table style="width:100%;border-collapse:collapse;margin-top:30px;"><thead style="background:#1e1b4b;color:#fff;"><tr><th style="padding:12px;">ID</th><th style="padding:12px;">Name</th><th style="padding:12px;">Class</th><th style="padding:12px;text-align:right;">Net Due</th></tr></thead><tbody>${state.students.map(s => `<tr><td style="border:1px solid #ddd;padding:12px;">${s.admnNo}</td><td style="border:1px solid #ddd;padding:12px;font-weight:bold;">${s.name}</td><td style="border:1px solid #ddd;padding:12px;">${s.class}</td><td style="border:1px solid #ddd;padding:12px;text-align:right;">₹${((s.fee+(s.oldDue||0))-s.paid).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`; window.print();
            }
        };

        (async () => { await initAuth(); })();
    </script>
</body>
</html>
