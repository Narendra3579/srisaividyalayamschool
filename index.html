<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sri Sai Vidyalayam - Admin Portal</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    
    <style>
        body { font-family: 'Open Sans', sans-serif; overflow-x: hidden; width: 100%; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }
        
        .modal { transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); }
        
        .view-section { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .video-container { 
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; 
            background: #0f172a; border-radius: 16px; cursor: pointer; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .video-container iframe, .video-container video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            border: none !important; object-fit: cover;
        }

        .blog-slider-container { position: relative; width: 100%; overflow: hidden; }
        .blog-slider-track { display: flex; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .blog-slide { flex: 0 0 100%; padding: 0 10px; box-sizing: border-box; }

        #printable-area { display: none; }
        @media print {
            body * { visibility: hidden !important; }
            #printable-area, #printable-area * { visibility: visible !important; }
            #printable-area { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; background: white !important; color: black !important; padding: 20px !important; }
        }

        .bus-drive { animation: driveAcross 15s linear infinite; transform-box: fill-box; }
        @keyframes driveAcross { from { transform: translateX(850px); } to { transform: translateX(-450px); } }
        
        .wheel-spin { animation: spin 2s linear infinite; transform-origin: center; transform-box: fill-box; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .cloud-drift { animation: cloudDrift 45s linear infinite; }
        @keyframes cloudDrift { from { transform: translateX(-150px); } to { transform: translateX(950px); } }

        .sun-rotate { animation: sunSpin 20s linear infinite; }
        @keyframes sunSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #hero-text-slider .slide { display: none; }
        #hero-text-slider .slide.active { display: block; animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .nav-badge {
            position: absolute; top: -8px; right: -12px; background: #dc2626; color: white;
            font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 9999px;
            animation: bounce 2s infinite; border: 2px solid #1e1b4b;
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-4px);} }
        
        .hover-lift { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hover-lift:hover { transform: translateY(-2px) scale(1.02); }

        .sort-header { cursor: pointer; user-select: none; }
        .sort-header:hover { background-color: #f1f5f9; }

        #admissions-popup {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 100;
            width: calc(100% - 3rem);
            max-width: 350px;
        }

        .notify-dot {
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
            margin-left: 6px;
            box-shadow: 0 0 8px #ef4444;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
        }
        .shake-element {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        .pulse-red {
            animation: pulse-red-bg 1.5s infinite;
        }
        @keyframes pulse-red-bg {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* Toast Notification Styling */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none;
        }
        .toast {
            background: #1e1b4b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            min-width: 250px;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 w-full min-h-screen font-bold">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- FLOATING ADMISSIONS POPUP -->
    <div id="admissions-popup" class="hidden-modal modal no-print">
        <div class="bg-white rounded-[2rem] overflow-hidden shadow-2xl border border-indigo-100 relative text-indigo-950 font-black">
            <button onclick="home.closeAdmissionsPopup()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition-colors z-10">
                <span class="material-symbols-outlined text-2xl font-bold">cancel</span>
            </button>
            <div class="bg-amber-400 p-6 flex items-center gap-4 text-indigo-950 font-black">
                <div class="bg-indigo-950 text-white w-12 h-12 flex-shrink-0 rounded-2xl flex items-center justify-center text-sm font-black border-2 border-white shadow-lg">SSV</div>
                <div>
                    <h2 class="text-xl font-black uppercase tracking-tight leading-none">Admissions Open</h2>
                    <p class="text-indigo-900 font-black uppercase tracking-widest text-[9px] mt-1">Academic Year 2026-27</p>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-slate-600 font-black text-sm leading-relaxed">Secure your child's seat in our pollution-free green campus. Join the SSV family today!</p>
                <a href="tel:8121218825" class="bg-indigo-600 text-white py-4 px-6 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 group">
                    <span class="material-symbols-outlined text-lg group-hover:rotate-12 transition-transform">call</span> Direct Call: 8121218825
                </a>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-indigo-950 text-white shadow-xl sticky top-0 z-40 no-print border-b border-indigo-800 w-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center space-x-3 cursor-pointer group" onclick="router.navigate('home')">
                    <div class="bg-white text-indigo-950 h-10 w-10 rounded-xl flex items-center justify-center font-black text-lg border-2 border-amber-400 group-hover:rotate-6 transition duration-300">SSV</div>
                    <div>
                        <h1 class="text-lg md:text-xl font-black uppercase tracking-tight text-white">Sri Sai Vidyalayam</h1>
                        <p class="text-[9px] text-amber-400 uppercase font-black tracking-widest text-indigo-100/60">Excellence in Education</p>
                    </div>
                </div>
                
                <div class="hidden md:flex space-x-8 items-center font-black">
                    <button class="hover:text-amber-400 font-black uppercase text-xs transition-colors" onclick="router.navigate('home')">Home</button>
                    <button class="relative hover:text-amber-400 font-black uppercase text-xs transition-colors" onclick="router.navigate('updates')">
                        Daily Board
                        <span id="nav-updates-badge" class="nav-badge hidden">0</span>
                    </button>
                    <button class="bg-amber-500 hover:bg-amber-400 text-indigo-950 px-5 py-2.5 rounded-xl transition-all duration-300 hover-lift flex items-center gap-2 text-xs font-black uppercase shadow-lg shadow-amber-500/20" onclick="router.navigate('login')">
                        <span class="material-symbols-outlined text-lg font-black">admin_panel_settings</span> Admin
                    </button>
                </div>
                
                <button class="md:hidden p-2 text-white hover:bg-indigo-900 rounded-lg transition" onclick="toggleMobileMenu()">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-indigo-900 border-t border-indigo-800 p-4 space-y-3 font-black text-indigo-50">
            <button class="block w-full text-left py-2 font-black hover:text-amber-400 transition" onclick="router.navigate('home'); toggleMobileMenu()">Home</button>
            <button class="block w-full text-left py-2 font-black hover:text-amber-400 transition relative" onclick="router.navigate('updates'); toggleMobileMenu()">
                Daily Board
                <span id="mobile-updates-badge" class="nav-badge hidden" style="top:5px; right: 20px;">0</span>
            </button>
            <button class="block w-full bg-amber-500 text-indigo-950 p-3 rounded-xl font-black uppercase text-xs text-center" onclick="router.navigate('login'); toggleMobileMenu()">Admin Login</button>
        </div>
    </nav>

    <div id="app" class="w-full">
        <!-- VIEW: HOME -->
        <div id="view-home" class="hidden view-section">
            <section class="py-12 md:py-24 bg-white overflow-hidden relative font-black text-indigo-950">
                <div class="absolute top-10 right-10 lg:right-20 text-amber-400 opacity-60 pointer-events-none sun-rotate">
                    <span class="material-symbols-outlined text-9xl lg:text-[10rem] font-black">wb_sunny</span>
                </div>
                <div class="absolute top-10 left-1/4 text-sky-300 opacity-30 cloud-drift font-black"><span class="material-symbols-outlined text-7xl font-black">cloud</span></div>
                <div class="absolute top-32 right-1/3 text-sky-400 opacity-20 cloud-drift font-black" style="animation-delay: -5s"><span class="material-symbols-outlined text-9xl font-black">cloud</span></div>

                <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center relative z-10">
                    <div class="space-y-8">
                        <span class="inline-block px-4 py-1.5 bg-indigo-100 text-indigo-700 rounded-full text-[10px] font-black uppercase tracking-widest animate-pulse">Recognised by Govt of AP</span>
                        <div id="hero-text-slider" class="min-h-[160px]">
                            <div class="slide active">
                                <h2 class="text-4xl md:text-6xl font-black text-indigo-950 leading-tight tracking-tighter uppercase">Pollution Free <br><span class="text-green-600 underline decoration-amber-400 underline-offset-8">Green Campus</span></h2>
                                <p class="text-slate-600 mt-4 text-lg font-bold">A serene environment located away from city noise, ensuring healthy learning for your child.</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="router.navigate('updates')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-5 rounded-2xl font-black shadow-xl transition-all hover-lift active:scale-95 uppercase tracking-widest text-xs">Check School Board</button>
                            <a href="tel:8121218825" class="bg-amber-500 hover:bg-amber-400 text-indigo-950 px-10 py-5 rounded-2xl font-bold shadow-xl transition-all hover-lift active:scale-95 uppercase tracking-widest text-xs flex items-center gap-2 text-indigo-950">
                                <span class="material-symbols-outlined text-sm font-black">call</span> Call Office
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- LATEST FROM NOTICE BOARD PREVIEW -->
            <section class="py-20 bg-indigo-50">
                <div class="max-w-7xl mx-auto px-6 text-indigo-950 font-black">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-8 mb-12">
                        <div>
                            <span class="text-indigo-600 font-black uppercase text-[10px] tracking-widest">Board Updates</span>
                            <h2 class="text-3xl md:text-4xl font-black text-indigo-950 uppercase tracking-tighter mt-2">Notice Board Preview</h2>
                        </div>
                        <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto">
                             <div class="relative w-full md:w-auto text-indigo-950">
                                 <div class="absolute -top-6 left-0 flex items-center gap-2">
                                     <label class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Filter by Class</label>
                                     <span id="home-filter-badge" class="hidden bg-red-600 text-white text-[8px] font-black px-2 py-0.5 rounded shadow-lg pulse-red uppercase ring-2 ring-white">NEW UPDATES</span>
                                 </div>
                                 <select id="home-class-filter" class="bg-white border-2 border-indigo-200 rounded-2xl px-6 py-3 font-black text-indigo-950 outline-none shadow-xl focus:border-indigo-600 transition-all cursor-pointer w-full md:min-w-[240px]" onchange="home.handleClassChange(this.value)">
                                     <option value="All">Select Class...</option>
                                 </select>
                             </div>
                             <button onclick="router.navigate('updates')" class="whitespace-nowrap px-6 py-4 bg-indigo-950 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-indigo-800 transition-all shadow-lg w-full md:w-auto">Full Board</button>
                        </div>
                    </div>
                    <div id="home-notices-preview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Content loaded via JS -->
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW: DAILY UPDATES -->
        <div id="view-updates" class="hidden view-section py-16 bg-slate-50 font-black text-indigo-950 min-h-screen">
            <div class="w-full px-6">
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12 font-bold text-indigo-950">
                    <div>
                        <h2 class="text-3xl font-black uppercase tracking-tighter text-indigo-950">Daily Notice Board</h2>
                        <p class="text-xs text-slate-400 mt-2 uppercase tracking-widest font-black" id="board-selected-label">Showing all Grades</p>
                    </div>
                    <div class="flex flex-col items-center md:items-end gap-2">
                        <label class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Filter by Class</label>
                        <select id="board-class-filter" class="bg-white border-2 border-indigo-100 rounded-2xl px-8 py-4 font-black text-indigo-950 outline-none shadow-xl focus:border-indigo-600 transition-all cursor-pointer appearance-none min-w-[240px] text-center" onchange="home.handleClassChange(this.value)"></select>
                    </div>
                </div>
                <div id="board-updates-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                <div class="mt-16 text-center">
                    <button onclick="router.navigate('home')" class="text-indigo-600 font-black hover:underline flex items-center justify-center gap-2 mx-auto uppercase tracking-widest text-xs transition-all"><span class="material-symbols-outlined text-sm">arrow_back</span> Back to Home</button>
                </div>
            </div>
        </div>

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="hidden view-section min-h-screen bg-indigo-50 flex items-center justify-center p-6 font-black text-indigo-950">
            <div id="login-card" class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl">
                <div class="text-center mb-8">
                    <div class="bg-indigo-950 text-white w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 text-3xl font-black border-4 border-amber-400 shadow-xl">SSV</div>
                    <h2 class="text-2xl font-black uppercase tracking-tight text-indigo-950">Admin Login</h2>
                </div>
                <form onsubmit="auth_manager.login(event)" class="space-y-6 text-indigo-950">
                    <div><label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Username</label><input type="text" id="userid" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-indigo-600 transition-all font-black text-indigo-950" required></div>
                    <div><label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Passkey</label><input type="password" id="password" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-indigo-600 transition-all font-black text-indigo-950" required></div>
                    <button type="submit" class="w-full bg-indigo-950 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-transform">Sign In</button>
                </form>
            </div>
        </div>

        <!-- VIEW: ADMIN PANEL -->
        <div id="view-admin" class="hidden view-section min-h-screen bg-slate-100 flex flex-col md:flex-row font-black">
            <aside class="bg-indigo-950 text-white w-full md:w-72 flex-shrink-0 md:h-screen md:sticky top-0 flex flex-col shadow-2xl text-indigo-100">
                <div class="p-8 border-b border-indigo-900 font-black text-xl flex items-center gap-3 tracking-tight uppercase"><span class="material-symbols-outlined font-black text-amber-400">dashboard</span> Portal Hub</div>
                
                <!-- Session Selector ONLY in Admin Sidebar -->
                <div class="p-6 border-b border-indigo-900 bg-indigo-900/30">
                    <label class="text-[9px] text-indigo-300 uppercase block mb-3 font-black tracking-widest">Academic Session</label>
                    <select id="admin-year-selector" onchange="admin.handleYearChange(this.value)" class="w-full bg-indigo-950 text-amber-400 border border-indigo-700 rounded-xl p-3 text-[10px] font-black uppercase outline-none cursor-pointer">
                        <option value="2023-2024">Year: 2023-24</option>
                        <option value="2024-2025" selected>Year: 2024-25</option>
                        <option value="2025-2026">Year: 2025-26</option>
                        <option value="2026-2027">Year: 2026-27</option>
                    </select>
                </div>

                <nav class="flex-1 p-6 space-y-2 overflow-y-auto text-sm font-black text-indigo-100">
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('dashboard')"><span class="material-symbols-outlined">analytics</span> Dashboard</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('admissions')"><span class="material-symbols-outlined">person_add</span> Admissions</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('students')"><span class="material-symbols-outlined">groups</span> Database</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('data_management')"><span class="material-symbols-outlined">database</span> Data Tools</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('updates_manager')"><span class="material-symbols-outlined">campaign</span> Notice Board</button>
                    <button class="admin-tab w-full text-left px-4 py-4 rounded-xl hover:bg-indigo-900 flex items-center gap-4 transition-all" onclick="admin.switchTab('blog_manager')"><span class="material-symbols-outlined">photo_library</span> Highlights</button>
                </nav>
                
                <div class="p-6 border-t border-indigo-900">
                    <button onclick="auth_manager.logout()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-red-700 transition-all uppercase text-xs tracking-widest"><span class="material-symbols-outlined">logout</span> Exit</button>
                </div>
            </aside>

            <main class="flex-1 p-6 md:p-12 overflow-x-hidden text-indigo-950 font-black">
                <div id="tab-dashboard" class="admin-content hidden space-y-10">
                    <h2 class="text-3xl font-black uppercase tracking-tighter">Performance Overview</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-indigo-600"><p class="text-[10px] text-slate-400 uppercase tracking-widest">Target Revenue</p><div class="text-2xl mt-2" id="stat-total">₹0</div></div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-green-500"><p class="text-[10px] text-slate-400 uppercase tracking-widest">Collected</p><div class="text-2xl mt-2 text-green-600" id="stat-collected">₹0</div></div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-red-500"><p class="text-[10px] text-slate-400 uppercase tracking-widest">Pending</p><div class="text-2xl mt-2 text-red-600" id="stat-pending">₹0</div></div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-amber-400"><p class="text-[10px] text-slate-400 uppercase tracking-widest">Student Count</p><div class="text-2xl mt-2 text-amber-600" id="stat-count">0</div></div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-sm h-96"><canvas id="feeChart"></canvas></div>
                </div>

                <div id="tab-admissions" class="admin-content hidden font-black text-indigo-950">
                    <h2 class="text-3xl font-black mb-10 uppercase tracking-tighter" id="admission-title">New Entry</h2>
                    <form id="admissions-form" onsubmit="admin.registerStudent(event)" class="bg-white p-10 rounded-[3rem] shadow-sm grid grid-cols-1 md:grid-cols-2 gap-8 text-sm">
                        <input type="hidden" name="editId">
                        <div class="space-y-1"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Admission ID *</label><input type="text" name="admnNo" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none focus:bg-white font-black text-indigo-950" required></div>
                        <div class="space-y-1"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Student Name *</label><input type="text" name="name" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none focus:bg-white font-black text-indigo-950" required></div>
                        <div class="space-y-1"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Class *</label><select id="admit-class-select" name="class" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none font-black text-indigo-950" required></select></div>
                        <div class="space-y-1"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Father Name</label><input type="text" name="father" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none focus:bg-white font-black text-indigo-950"></div>
                        <div class="space-y-1"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Contact No</label><input type="tel" name="contact" maxlength="10" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none focus:bg-white font-black text-indigo-950"></div>
                        <div class="grid grid-cols-2 gap-4 font-black">
                            <div class="space-y-1"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Total Fee (Target) *</label><input type="number" name="fee" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none font-black text-indigo-950" required></div>
                            <div class="space-y-1"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Old Fee (Dues) *</label><input type="number" name="oldDue" value="0" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none font-black text-indigo-950" required></div>
                        </div>
                        <div class="space-y-1" id="admit-initial-group"><label class="text-slate-400 uppercase text-[10px] font-black tracking-widest">Initial Pay *</label><input type="number" name="initialPay" value="0" class="w-full border-2 border-slate-50 p-4 rounded-2xl bg-slate-50 outline-none text-green-600 font-black text-indigo-950" required></div>
                        <div class="col-span-full flex gap-4">
                            <button type="button" id="admit-cancel-btn" class="hidden flex-1 bg-slate-200 text-indigo-950 py-5 rounded-3xl font-black uppercase text-xs" onclick="admin.cancelAdmitEdit()">Cancel</button>
                            <button type="submit" id="admit-submit-btn" class="flex-[2] bg-indigo-600 text-white py-5 rounded-3xl font-black uppercase text-xs shadow-xl transition-all">Submit Student</button>
                        </div>
                    </form>
                </div>

                <div id="tab-students" class="admin-content hidden space-y-8 font-black text-indigo-950">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6 text-indigo-950 font-black">
                        <h2 class="text-3xl font-black uppercase tracking-tighter">Student Database</h2>
                        <button onclick="printer.printMasterLedger()" class="bg-indigo-950 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-md flex items-center gap-2 text-indigo-100"><span class="material-symbols-outlined text-lg">print</span> Master ledger</button>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="record-search" placeholder="Search by name or ID..." class="flex-1 p-5 rounded-3xl border-2 border-white shadow-sm font-black outline-none focus:border-indigo-200" oninput="admin.renderStudentList()">
                        <select id="record-class-filter" class="w-48 p-5 rounded-3xl border-2 border-white shadow-sm font-black outline-none cursor-pointer" onchange="admin.renderStudentList()"></select>
                    </div>
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-x-auto text-indigo-950 font-black">
                        <table class="w-full text-left text-sm font-black text-indigo-950">
                            <thead class="bg-indigo-50 border-b">
                                <tr class="font-black uppercase text-[10px] text-indigo-950 tracking-widest">
                                    <th class="p-6 sort-header" onclick="admin.sortStudents('admnNo')">ID</th>
                                    <th class="p-6 sort-header" onclick="admin.sortStudents('name')">Student</th>
                                    <th class="p-6 sort-header" onclick="admin.sortStudents('class')">Class</th>
                                    <th class="p-6 text-right sort-header" onclick="admin.sortStudents('due')">Due</th>
                                    <th class="p-6 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y text-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-data_management" class="admin-content hidden space-y-10 font-black text-indigo-950">
                    <h2 class="text-3xl font-black uppercase tracking-tighter">Data Tools</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 space-y-8 text-center font-black">
                            <div class="flex items-center justify-center gap-3 text-emerald-600 font-black font-black"><span class="material-symbols-outlined text-4xl font-black">table_chart</span><h3 class="text-2xl font-black uppercase tracking-tight">Bulk Transfer</h3></div>
                            <div class="grid grid-cols-1 gap-4 text-indigo-950">
                                <p class="text-slate-400 text-xs px-6">Promote current session records to next year silo automatically.</p>
                                <button onclick="admin.bulkTransferStudents()" class="bg-emerald-600 text-white p-5 rounded-3xl uppercase text-[10px] font-black tracking-widest shadow-lg shadow-emerald-50">Execute Yearly Transfer</button>
                            </div>
                        </div>
                        <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 space-y-8 text-center font-black font-black">
                            <div class="flex items-center justify-center gap-3 text-indigo-600"><span class="material-symbols-outlined text-4xl font-black">data_object</span><h3 class="text-2xl font-black uppercase tracking-tight">Data Backups</h3></div>
                            <div class="grid grid-cols-1 gap-4 text-indigo-950">
                                <div class="flex gap-2">
                                    <button onclick="admin.exportJSON()" class="flex-1 bg-slate-100 p-5 rounded-3xl uppercase text-[10px] font-black tracking-widest text-indigo-950">JSON Export</button>
                                    <button onclick="document.getElementById('import-json-input').click()" class="flex-1 bg-indigo-900 text-white p-5 rounded-3xl uppercase text-[10px] font-black tracking-widest text-indigo-100">JSON Import</button>
                                </div>
                                <button onclick="admin.exportExcel()" class="bg-slate-100 p-5 rounded-3xl uppercase text-[10px] font-black tracking-widest text-indigo-950">Excel Export</button>
                                <input type="file" id="import-json-input" class="hidden" accept=".json" onchange="admin.importJSON(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-updates_manager" class="admin-content hidden grid grid-cols-1 lg:grid-cols-3 gap-12 font-black text-indigo-950">
                    <div class="lg:col-span-1 space-y-8">
                        <h2 class="text-2xl font-black uppercase tracking-tighter" id="notice-form-title">New Board Update</h2>
                        <form id="notice-form" onsubmit="admin.publishNotice(event)" class="bg-white p-8 rounded-[2rem] shadow-sm space-y-6">
                            <input type="hidden" name="noticeId">
                            <div><label class="text-[10px] text-slate-400 uppercase tracking-widest">Class</label><select id="notice-class-select" name="class" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 outline-none font-black text-indigo-950"></select></div>
                            <div><label class="text-[10px] text-slate-400 uppercase tracking-widest">Category</label>
                                <select name="category" id="notice-category-select" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1 outline-none font-black text-indigo-950">
                                    <option>Announcement</option><option>Home Work</option><option>Class Test</option><option>Upcoming Events</option><option>Holiday</option>
                                </select>
                            </div>
                            <div><label class="text-[10px] text-slate-400 uppercase tracking-widest">Subject</label>
                                <select name="subject" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1 outline-none font-black text-indigo-950">
                                    <option value="General News">General News</option><option value="Telugu">Telugu</option><option value="Hindi">Hindi</option><option value="English">English</option><option value="Mathematics">Mathematics</option><option value="Science">Science</option><option value="Social">Social</option><option value="E.V.S">E.V.S</option><option value="Computers">Computers</option>
                                </select>
                            </div>
                            <div><label class="text-[10px] text-slate-400 uppercase tracking-widest font-black">Content</label><textarea name="content" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1 h-32 focus:bg-white transition-all outline-none font-black text-slate-800" required></textarea></div>
                            <div class="flex gap-3">
                                <button type="button" id="notice-cancel-btn" class="hidden flex-1 bg-slate-100 py-4 rounded-2xl font-black uppercase text-[10px]" onclick="admin.cancelNoticeEdit()">Cancel</button>
                                <button type="submit" id="notice-submit-btn" class="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-[10px]">Publish Notice</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 space-y-8"><h2 class="text-2xl font-black uppercase tracking-tighter">Current Notices</h2><div id="admin-notices-list" class="space-y-4 font-black"></div></div>
                </div>

                <div id="tab-blog_manager" class="admin-content hidden grid grid-cols-1 lg:grid-cols-3 gap-12 font-black text-indigo-950">
                     <div class="lg:col-span-1 space-y-8">
                        <h2 class="text-2xl font-black uppercase tracking-tighter" id="highlight-form-title">Gallery Feed</h2>
                        <form id="highlight-form" onsubmit="admin.publishHighlight(event)" class="bg-white p-8 rounded-[2rem] shadow-sm space-y-6">
                            <input type="hidden" name="hId">
                            <div><label class="text-[10px] text-slate-400 uppercase tracking-widest">Caption</label><input type="text" name="title" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1 outline-none font-black text-indigo-950" required></div>
                            <div><label class="text-[10px] text-slate-400 uppercase tracking-widest">Type</label><select name="type" class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1 outline-none font-black text-indigo-950"><option value="image">Image URL</option><option value="youtube">YouTube ID</option></select></div>
                            <div><label class="text-[10px] text-slate-400 uppercase tracking-widest">URL Address</label><input type="text" name="url" placeholder="https://..." class="w-full border-2 border-slate-50 p-4 rounded-xl bg-slate-50 mt-1 outline-none font-black text-indigo-950" required></div>
                            <div class="flex gap-3">
                                <button type="button" id="highlight-cancel-btn" class="hidden flex-1 bg-slate-100 py-4 rounded-2xl font-black uppercase text-[10px]" onclick="admin.cancelHighlightEdit()">Cancel</button>
                                <button type="submit" id="highlight-submit-btn" class="flex-[2] bg-orange-600 text-white py-4 rounded-2xl font-black uppercase text-[10px]">Post Highlight</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 space-y-8"><h2 class="text-2xl font-black uppercase tracking-tighter">Live Gallery</h2><div id="admin-highlights-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div></div>
                </div>
            </main>
        </div>

        <!-- MODAL: PROFILE -->
        <div id="student-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[2.5rem] overflow-hidden flex flex-col shadow-2xl text-indigo-950 font-black">
                <div class="p-8 bg-indigo-950 text-white flex justify-between items-center text-indigo-100 font-black">
                    <h2 id="modal-name" class="text-2xl font-black uppercase tracking-tighter"></h2>
                    <button onclick="admin.closeModal()" class="text-4xl hover:text-amber-400 transition-colors font-black">&times;</button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 bg-slate-50 grid grid-cols-1 lg:grid-cols-3 gap-8 text-sm text-indigo-950 font-black">
                    <div class="space-y-6">
                        <div class="bg-white p-8 rounded-3xl shadow-sm space-y-4 font-black border border-indigo-50">
                            <p class="text-[10px] text-slate-400 uppercase tracking-widest font-black">Profile Snapshot</p>
                            <p>Class: <span id="modal-class" class="text-indigo-600"></span></p>
                            <p>Parent: <span id="modal-father"></span></p>
                            <p>Mobile: <span id="modal-contact"></span></p>
                            <p class="text-2xl text-red-600 tracking-tighter uppercase mt-4 font-black">Due Balance: <span id="modal-balance"></span></p>
                        </div>
                        <div class="space-y-2">
                             <button onclick="admin.promoteToNextYear()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl uppercase text-[10px] font-black shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-base">forward_5</span> Transfer to Next Year
                            </button>
                            <button onclick="admin.initiateAdmitEdit()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl uppercase text-[10px] font-black shadow-lg shadow-indigo-100">Edit Details</button>
                            <button onclick="printer.printLedger()" class="w-full bg-white border-2 border-slate-200 py-4 rounded-2xl hover:bg-slate-100 transition-all uppercase text-[10px] font-black text-indigo-950">Print Record</button>
                            <button onclick="admin.initiateSecureDelete()" class="w-full text-red-600 text-[10px] uppercase py-2 hover:underline font-black opacity-60">Permanently Delete</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <form onsubmit="admin.recordPayment(event)" class="bg-white p-10 rounded-[2rem] shadow-sm grid grid-cols-2 gap-6 border-2 border-emerald-50 font-black text-indigo-950 font-black">
                            <div class="col-span-2 text-[10px] uppercase text-slate-400 tracking-widest text-indigo-950 font-black">Register Payment</div>
                            <input type="number" id="pay-amt" placeholder="Amount (₹)" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 font-black text-2xl focus:bg-white outline-none" required>
                            <input type="date" id="pay-date" class="border-2 border-slate-50 p-4 rounded-xl bg-slate-50 focus:bg-white outline-none" required>
                            <input type="text" id="pay-remark" placeholder="Note (Receipt #)" class="col-span-2 border-2 border-slate-50 p-4 rounded-xl bg-slate-50 focus:bg-white outline-none">
                            <button type="submit" class="col-span-2 bg-green-600 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-green-700 transition-all shadow-lg text-indigo-100">Confirm Payment</button>
                        </form>
                        
                        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100">
                            <div class="p-4 bg-slate-50 flex justify-between items-center text-indigo-950 font-black">
                                <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 font-black">Transaction History</span>
                                <div class="flex gap-2 items-center">
                                    <input type="date" id="history-start" class="text-[10px] border rounded px-1 outline-none font-black text-indigo-950" onchange="admin.renderHistory()">
                                    <span class="text-[10px] text-slate-300">to</span>
                                    <input type="date" id="history-end" class="text-[10px] border rounded px-1 outline-none font-black text-indigo-950" onchange="admin.renderHistory()">
                                    <button class="material-symbols-outlined text-indigo-400 text-sm" onclick="admin.resetHistoryFilter()">close</button>
                                </div>
                            </div>
                            <table class="w-full text-left text-sm font-black text-indigo-950"><tbody id="modal-history" class="divide-y text-slate-700 font-black text-indigo-950 font-black"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECURE PIN MODAL -->
        <div id="delete-pin-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-80 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-xs p-10 rounded-[3rem] shadow-2xl text-center text-indigo-950 font-black">
                <span class="material-symbols-outlined text-red-600 text-7xl mb-4 font-black">lock_reset</span>
                <h3 class="text-xl font-black mb-1 uppercase tracking-tight">Security Code</h3>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-8">Authorized Access Required</p>
                <input type="password" id="delete-pin-input" class="w-full border-2 border-slate-100 p-5 rounded-3xl text-center font-black text-4xl mb-8 focus:border-red-600 outline-none text-indigo-950" placeholder="••••">
                <div class="flex gap-4">
                    <button onclick="admin.closeDeleteModal()" class="flex-1 py-4 bg-slate-100 rounded-2xl font-black text-[10px] uppercase text-indigo-950">Cancel</button>
                    <button id="pin-verify-btn" onclick="admin.executeSecureDelete()" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg text-indigo-50">Verify</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINTING -->
    <div id="printable-area"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Reliable hardcoded config
        const firebaseConfig = {
            apiKey: "AIzaSyCTBCeLms5kGsf966PB25I4H75i8BBxma0",
            authDomain: "sri-sai-vidyalayam-9a21e.firebaseapp.com",
            projectId: "sri-sai-vidyalayam-9a21e",
            storageBucket: "sri-sai-vidyalayam-9a21e.firebasestorage.app",
            messagingSenderId: "167964825322",
            appId: "1:167964825322:web:7d22c335f98dc468fda993",
            measurementId: "G-H28D1GK0HS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sri-sai-v-portal';

        window.state = {
            user: null, students: [], notices: [], highlights: [],
            activeStudentId: null, isLoggedIn: false,
            sort: { key: 'name', dir: 'asc' },
            selectedClass: 'All', 
            selectedYear: '2024-2025',
            sessionLastSeen: Date.now(),
            popupTimeout: null,
            admissionsPopupDismissed: false,
            classes: ["Nursery", "LKG", "UKG", "1st Class", "2nd Class", "3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"]
        };

        let unsubscribes = [];

        window.toggleMobileMenu = () => document.getElementById('mobile-menu').classList.toggle('hidden');

        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'bg-red-600' : 'bg-indigo-950'}`;
            toast.innerHTML = `<span class="material-symbols-outlined">${type === 'error' ? 'error' : 'info'}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        const initAuth = async (retryCount = 0) => {
            try { 
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth); 
                }
            } catch (err) { 
                if (retryCount < 5) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    return new Promise(resolve => setTimeout(() => resolve(initAuth(retryCount + 1)), delay));
                }
            }
        };

        onAuthStateChanged(auth, async (u) => {
            state.user = u;
            if (u) {
                startSync();
            } else {
                initAuth(); 
            }
            if (!document.querySelector('.view-section:not(.hidden)')) router.navigate('home');
        });

        const startSync = () => {
            if (!state.user) return;
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];

            // Siloed paths by collection name (Rule 1 compliant)
            const yearKey = state.selectedYear.replace('-', '_');
            const studentsRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`);
            const noticesRef = collection(db, 'artifacts', appId, 'public', 'data', `notices_${yearKey}`);
            const highlightsRef = collection(db, 'artifacts', appId, 'public', 'data', 'highlights');

            unsubscribes.push(onSnapshot(studentsRef, (snap) => {
                state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                admin.renderStudentList();
                admin.updateDashboard(); 
                if (state.activeStudentId) admin.refreshModalContent();
            }));

            unsubscribes.push(onSnapshot(noticesRef, (snap) => {
                state.notices = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp);
                home.renderUpdates(); 
                admin.renderNotices();
                home.renderHomeNotices();
                home.updateNavBadge();
                home.updateHomeFilterNotifications();
            }));

            unsubscribes.push(onSnapshot(highlightsRef, (snap) => {
                state.highlights = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                home.renderHighlights(); 
                admin.renderHighlights();
            }));
        };

        window.router = {
            navigate: (view) => {
                if (state.popupTimeout) clearTimeout(state.popupTimeout);
                if (view === 'admin' || view === 'login') {
                    const popup = document.getElementById('admissions-popup');
                    if (popup) popup.classList.add('hidden-modal');
                }
                document.querySelectorAll('.view-section').forEach(el => { el.classList.add('hidden'); el.style.display = 'none'; });
                const target = document.querySelector(`#view-${view}`);
                if (target) {
                    target.classList.remove('hidden');
                    target.style.display = (view === 'login' || view === 'admin') ? 'flex' : 'block';
                }
                if (view === 'home') home.init();
                if (view === 'updates') home.initUpdatesBoard();
                if (view === 'admin') admin.init();
                window.scrollTo(0,0);
            }
        };

        window.auth_manager = {
            login: (e) => {
                e.preventDefault();
                const card = document.getElementById('login-card');
                if (document.getElementById('userid').value === 'admin' && document.getElementById('password').value === '123') {
                    state.isLoggedIn = true; 
                    router.navigate('admin');
                    showToast("Login Successful", "success");
                } else {
                    if (card) {
                        card.classList.add('shake-element');
                        setTimeout(() => card.classList.remove('shake-element'), 500);
                    }
                    showToast("Invalid Credentials", "error");
                }
            },
            logout: () => { 
                state.isLoggedIn = false; 
                router.navigate('home'); 
                showToast("Admin session ended");
            }
        };

        window.home = {
            init: () => {
                home.startHeroSlider();
                home.renderHomeNotices();
                home.initHomeFilter();
                if (!state.admissionsPopupDismissed) {
                    state.popupTimeout = setTimeout(() => {
                        const popup = document.getElementById('admissions-popup');
                        const homeView = document.getElementById('view-home');
                        if (popup && homeView && homeView.style.display !== 'none') {
                            popup.classList.remove('hidden-modal');
                        }
                    }, 3000); 
                }
            },
            initHomeFilter: () => {
                const filter = document.getElementById('home-class-filter');
                if (filter) {
                    home.updateHomeFilterNotifications();
                    filter.value = state.selectedClass;
                }
            },
            updateHomeFilterNotifications: () => {
                const filter = document.getElementById('home-class-filter');
                if (!filter) return;
                let anyUnread = false;
                filter.innerHTML = '<option value="All">Select Class...</option>' + state.classes.map(c => {
                    const classHasNew = state.notices.some(n => (n.class === c || n.class === 'All') && n.timestamp > state.sessionLastSeen);
                    if (classHasNew) anyUnread = true;
                    return `<option value="${c}" style="color: ${classHasNew ? '#dc2626' : 'inherit'}; font-weight: 900; text-transform: uppercase;">${c}${classHasNew ? ' • [NEW]' : ''}</option>`;
                }).join('');
                const badge = document.getElementById('home-filter-badge');
                if (badge) badge.classList.toggle('hidden', !anyUnread);
                filter.value = state.selectedClass;
            },
            initUpdatesBoard: () => {
                const filter = document.getElementById('board-class-filter');
                if(filter) {
                    filter.innerHTML = '<option value="All">All Grades (View Full Board)</option>' + state.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                    filter.value = state.selectedClass;
                }
                state.sessionLastSeen = Date.now();
                home.updateNavBadge();
                home.updateHomeFilterNotifications();
                home.renderUpdates();
            },
            updateNavBadge: () => {
                const newCount = state.notices.filter(n => n.timestamp > state.sessionLastSeen).length;
                const badge = document.getElementById('nav-updates-badge');
                const mobileBadge = document.getElementById('mobile-updates-badge');
                if (badge) { badge.innerText = newCount; badge.classList.toggle('hidden', newCount === 0); }
                if (mobileBadge) { mobileBadge.innerText = newCount; mobileBadge.classList.toggle('hidden', newCount === 0); }
            },
            handleClassChange: (val) => {
                state.selectedClass = val;
                const label = document.getElementById('board-selected-label');
                if (label) label.innerText = val === 'All' ? 'Showing all Grades' : `Showing notices for ${val}`;
                home.renderUpdates();
                home.renderHomeNotices();
                document.querySelectorAll('#home-class-filter, #board-class-filter').forEach(s => s.value = val);
            },
            closeAdmissionsPopup: () => {
                const popup = document.getElementById('admissions-popup');
                if (popup) popup.classList.add('hidden-modal');
                state.admissionsPopupDismissed = true;
            },
            startHeroSlider: () => {
                let current = 0; const slides = document.querySelectorAll('#hero-text-slider .slide');
                if(window.heroInterval) clearInterval(window.heroInterval);
                window.heroInterval = setInterval(() => {
                    if(!slides.length) return; slides[current].classList.remove('active');
                    current = (current + 1) % slides.length; slides[current].classList.add('active');
                }, 4500);
            },
            renderHomeNotices: () => {
                const container = document.getElementById('home-notices-preview');
                if (!container) return;
                if (state.selectedClass === 'All') {
                    container.innerHTML = `<div class="col-span-full text-center py-16"><div class="max-w-md mx-auto bg-white p-10 rounded-[3rem] shadow-sm border-2 border-dashed border-indigo-100 text-indigo-950 font-black"><span class="material-symbols-outlined text-indigo-200 text-6xl mb-4">school</span><p class="text-slate-400 font-black">Please select a class above to see updates.</p></div></div>`;
                    return;
                }
                const filtered = state.notices.filter(n => n.class === state.selectedClass || n.class === 'All').slice(0, 6);
                container.innerHTML = filtered.map(n => {
                    let colorClass = 'border-indigo-600';
                    if (n.category === 'Home Work') colorClass = 'border-emerald-500';
                    if (n.category === 'Class Test') colorClass = 'border-amber-500';
                    if (n.category === 'Upcoming Events') colorClass = 'border-orange-600';
                    const isNew = n.timestamp > state.sessionLastSeen;
                    return `<div class="bg-white p-8 rounded-[2.5rem] shadow-sm border-l-8 ${colorClass} hover:shadow-lg transition-all group relative overflow-hidden text-indigo-950 font-black">
                            ${isNew ? `<div class="absolute top-2 right-2 bg-red-600 text-white text-[8px] font-black px-2 py-1 rounded-bl-xl uppercase animate-pulse z-20">NEW</div>` : ''}
                            <div class="flex justify-between items-center mb-4">
                                <span class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full font-black uppercase text-[9px] tracking-tighter flex items-center">${n.class} ${isNew ? '<span class="notify-dot animate-ping ml-2 bg-red-600"></span>' : ''}</span>
                                <span class="text-[9px] font-black uppercase text-slate-300 tracking-widest">${new Date(n.timestamp).toLocaleDateString()}</span>
                            </div>
                            <h4 class="text-indigo-600 font-black uppercase text-[10px] tracking-widest mb-1">${n.category}</h4>
                            <p class="text-slate-700 font-bold line-clamp-3 text-sm leading-relaxed">${n.content}</p>
                        </div>`;
                }).join('') || '<div class="col-span-full text-center py-10 opacity-30 italic font-black text-indigo-950">No recent announcements for this class.</div>';
            },
            renderHighlights: () => {
                const track = document.getElementById('blog-posts-feed');
                if(!track) return;
                track.innerHTML = state.highlights.map(h => `<div class="blog-slide text-indigo-950 font-black"><div class="bg-white p-8 rounded-[3rem] shadow-xl border border-indigo-50 text-indigo-950 font-black">${h.type === 'youtube' ? `<div class="video-container" onclick="home.playVideo('${h.id}', '${h.url}')" id="vid-${h.id}"><div class="absolute inset-0 flex items-center justify-center bg-black/30 text-white transition-all hover:bg-black/10"><span class="material-symbols-outlined text-7xl font-black">play_circle</span></div></div>` : `<img src="${h.url}" class="w-full h-64 md:h-96 object-cover rounded-[2rem] shadow-inner bg-slate-50">`}<div class="mt-8 text-left"><h3 class="text-2xl uppercase tracking-tight font-black">${h.title}</h3></div></div></div>`).join('') || '<div class="w-full py-10 opacity-30 font-black text-center italic font-black text-indigo-950">No highlights found.</div>';
                state.blogIndex = 0; home.updateSlider();
            },
            playVideo: (id, url) => { const yId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop(); document.getElementById(`vid-${id}`).innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${yId}?autoplay=1" frameborder="0" allowfullscreen></iframe>`; },
            nextBlog: () => { if(state.highlights.length > 1) { state.blogIndex = (state.blogIndex + 1) % state.highlights.length; home.updateSlider(); } },
            prevBlog: () => { if(state.highlights.length > 1) { state.blogIndex = (state.blogIndex - 1 + state.highlights.length) % state.highlights.length; home.updateSlider(); } },
            updateSlider: () => { const track = document.getElementById('blog-posts-feed'); if(track) track.style.transform = `translateX(-${state.blogIndex * 100}%)`; },
            renderUpdates: () => {
                const list = document.getElementById('board-updates-list');
                if(!list) return;
                const filtered = state.notices.filter(n => state.selectedClass === 'All' || n.class === state.selectedClass || n.class === 'All');
                list.innerHTML = filtered.map(n => {
                    let colorClass = 'border-indigo-600';
                    if (n.category === 'Home Work') colorClass = 'border-emerald-500';
                    if (n.category === 'Class Test') colorClass = 'border-amber-500';
                    if (n.category === 'Upcoming Events') colorClass = 'border-orange-600';
                    if (n.category === 'Holiday') colorClass = 'border-red-500';
                    const isNew = n.timestamp > state.sessionLastSeen;
                    return `<div class="bg-white p-10 rounded-[2.5rem] shadow-sm border-l-[12px] ${colorClass} hover:shadow-xl transition-all h-full flex flex-col group relative overflow-hidden text-indigo-950 font-black">${isNew ? `<div class="absolute top-2 right-2 bg-red-600 text-white text-[9px] font-black px-3 py-1 rounded-bl-2xl shadow-sm animate-pulse z-10">NEW UPDATE</div>` : ''}<div class="flex justify-between items-start mb-6"><div class="flex flex-col"><span class="text-[9px] uppercase text-slate-400 font-black">${new Date(n.timestamp).toLocaleDateString()}</span><span class="inline-block mt-1 px-3 py-1 bg-slate-100 text-slate-600 text-[10px] font-black uppercase rounded-full tracking-tighter">${n.category}</span></div><span class="bg-indigo-50 text-indigo-700 px-4 py-1.5 rounded-full font-black uppercase tracking-tighter text-xs">${n.class}</span></div><h4 class="text-indigo-600 font-black uppercase text-xs tracking-widest mb-2">${n.subject && n.subject !== 'General News' ? n.subject : 'Notice'}</h4><p class="text-slate-800 text-xl leading-relaxed font-black flex-1 font-black">${n.content}</p></div>`;
                }).join('') || '<div class="col-span-full text-center py-32 font-black text-indigo-950"><div class="bg-indigo-50 inline-block p-10 rounded-[3rem] border border-indigo-100 font-black text-indigo-950 font-black"><span class="material-symbols-outlined text-indigo-300 text-6xl mb-4">notifications_off</span><p class="text-slate-400 font-black italic">No records found for this year.</p></div></div>';
            }
        };

        window.admin = {
            init: () => {
                const selects = document.querySelectorAll('#admit-class-select, #record-class-filter, #notice-class-select');
                selects.forEach(s => {
                    const isFilterOrNotice = s.id.includes('filter') || s.id.includes('notice');
                    s.innerHTML = (isFilterOrNotice ? '<option value="All">All Grades (Select)</option>' : '') + state.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                });
                admin.switchTab('dashboard'); 
            },
            handleYearChange: (val) => {
                state.selectedYear = val;
                const adminSel = document.getElementById('admin-year-selector');
                if (adminSel) adminSel.value = val;
                startSync();
                admin.renderStudentList();
                admin.updateDashboard();
                showToast(`Session switched to ${val}`, "success");
            },
            switchTab: (tabId) => {
                document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.toggle('bg-indigo-900', btn.onclick.toString().includes(tabId)));
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`tab-${tabId}`);
                if(target) target.classList.remove('hidden');
                
                if (tabId === 'students') admin.renderStudentList();
                if (tabId === 'updates_manager') admin.renderNotices();
                if (tabId === 'blog_manager') admin.renderHighlights();
                if (tabId === 'dashboard') admin.updateDashboard();
            },
            updateDashboard: () => {
                let total = 0, collected = 0;
                state.students.forEach(s => { 
                    total += (parseFloat(s.fee || s.Target_Fee || 0)) + (parseFloat(s.oldDue || s.Previous_Dues || 0)); 
                    collected += (parseFloat(s.paid || s.Total_Paid || 0)); 
                });
                const stats = { 'stat-total': total, 'stat-collected': collected, 'stat-pending': (total - collected), 'stat-count': state.students.length };
                for (let id in stats) {
                    const el = document.getElementById(id);
                    if (el) el.innerText = id.includes('count') ? stats[id] : `₹${stats[id].toLocaleString()}`;
                }
                const ctx = document.getElementById('feeChart')?.getContext('2d');
                if(!ctx) return; if(window.dashChart) window.dashChart.destroy();
                window.dashChart = new Chart(ctx, { type: 'bar', data: { labels: ['Target', 'Revenue', 'Due'], datasets: [{ data: [total, collected, total - collected], backgroundColor: ['#312e81', '#10b981', '#ef4444'], borderRadius: 12 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            },
            registerStudent: async (e) => {
                e.preventDefault(); if (!state.user) return;
                const fd = new FormData(e.target);
                const editId = fd.get('editId');
                const btn = document.getElementById('admit-submit-btn');
                btn.disabled = true; btn.innerText = "Syncing...";
                
                const data = { 
                    admnNo: fd.get('admnNo'), 
                    name: fd.get('name'), 
                    class: fd.get('class'), 
                    father: fd.get('father') || '', 
                    contact: fd.get('contact') || '', 
                    fee: parseFloat(fd.get('fee') || 0), 
                    oldDue: parseFloat(fd.get('oldDue') || 0),
                    initialPay: parseFloat(fd.get('initialPay') || 0)
                };

                try {
                    const yearKey = state.selectedYear.replace('-', '_');
                    const studentsRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`);
                    if (editId) { 
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`, editId), data); 
                        admin.cancelAdmitEdit(); 
                        showToast("Record Updated");
                    } else { 
                        const newData = { ...data, paid: data.initialPay, history: data.initialPay > 0 ? [{ amount: data.initialPay, timestamp: Date.now(), remark: 'Initial Enrollment' }] : [], timestamp: Date.now() }; 
                        await addDoc(studentsRef, newData); 
                        showToast("Student Registered Successfully", "success");
                    }
                    admin.switchTab('students'); e.target.reset();
                } catch(err) { showToast("Save failed.", "error"); } finally { btn.disabled = false; btn.innerText = "Submit Student"; }
            },
            bulkTransferStudents: async () => {
                if (!state.user || state.students.length === 0) return showToast("No students to transfer", "error");
                const fromYear = state.selectedYear;
                const parts = fromYear.split('-');
                const nextYear = `${parseInt(parts[0])+1}-${parseInt(parts[1])+1}`;
                const nextYearKey = nextYear.replace('-', '_');
                
                if (!confirm(`Promote ${state.students.length} students to ${nextYear}?`)) return;
                
                showToast("Starting bulk transfer...");
                try {
                    const targetRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${nextYearKey}`);
                    for (const s of state.students) {
                        const currentClass = s.class || s.Grade || 'Nursery';
                        const currentIdx = state.classes.indexOf(currentClass);
                        const nextClass = state.classes[currentIdx + 1] || "Passed Out";
                        
                        const newData = {
                            admnNo: s.admnNo || s.ID || s.Admission_No,
                            name: s.name || s.Student,
                            class: nextClass,
                            father: s.father || s.Parent || '',
                            contact: s.contact || '',
                            fee: s.fee || s.Target_Fee || 0,
                            oldDue: 0,
                            paid: 0,
                            history: [],
                            timestamp: Date.now()
                        };
                        await addDoc(targetRef, newData);
                    }
                    showToast(`Migration to ${nextYear} complete`, "success");
                } catch (e) {
                    showToast("Transfer failed", "error");
                }
            },
            initiateAdmitEdit: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                if (!s) return;
                admin.closeModal(); admin.switchTab('admissions');
                const form = document.getElementById('admissions-form');
                form.editId.value = s.id; 
                form.admnNo.value = s.admnNo || s.ID || s.Admission_No || ''; 
                form.name.value = s.name || s.Student || ''; 
                form.class.value = s.class || s.Grade || ''; 
                form.father.value = s.father || s.Parent || ''; 
                form.contact.value = s.contact || ''; 
                form.fee.value = s.fee || s.Target_Fee || 0; 
                form.oldDue.value = s.oldDue || s.Previous_Dues || s.old_fee || 0;
                document.getElementById('admission-title').innerText = "Update Record";
                document.getElementById('admit-submit-btn').innerText = "Save Changes";
                document.getElementById('admit-initial-group').style.display = 'none';
                document.getElementById('admit-cancel-btn').classList.remove('hidden');
            },
            promoteToNextYear: async () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                if (!s) return;
                const currentIdx = state.classes.indexOf(s.class || s.Grade);
                const nextYear = state.selectedYear.split('-').map(y => parseInt(y) + 1).join('-');
                const nextClass = state.classes[currentIdx + 1] || "Passed Out";
                if (nextClass === "Passed Out") { showToast("Student has completed 10th Class", "info"); return; }
                try {
                    const nextYearKey = nextYear.replace('-', '_');
                    const nextYearRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${nextYearKey}`);
                    const newData = { admnNo: s.admnNo || s.ID, name: s.name || s.Student, class: nextClass, father: s.father || s.Parent, contact: s.contact || '', fee: s.fee || s.Target_Fee || 0, oldDue: 0, paid: 0, history: [], timestamp: Date.now() };
                    await addDoc(nextYearRef, newData);
                    showToast(`${s.name} promoted to ${nextClass}`, "success");
                    admin.closeModal();
                } catch (e) { showToast("Transfer failed.", "error"); }
            },
            cancelAdmitEdit: () => {
                const form = document.getElementById('admissions-form');
                if (form) { form.reset(); form.editId.value = ""; }
                document.getElementById('admission-title').innerText = "New Entry";
                document.getElementById('admit-submit-btn').innerText = "Submit Student";
                document.getElementById('admit-initial-group').style.display = 'block';
                document.getElementById('admit-cancel-btn').classList.add('hidden');
            },
            sortStudents: (key) => {
                if (state.sort.key === key) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
                else { state.sort.key = key; state.sort.dir = 'asc'; }
                admin.renderStudentList();
            },
            renderStudentList: () => {
                const body = document.getElementById('student-list-body');
                if(!body) return;
                const search = document.getElementById('record-search').value.toLowerCase();
                const filter = document.getElementById('record-class-filter').value || 'All';
                
                let filtered = state.students.filter(s => {
                    const sClass = s.class || s.Grade || 'Nursery';
                    const sName = String(s.name || s.Student || '').toLowerCase();
                    const sId = String(s.admnNo || s.ID || s.Admission_No || '').toLowerCase();
                    return (filter === 'All' || sClass === filter) && (sName.includes(search) || sId.includes(search));
                });

                filtered.sort((a, b) => {
                    let valA = a[state.sort.key] || ''; let valB = b[state.sort.key] || '';
                    if (state.sort.key === 'due') {
                        valA = (parseFloat(a.fee || a.Target_Fee || 0) + (parseFloat(a.oldDue || a.Previous_Dues || 0))) - (parseFloat(a.paid || a.Total_Paid || 0));
                        valB = (parseFloat(b.fee || b.Target_Fee || 0) + (parseFloat(b.oldDue || b.Previous_Dues || 0))) - (parseFloat(b.paid || b.Total_Paid || 0));
                    }
                    if (valA < valB) return state.sort.dir === 'asc' ? -1 : 1;
                    if (valA > valB) return state.sort.dir === 'asc' ? 1 : -1;
                    return 0;
                });
                body.innerHTML = filtered.map(s => {
                    const sId = s.admnNo || s.ID || s.Admission_No || '???';
                    const sName = s.name || s.Student || 'Unknown';
                    const sClass = s.class || s.Grade || 'Nursery';
                    const sDue = (parseFloat(s.fee || s.Target_Fee || 0) + (parseFloat(s.oldDue || s.Previous_Dues || 0))) - (parseFloat(s.paid || s.Total_Paid || 0));
                    return `
                    <tr class="hover:bg-indigo-50/50 cursor-pointer transition-colors border-b text-indigo-950 font-black">
                        <td class="p-6 font-mono text-[10px] text-slate-400" onclick="admin.openModal('${s.id}')">${sId}</td>
                        <td class="p-6 uppercase" onclick="admin.openModal('${s.id}')">${sName}</td>
                        <td class="p-6 text-slate-500" onclick="admin.openModal('${s.id}')">${sClass}</td>
                        <td class="p-6 text-right text-red-600" onclick="admin.openModal('${s.id}')">₹${sDue.toLocaleString()}</td>
                        <td class="p-6 text-right">
                            <button onclick="admin.requestDirectDelete('${s.id}')" class="text-slate-300 hover:text-red-600 transition-colors p-2"><span class="material-symbols-outlined text-base">delete</span></button>
                        </td>
                    </tr>
                `; }).join('') || '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic font-black text-indigo-950 font-black">No matching records found.</td></tr>';
            },
            requestDirectDelete: (id) => {
                state.activeStudentId = id;
                document.getElementById('delete-pin-input').value = '';
                document.getElementById('delete-pin-modal').classList.remove('hidden-modal');
            },
            openModal: (id) => {
                state.activeStudentId = id; admin.refreshModalContent();
                document.getElementById('student-modal').classList.remove('hidden-modal'); 
                document.getElementById('pay-date').valueAsDate = new Date();
            },
            refreshModalContent: () => {
                if (!state.activeStudentId) return;
                const s = state.students.find(x => x.id === state.activeStudentId); 
                if(!s) { admin.closeModal(); return; }
                const sDue = (parseFloat(s.fee || s.Target_Fee || 0) + (parseFloat(s.oldDue || s.Previous_Dues || 0))) - (parseFloat(s.paid || s.Total_Paid || 0));
                document.getElementById('modal-name').innerText = s.name || s.Student || 'Unnamed'; 
                document.getElementById('modal-class').innerText = s.class || s.Grade || 'Nursery';
                document.getElementById('modal-father').innerText = s.father || s.Parent || '---'; 
                document.getElementById('modal-contact').innerText = s.contact || '---';
                document.getElementById('modal-balance').innerText = `₹${sDue.toLocaleString()}`;
                const slipArea = document.getElementById('modal-slip-area');
                if (slipArea) slipArea.classList.toggle('hidden', !s.concessionSlip);
                admin.renderHistory();
            },
            resetHistoryFilter: () => {
                document.getElementById('history-start').value = ""; document.getElementById('history-end').value = "";
                admin.renderHistory();
            },
            renderHistory: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                if (!s) return;
                const start = document.getElementById('history-start').valueAsNumber;
                const end = document.getElementById('history-end').valueAsNumber;
                let hist = s.history || [];
                if(start && end) hist = hist.filter(h => h.timestamp >= start && h.timestamp <= (end + 86400000));
                const tableBody = document.getElementById('modal-history');
                if (tableBody) {
                    tableBody.innerHTML = hist.map(h => `<tr class="border-b"><td class="p-4 text-slate-400 text-xs">${new Date(h.timestamp).toLocaleDateString()}</td><td class="p-4 font-black text-indigo-950">${h.remark || 'Fee Payment'}</td><td class="p-4 text-right text-green-600 font-black">₹${parseFloat(h.amount).toLocaleString()}</td><td class="p-4 text-right"><button onclick="printer.printReceipt('${h.timestamp}')"><span class="material-symbols-outlined text-indigo-900">print</span></button></td></tr>`).reverse().join('') || '<tr><td colspan="4" class="p-6 text-center text-slate-300 italic">No historical records found.</td></tr>';
                }
            },
            closeModal: () => { document.getElementById('student-modal').classList.add('hidden-modal'); state.activeStudentId = null; },
            recordPayment: async (e) => {
                e.preventDefault(); if (!state.user) return;
                const amtEl = document.getElementById('pay-amt');
                const dateEl = document.getElementById('pay-date');
                const remarkEl = document.getElementById('pay-remark');
                const amt = parseFloat(amtEl.value); const dateVal = dateEl.value;
                const s = state.students.find(x => x.id === state.activeStudentId);
                if(!s || isNaN(amt)) return;
                const ts = dateVal ? new Date(dateVal).getTime() : Date.now();
                const currentPaid = parseFloat(s.paid || s.Total_Paid || 0);
                const newPaid = currentPaid + amt;
                const newHistory = [...(s.history || []), { amount: amt, timestamp: ts, remark: remarkEl.value }];
                try { 
                    const yearKey = state.selectedYear.replace('-', '_');
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`, s.id), { paid: newPaid, history: newHistory }); 
                    showToast(`Payment of ₹${amt} registered`, "success");
                    amtEl.value = ''; remarkEl.value = ''; 
                } catch (err) { showToast("Save error", "error"); }
            },
            publishNotice: async (e) => {
                e.preventDefault(); if (!state.user) return;
                const fd = new FormData(e.target);
                const nid = fd.get('noticeId');
                const data = { class: fd.get('class'), subject: fd.get('subject'), category: fd.get('category'), content: fd.get('content'), timestamp: Date.now() };
                try {
                    const yearKey = state.selectedYear.replace('-', '_');
                    const noticesRef = collection(db, 'artifacts', appId, 'public', 'data', `notices_${yearKey}`);
                    if (nid) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `notices_${yearKey}`, nid), data);
                    else await addDoc(noticesRef, data);
                    showToast("Notice published", "success");
                    const currentClass = fd.get('class'); const currentCat = fd.get('category');
                    admin.cancelNoticeEdit();
                    const form = document.getElementById('notice-form');
                    if (form) { form.class.value = currentClass; form.category.value = currentCat; }
                } catch(e) { showToast("Publish error", "error"); }
            },
            initiateNoticeEdit: (id) => {
                const n = state.notices.find(x => x.id === id); if(!n) return;
                const form = document.getElementById('notice-form');
                form.noticeId.value = n.id; form.class.value = n.class; form.category.value = n.category; form.subject.value = n.subject; form.content.value = n.content;
                document.getElementById('notice-form-title').innerText = "Edit Board Update";
                document.getElementById('notice-submit-btn').innerText = "Update";
                document.getElementById('notice-cancel-btn').classList.remove('hidden');
            },
            cancelNoticeEdit: () => {
                const form = document.getElementById('notice-form');
                const previousClass = form ? form.class.value : null; const previousCat = form ? form.category.value : null;
                if (form) { form.reset(); form.noticeId.value = ""; if (previousClass) form.class.value = previousClass; if (previousCat) form.category.value = previousCat; }
                document.getElementById('notice-form-title').innerText = "New Notice";
                document.getElementById('notice-submit-btn').innerText = "Publish Notice";
                document.getElementById('notice-cancel-btn').classList.add('hidden');
            },
            renderNotices: () => {
                const list = document.getElementById('admin-notices-list');
                if(!list) return;
                list.innerHTML = state.notices.map(n => `<div class="bg-white p-5 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50 group hover:shadow-md transition-shadow text-indigo-950 font-black font-black"><div class="flex-1"><div class="text-[9px] uppercase font-black text-indigo-400 tracking-tighter">${n.class} • ${n.category} ${n.subject !== 'General News' ? '• ' + n.subject : ''}</div><div class="text-indigo-950 font-bold">${n.content.substring(0,100)}...</div></div><div class="flex gap-4 ml-6"><button onclick="admin.initiateNoticeEdit('${n.id}')" class="text-indigo-400 hover:text-indigo-600 transition-colors"><span class="material-symbols-outlined text-xl">edit_note</span></button><button onclick="admin.deleteNotice('${n.id}')" class="text-slate-300 hover:text-red-600 transition-colors"><span class="material-symbols-outlined text-xl">delete_sweep</span></button></div></div>`).join('') || '<div class="text-slate-300 py-10 text-center italic font-black">No active notices.</div>';
            },
            deleteNotice: async (id) => { 
                if (!state.user) return; 
                const yearKey = state.selectedYear.replace('-', '_');
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `notices_${yearKey}`, id)); 
                showToast("Notice deleted");
            },
            publishHighlight: async (e) => {
                e.preventDefault(); if (!state.user) return;
                const fd = new FormData(e.target); const hid = fd.get('hId');
                const data = { title: fd.get('title'), type: fd.get('type'), url: fd.get('url') };
                try { if (hid) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'highlights', hid), data); else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'highlights'), data); admin.cancelHighlightEdit(); showToast("Gallery updated"); } catch(e) { showToast("Error saving highlight", "error"); }
            },
            initiateHighlightEdit: (id) => {
                const h = state.highlights.find(x => x.id === id); if(!h) return;
                const form = document.getElementById('highlight-form');
                form.hId.value = h.id; form.title.value = h.title; form.type.value = h.type; form.url.value = h.url;
                document.getElementById('highlight-form-title').innerText = "Edit Highlight"; document.getElementById('highlight-submit-btn').innerText = "Update";
                document.getElementById('highlight-cancel-btn').classList.remove('hidden');
            },
            cancelHighlightEdit: () => {
                const form = document.getElementById('highlight-form'); if (form) { form.reset(); form.hId.value = ""; }
                document.getElementById('highlight-form-title').innerText = "Gallery Feed"; document.getElementById('highlight-submit-btn').innerText = "Post Highlight";
                const cancelBtn = document.getElementById('highlight-cancel-btn'); if (cancelBtn) cancelBtn.classList.add('hidden');
            },
            viewHighlight: (id) => {
                const h = state.highlights.find(x => x.id === id); if (h.type === 'image') window.open(h.url, '_blank');
                else window.open(`https://www.youtube.com/watch?v=${h.url.split('v=')[1]?.split('&')[0] || h.url.split('/').pop()}`, '_blank');
            },
            renderHighlights: () => {
                const list = document.getElementById('admin-highlights-list'); if(!list) return;
                list.innerHTML = state.highlights.map(h => `<div class="bg-white p-4 rounded-3xl flex flex-col gap-3 shadow-sm border border-slate-50 text-indigo-950 font-black"><img src="${h.type === 'image' ? h.url : 'https://img.youtube.com/vi/'+(h.url.split('v=')[1]?.split('&')[0] || h.url.split('/').pop())+'/mqdefault.jpg'}" class="h-32 w-full object-cover rounded-xl bg-slate-50" onerror="this.src='https://via.placeholder.com/300x200?text=No+Preview'"><div class="flex justify-between items-center px-1 font-black text-sm text-indigo-950"><span class="truncate flex-1">${h.title}</span><div class="flex gap-1 ml-2"><button onclick="admin.viewHighlight('${h.id}')" class="text-indigo-400 hover:text-indigo-600"><span class="material-symbols-outlined text-sm">visibility</span></button><button onclick="admin.initiateHighlightEdit('${h.id}')" class="text-indigo-400 hover:text-indigo-600"><span class="material-symbols-outlined text-sm">edit</span></button><button onclick="admin.deleteHighlight('${h.id}')" class="text-red-300 hover:text-red-600"><span class="material-symbols-outlined text-sm">delete</span></button></div></div></div>`).join('') || '<div class="text-slate-300 py-10 text-center col-span-full italic">No highlights.</div>';
            },
            deleteHighlight: async (id) => { if (!state.user) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'highlights', id)); showToast("Highlight deleted"); },
            initiateSecureDelete: () => { const pinInput = document.getElementById('delete-pin-input'); if (pinInput) pinInput.value = ''; document.getElementById('delete-pin-modal').classList.remove('hidden-modal'); },
            closeDeleteModal: () => document.getElementById('delete-pin-modal').classList.add('hidden-modal'),
            executeSecureDelete: async () => { if (!state.user) return; if (document.getElementById('delete-pin-input').value === '123') { const sId = state.activeStudentId; const yearKey = state.selectedYear.replace('-', '_'); admin.closeDeleteModal(); admin.closeModal(); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`, sId)); showToast("Record deleted", "success"); } else showToast("Incorrect Code", "error"); },
            viewConcessionSlip: () => { const s = state.students.find(x => x.id === state.activeStudentId); if(s?.concessionSlip) window.open(s.concessionSlip, '_blank'); },
            exportExcel: () => { const rows = state.students.map(s => ({ ID: s.admnNo || s.ID, Name: s.name || s.Student, Grade: s.class || s.Grade, Parent: s.father || s.Parent, Fee: s.fee || s.Target_Fee, Paid: s.paid || s.Total_Paid })); const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Records"); XLSX.writeFile(wb, `SSV_Registry_Export.xlsx`); },
            importBulkData: (event) => { if (!state.user) return; const f = event.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { const b = e.target.result; const w = XLSX.read(b, {type:'binary'}); const j = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]); const yearKey = state.selectedYear.replace('-', '_'); const colRef = collection(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`); j.forEach(async row => { const d = { admnNo:String(row.ID || row.admnNo || ''), name:String(row.Name || row.name || ''), class:String(row.Grade || row.class || 'Nursery'), father:String(row.Parent || row.father || ''), contact:String(row.Contact || row.contact || ''), fee:parseFloat(row.Fee || row.fee || 0), paid:parseFloat(row.Paid || row.paid || 0), history:[], timestamp:Date.now() }; if(d.name) await addDoc(colRef, d); }); showToast("Bulk migration sync started...", "success"); }; r.readAsBinaryString(f); },
            exportJSON: () => { 
                const b = new Blob([JSON.stringify(state.students, null, 2)], { type: "application/json" }); 
                const u = URL.createObjectURL(b); 
                const a = document.createElement('a'); 
                a.href = u; a.download = `SSV_Backup_${state.selectedYear}_${Date.now()}.json`; 
                a.click(); 
                showToast("JSON Backup Exported", "success");
            },
            importJSON: async (e) => { 
                if (!state.user) return; 
                const f = e.target.files[0]; if(!f) return; 
                const r = new FileReader(); 
                r.onload = async (evt) => { 
                    try {
                        const yearKey = state.selectedYear.replace('-', '_');
                        const j = JSON.parse(evt.target.result); 
                        if (!Array.isArray(j)) throw new Error("Invalid Format");
                        for (const s of j) { 
                            const id = s.id || Date.now().toString() + Math.random().toString(36).substr(2, 5); 
                            delete s.id; 
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `students_${yearKey}`, id), s); 
                        } 
                        showToast("JSON Import Successful", "success");
                    } catch(err) { showToast("Import Failed: Invalid JSON", "error"); }
                }; 
                r.readAsText(f); 
            }
        };

        window.printer = {
            printReceipt: (ts) => {
                const s = state.students.find(x => x.id === state.activeStudentId); const h = s.history.find(x => x.timestamp == ts);
                document.getElementById('printable-area').innerHTML = `<div style="border:5px double #000;padding:50px;font-family:sans-serif;max-width:650px;margin:auto;background:white;"><h1 style="text-align:center;text-transform:uppercase;">Sri Sai Vidyalayam</h1><p style="text-align:center;border-bottom:1px solid #000;padding:10px 0;">FEE RECEIPT • ${new Date(h.timestamp).toLocaleDateString()}</p><p><b>ID:</b> ${s.admnNo || s.ID}</p><p><b>Name:</b> ${s.name || s.Student}</p><h2>PAID: ₹${parseFloat(h.amount).toLocaleString()}</h2></div>`; window.print();
            },
            printLedger: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                const sName = s.name || s.Student || 'Unnamed';
                const sClass = s.class || s.Grade || 'Nursery';
                document.getElementById('printable-area').innerHTML = `<div style="padding:40px;font-family:sans-serif;background:white;"><h1>Summary: ${sName}</h1><p>Class: ${sClass} | Session: ${state.selectedYear}</p><table style="width:100%;border-collapse:collapse;margin-top:20px;"><thead><tr style="background:#1e1b4b;color:#fff;"><th style="padding:10px;text-align:left;">Date</th><th style="padding:10px;text-align:left;">Remark</th><th style="padding:10px;text-align:right;">Amount</th></tr></thead><tbody>${s.history.map(h => `<tr><td style="border:1px solid #ddd;padding:10px;">${new Date(h.timestamp).toLocaleDateString()}</td><td style="border:1px solid #ddd;padding:10px;">${h.remark||'Fee'}</td><td style="border:1px solid #ddd;padding:10px;text-align:right;">₹${parseFloat(h.amount).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`; window.print();
            },
            printMasterLedger: () => {
                document.getElementById('printable-area').innerHTML = `<div style="padding:40px;font-family:sans-serif;background:white;"><h1 style="text-align:center;">Sri Sai Vidyalayam - Student Ledger (${state.selectedYear})</h1><table style="width:100%;border-collapse:collapse;margin-top:30px;"><thead style="background:#1e1b4b;color:#fff;"><tr><th style="padding:10px;border:1px solid #ddd;">ID</th><th style="padding:10px;border:1px solid #ddd;">Name</th><th style="padding:10px;border:1px solid #ddd;">Class</th><th style="padding:10px;border:1px solid #ddd;text-align:right;">Due</th></tr></thead><tbody>${state.students.map(s => {
                    const sDue = (parseFloat(s.fee || s.Target_Fee || 0) + (parseFloat(s.oldDue || s.Previous_Dues || 0))) - (parseFloat(s.paid || s.Total_Paid || 0));
                    return `<tr><td style="border:1px solid #ddd;padding:10px;">${s.admnNo || s.ID || '???'}</td><td style="border:1px solid #ddd;padding:10px;">${s.name || s.Student || 'Unnamed'}</td><td style="border:1px solid #ddd;padding:10px;">${s.class || s.Grade || 'Nursery'}</td><td style="border:1px solid #ddd;padding:10px;text-align:right;">₹${sDue.toLocaleString()}</td></tr>`;
                }).join('')}</tbody></table></div>`; window.print();
            }
        };

        // Standard init on load
        (async () => { 
            await initAuth(); 
            // Default load Home
            if (!document.querySelector('.view-section:not(.hidden)')) {
                router.navigate('home');
            }
        })();
    </script>
</body>
</html>
