<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Sai Vidyalayam - Admin Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <style>
        body { font-family: 'Open Sans', sans-serif; }
        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }
        
        .modal { transition: opacity 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; }
        
        /* Video containers - Forced overflow hidden and border-radius */
        .video-container { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            max-width: 100%; 
            background: #1e1e1e; 
            border-radius: 20px; 
            cursor: pointer; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .video-container iframe, .video-container video { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: none !important; 
            object-fit: cover;
        }

        /* Aspect ratio for portrait/vertical media */
        .video-container.vertical { 
            padding-bottom: 177.77%; 
            height: 0; 
            position: relative; 
            width: 100%; 
            overflow: hidden; 
            border-radius: 20px; 
            background: #1e1e1e; 
            border: 1px solid #e2e8f0; 
            cursor: pointer; 
        }

        /* Video Play Overlay */
        .play-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }
        .play-overlay:hover { background: rgba(0,0,0,0.5); }
        .play-button-icon {
            font-size: 80px !important;
            color: white;
            filter: drop-shadow(0 4px 15px rgba(0,0,0,0.6));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .video-container:hover .play-button-icon { transform: scale(1.1); }

        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                background: white; 
                padding: 20px;
            }
            .no-print { display: none !important; }
        }

        #status-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 200;
            transform: translateY(100px);
            transition: transform 0.3s ease-out;
        }
        #status-toast.show { transform: translateY(0); }

        /* Animation for Hero Elements */
        .cloud-float { 
            animation: float 15s ease-in-out infinite alternate; 
            transform-box: fill-box;
        }
        @keyframes float { 
            from { transform: translateX(-20px); } 
            to { transform: translateX(40px); } 
        }

        .bus-drive {
            animation: driveAcross 18s linear infinite;
            transform-box: view-box;
        }
        @keyframes driveAcross {
            from { transform: translateX(850px); }
            to { transform: translateX(-200px); }
        }

        #hero-text-slider .slide { display: none; animation: fadeIn 0.8s ease-in-out; }
        #hero-text-slider .slide.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- STATUS TOAST -->
    <div id="status-toast" class="bg-indigo-950 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 font-bold border border-indigo-700">
        <span class="material-symbols-outlined text-amber-400" id="toast-icon">check_circle</span>
        <span id="toast-msg">Action Successful</span>
    </div>

    <!-- NAVIGATION -->
    <nav class="bg-indigo-950 text-white shadow-xl sticky top-0 z-40 no-print border-b border-indigo-800">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center space-x-4 cursor-pointer group" onclick="router.navigate('home')">
                    <div class="bg-white text-indigo-950 h-12 w-12 rounded-2xl flex items-center justify-center font-bold text-xl border-2 border-amber-400 transform group-hover:rotate-6 transition">SSV</div>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight leading-none uppercase">Sri Sai Vidyalayam</h1>
                        <p class="text-[9px] text-amber-400 uppercase tracking-[0.3em] font-black mt-1">Excellence in Education</p>
                    </div>
                </div>
                <div class="hidden md:flex space-x-2 items-center">
                    <button class="hover:bg-indigo-800/50 px-4 py-2 rounded-lg transition font-bold text-sm uppercase tracking-wider" onclick="router.navigate('home')">Home</button>
                    <button class="bg-amber-500 hover:bg-amber-400 text-indigo-950 px-5 py-2.5 rounded-xl font-black transition flex items-center gap-2 shadow-lg shadow-amber-500/20 text-xs uppercase" onclick="router.navigate('login')">
                        <span class="material-symbols-outlined text-lg">admin_panel_settings</span>
                        Portal Access
                    </button>
                </div>
                <button class="md:hidden p-2 rounded-lg bg-indigo-800" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                    <span class="material-symbols-outlined text-3xl">menu_open</span>
                </button>
            </div>
        </div>
        <div class="hidden md:hidden bg-indigo-950 p-4 border-t border-indigo-800" id="mobile-menu">
            <button class="block w-full text-left py-3 px-4 rounded-xl hover:bg-indigo-900 mb-2 font-bold" onclick="router.navigate('home')">Home</button>
            <button class="block w-full text-left py-3 px-4 bg-amber-500 text-indigo-950 rounded-xl font-black uppercase text-xs" onclick="router.navigate('login')">Admin Login</button>
        </div>
    </nav>

    <div id="app">
        
        <!-- VIEW: HOME -->
        <div id="view-home" class="min-h-screen hidden">
            <section class="hero-bg pt-12 md:pt-20 pb-0 border-b border-slate-200 min-h-[500px] md:min-h-[650px] flex flex-col">
                <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center flex-1">
                    <div class="relative z-10 text-center lg:text-left space-y-6">
                        <span class="inline-block px-4 py-1.5 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-widest">Recognised by Govt of AP</span>
                        <div id="hero-text-slider" class="min-h-[220px] md:min-h-[280px]">
                            <div class="slide active">
                                <h2 class="text-5xl md:text-7xl font-extrabold text-indigo-950 leading-[1.1]">Pollution Free <br><span class="text-indigo-600 underline decoration-amber-400 underline-offset-8">Green Campus</span></h2>
                                <p class="text-lg text-slate-600 mt-4 font-medium leading-relaxed">A serene environment located away from city noise and dust, ensuring fresh air and focused learning.</p>
                            </div>
                            <div class="slide">
                                <h2 class="text-5xl md:text-7xl font-extrabold text-indigo-950 leading-[1.1]">Expert & <br><span class="text-indigo-600 underline decoration-amber-400 underline-offset-8">Dedicated Faculty</span></h2>
                                <p class="text-lg text-slate-600 mt-4 font-medium leading-relaxed">Highly qualified subject experts who provide personalized attention to every student's growth.</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-center lg:justify-start gap-4 pt-4">
                            <button onclick="window.scrollTo({top: document.getElementById('updates-section').offsetTop - 100, behavior: 'smooth'})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-2xl font-bold shadow-xl shadow-indigo-600/20 transition-all hover:scale-105 uppercase tracking-widest text-xs">View Daily Board</button>
                        </div>
                    </div>
                    <div class="relative h-[300px] md:h-[450px]">
                        <svg viewBox="0 0 800 500" class="w-full h-full drop-shadow-2xl" preserveAspectRatio="xMidYMid meet">
                            <circle cx="700" cy="80" r="45" fill="#FFF176" />
                            <g class="cloud-float" fill="#fff" opacity="0.9">
                                <circle cx="150" cy="100" r="30" /><circle cx="180" cy="100" r="40" /><circle cx="210" cy="100" r="30" />
                            </g>
                            <g transform="translate(100, 250)">
                                <path d="M0 100 Q 60 0 120 100" fill="none" stroke="#ea580c" stroke-width="10" stroke-linecap="round" />
                                <rect x="-10" y="90" width="140" height="15" fill="#4ade80" rx="5" />
                                <g transform="translate(450, 0)">
                                    <line x1="0" y1="0" x2="120" y2="0" stroke="#475569" stroke-width="6" />
                                    <line x1="20" y1="0" x2="20" y2="120" stroke="#475569" stroke-width="2" />
                                    <line x1="100" y1="0" x2="100" y2="120" stroke="#475569" stroke-width="2" />
                                    <rect x="10" y="100" width="100" height="8" fill="#854d0e" rx="2" />
                                </g>
                            </g>
                            <rect x="0" y="400" width="800" height="100" fill="#334155" />
                            <line x1="0" y1="450" x2="800" y2="450" stroke="#fff" stroke-dasharray="30,30" stroke-width="3" />
                            <g class="bus-drive">
                                <rect x="0" y="340" width="160" height="70" rx="12" fill="#fbbf24" />
                                <rect x="15" y="350" width="30" height="20" fill="#f8fafc" opacity="0.7" />
                                <rect x="55" y="350" width="30" height="20" fill="#f8fafc" opacity="0.7" />
                                <rect x="95" y="350" width="50" height="20" fill="#f8fafc" opacity="0.7" />
                                <circle cx="40" cy="410" r="12" fill="#1e293b" />
                                <circle cx="120" cy="410" r="12" fill="#1e293b" />
                                <text x="80" y="385" font-family="sans-serif" font-size="10" font-weight="black" text-anchor="middle" fill="#431407">SRI SAI VIDYALAYAM</text>
                            </g>
                        </svg>
                    </div>
                </div>
            </section>

            <!-- RECENT BLOG SECTION -->
            <section class="max-w-7xl mx-auto px-4 py-24">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 border-b border-indigo-100 pb-10 mb-12">
                    <div>
                        <h2 class="text-5xl font-black text-indigo-950 tracking-tighter uppercase">Recent Blog</h2>
                        <p class="text-slate-500 mt-3 text-lg font-medium">Updates, highlights and memories from Sri Sai Vidyalayam.</p>
                    </div>
                </div>
                <div id="blog-posts-feed" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12"></div>
            </section>

            <div id="updates-section" class="max-w-7xl mx-auto px-4 py-16 grid grid-cols-1 lg:grid-cols-12 gap-12 border-t border-slate-100">
                <div class="lg:col-span-8 space-y-8">
                    <h2 class="text-3xl font-black text-indigo-950 uppercase tracking-tight tracking-widest">Notice Board</h2>
                    <div class="bg-white p-10 rounded-[2.5rem] border border-indigo-50 shadow-sm font-medium leading-relaxed text-slate-600">
                        Stay tuned here for official administrative circulars. For specific daily homework or class test details, please refer to the **Daily Board** on the right.
                    </div>
                </div>
                <div class="lg:col-span-4">
                    <div class="bg-indigo-950 rounded-[40px] shadow-2xl border border-indigo-800 overflow-hidden sticky top-24">
                        <div class="p-8">
                            <h3 class="text-2xl font-black text-white flex items-center gap-3 mb-8 uppercase"><span class="material-symbols-outlined text-amber-400">campaign</span> Daily Board</h3>
                            <div class="space-y-5">
                                <div><label class="text-[10px] uppercase font-black tracking-widest text-indigo-300 mb-2 block text-center text-center">Class Selection</label><select id="home-class-filter" class="w-full bg-indigo-900 border border-indigo-700 text-white rounded-2xl p-4 text-sm outline-none font-bold" onchange="home.renderUpdates()"></select></div>
                                <div class="flex flex-wrap gap-2 pt-2">
                                    <button class="cat-pill bg-white text-indigo-950 px-4 py-2 rounded-xl text-[10px] font-black shadow-lg" onclick="home.setCategory('All')">ALL</button>
                                    <button class="cat-pill bg-indigo-900 text-indigo-200 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-indigo-800 transition" onclick="home.setCategory('Homework')">HOMEWORK</button>
                                    <button class="cat-pill bg-indigo-900 text-indigo-200 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-indigo-800 transition" onclick="home.setCategory('Class Test')">TESTS</button>
                                    <button class="cat-pill bg-indigo-900 text-indigo-200 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-indigo-800 transition" onclick="home.setCategory('Event')">EVENTS</button>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 h-[550px] overflow-y-auto bg-slate-100 rounded-t-[40px]"><ul id="updates-feed" class="space-y-4"></ul></div>
                    </div>
                </div>
            </div>

            <footer class="bg-indigo-950 text-indigo-200 py-16 border-t border-indigo-900 text-center">
                <h3 class="text-white text-2xl font-bold mb-2 text-amber-400 uppercase tracking-tighter text-lg">Sri Sai Vidyalayam</h3>
                <p class="text-[10px] opacity-60 uppercase tracking-[0.2em] font-black">Pendurthi • Visakhapatnam • AP - 531173</p>
            </footer>
        </div>

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="min-h-screen bg-gray-100 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-md p-10 rounded-3xl shadow-2xl relative overflow-hidden border border-gray-200 font-bold">
                <div class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>
                <div class="text-center mb-8">
                    <span class="material-symbols-outlined text-6xl text-blue-900 mb-2">admin_panel_settings</span>
                    <h2 class="text-3xl font-bold text-gray-800 tracking-tight uppercase">Admin Login</h2>
                    <p class="text-gray-500 mt-1 font-bold text-[10px] uppercase tracking-widest text-indigo-900">Portal Access</p>
                </div>
                <form onsubmit="auth.login(event)" class="space-y-6 font-bold">
                    <div><label class="block text-sm font-bold text-gray-700 mb-1 font-bold">User ID</label><input type="text" id="userid" class="w-full border-2 border-gray-100 bg-gray-50 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none transition font-bold" required></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1 font-bold">Password</label><input type="password" id="password" class="w-full border-2 border-gray-100 bg-gray-50 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none transition font-bold" required></div>
                    <button type="submit" class="w-full bg-blue-900 text-white font-black py-4 rounded-2xl hover:bg-blue-800 transition transform active:scale-95 shadow-lg shadow-blue-900/20 uppercase tracking-widest text-xs">Sign In</button>
                </form>
            </div>
        </div>

        <!-- VIEW: ADMIN DASHBOARD -->
        <div id="view-admin" class="min-h-screen bg-gray-50 flex flex-col md:flex-row hidden font-bold">
            <div class="bg-blue-900 text-white w-full md:w-64 flex-shrink-0 flex flex-col md:h-screen md:sticky top-0 no-print shadow-xl">
                <div class="p-6 border-b border-blue-800 font-black text-xl flex items-center gap-2 uppercase tracking-tighter">
                    <span class="material-symbols-outlined text-yellow-400">school</span> Admin Panel
                </div>
                <nav class="flex-1 overflow-y-auto p-4 space-y-1 font-bold">
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="dashboard" onclick="admin.switchTab('dashboard')"><span class="material-symbols-outlined text-blue-300">dashboard</span> Dashboard</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="admissions" onclick="admin.switchTab('admissions')"><span class="material-symbols-outlined text-green-400">person_add</span> Admissions</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="students" onclick="admin.switchTab('students')"><span class="material-symbols-outlined text-cyan-400">group</span> Records</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="blog" onclick="admin.switchTab('blog')"><span class="material-symbols-outlined text-purple-400">article</span> Daily Board</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="manage_blog" onclick="admin.switchTab('manage_blog')"><span class="material-symbols-outlined text-orange-400">post_add</span> Manage Blog</button>
                    <button class="admin-tab w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 flex items-center gap-3 transition" data-tab="data" onclick="admin.switchTab('data')"><span class="material-symbols-outlined text-gray-400">database</span> Maintenance</button>
                </nav>
                <div class="p-4 border-t border-blue-800"><button onclick="auth.logout()" class="w-full bg-red-800 hover:bg-red-700 text-white py-2 rounded-lg text-sm font-black shadow-inner transition active:scale-95 uppercase tracking-widest">Logout</button></div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 p-6 md:p-8 overflow-y-auto">
                <div id="tab-dashboard" class="admin-content space-y-6">
                    <h2 class="text-2xl font-black text-gray-800 flex justify-between items-center uppercase tracking-tight tracking-widest font-bold">Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-blue-500 font-bold"><h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Target</h4><div class="text-3xl font-black text-blue-900" id="stat-total">₹0</div></div>
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-orange-400 font-bold"><h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Old Fee Due</h4><div class="text-3xl font-black text-orange-600" id="stat-old">₹0</div></div>
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-green-500 font-bold"><h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Collected</h4><div class="text-3xl font-black text-green-600" id="stat-collected">₹0</div></div>
                        <div class="bg-white p-6 rounded-xl shadow border-l-8 border-red-500 font-bold"><h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Balance</h4><div class="text-3xl font-black text-red-600" id="stat-pending">₹0</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border border-gray-100 font-bold"><h3 class="font-black text-gray-700 mb-4 uppercase tracking-widest text-[10px]">Collection Trend</h3><div class="h-80 w-full font-bold"><canvas id="feeChart"></canvas></div></div>
                </div>

                <div id="tab-manage_blog" class="admin-content hidden space-y-6">
                    <h2 class="text-2xl font-black text-indigo-950 uppercase tracking-tight tracking-widest font-bold">Blog Management</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 font-bold">
                        <div class="bg-white p-10 rounded-[2.5rem] shadow-xl border border-gray-100 h-fit">
                            <h3 class="font-black text-orange-600 uppercase tracking-widest text-xs border-b pb-4 mb-8">Publish New Post</h3>
                            <form onsubmit="admin.addBlogPost(event)" class="space-y-6 font-bold">
                                <div><label class="block text-[10px] font-black uppercase text-gray-400 mb-2">Post Title</label><input type="text" id="blog-title" class="w-full border-2 border-gray-50 bg-gray-50 rounded-2xl px-4 py-3 outline-none focus:border-orange-500 transition font-bold" required></div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div><label class="block text-[10px] font-black uppercase text-gray-400 mb-2">Publish Date</label><input type="date" id="blog-date" class="w-full border-2 border-gray-50 bg-gray-50 rounded-2xl px-4 py-3 outline-none font-bold" required></div>
                                    <div><label class="block text-[10px] font-black uppercase text-gray-400 mb-2">Media Type</label><select id="blog-type" class="w-full border-2 border-gray-50 bg-gray-50 rounded-2xl px-4 py-3 outline-none font-bold"><option value="image">Photo (jpg/png)</option><option value="local_video">Local Video (mp4)</option><option value="youtube">YouTube (Video/Shorts)</option><option value="instagram">Instagram (Post/Reel)</option></select></div>
                                </div>
                                <div><label class="block text-[10px] font-black uppercase text-gray-400 mb-2">Media Source / URL</label><input type="text" id="blog-url" class="w-full border-2 border-gray-50 bg-gray-50 rounded-2xl px-4 py-3 font-mono text-xs outline-none focus:border-orange-500 transition" placeholder="Paste link or source URL..." required></div>
                                <button type="submit" class="w-full bg-orange-600 text-white font-black py-4 rounded-2xl shadow-lg transition active:scale-95 uppercase tracking-widest text-xs">Publish Blog Post</button>
                            </form>
                        </div>
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-gray-100 h-[650px] overflow-y-auto font-bold">
                            <h3 class="font-black text-indigo-900 uppercase tracking-widest text-[10px] border-b pb-4 mb-6">Manage Existing Posts</h3>
                            <ul id="admin-blog-list" class="space-y-4 font-bold"></ul>
                        </div>
                    </div>
                </div>

                <div id="tab-admissions" class="admin-content hidden space-y-6 font-bold">
                    <h2 class="text-2xl font-black text-gray-800 uppercase tracking-tight font-bold">New Admission</h2>
                    <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100 font-bold">
                        <form onsubmit="admin.submitAdmission(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6 font-bold">
                            <div><label class="block text-sm text-gray-700 mb-1 font-bold">Admission ID</label><input type="text" name="admnNo" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 outline-none focus:border-blue-500" required></div>
                            <div><label class="block text-sm text-gray-700 mb-1 font-bold">Grade</label><select id="admit-class" name="classGrade" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 font-bold"></select></div>
                            <div><label class="block text-sm text-gray-700 mb-1 font-bold">Student Name</label><input type="text" name="name" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3" required></div>
                            <div><label class="block text-sm text-gray-700 mb-1 font-bold">Father's Name / Guardian Name</label><input type="text" name="father" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3" required></div>
                            <div><label class="block text-sm text-gray-700 mb-1 font-bold">Mobile</label><input type="tel" name="contact" pattern="[0-9]{10}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3" required></div>
                            <div><label class="block text-sm text-gray-700 mb-1 font-bold">Concession Slip (JPEG, PNG, PDF)</label><input type="file" id="admit-slip" name="concessionSlip" accept=".jpg,.jpeg,.png,.pdf" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-2 text-xs"></div>
                            
                            <div class="grid grid-cols-3 gap-2 col-span-full border-t pt-6 font-bold">
                                <div><label class="block text-[10px] font-black uppercase text-slate-400 tracking-widest">Yearly Fee</label><input type="number" id="admit-fee" name="totalFee" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 font-black text-indigo-900" required></div>
                                <div><label class="block text-[10px] font-black uppercase text-slate-400 tracking-widest">Old Fee</label><input type="number" name="oldDue" value="0" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 font-black text-orange-600"></div>
                                <div><label class="block text-[10px] font-black uppercase text-slate-400 tracking-widest">Initial Pay</label><input type="number" name="initialPay" value="0" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 font-black text-green-600 focus:border-green-500"></div>
                            </div>
                            <button type="submit" class="col-span-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-blue-700 transition shadow-lg text-xs">Confirm Registration</button>
                        </form>
                    </div>
                </div>

                <div id="tab-students" class="admin-content hidden space-y-6 font-bold">
                    <div class="flex justify-between items-center font-bold font-bold"><h2 class="text-2xl font-black text-indigo-950 uppercase tracking-tight text-center font-bold font-bold font-bold">Student Records</h2>
                        <div class="flex gap-2">
                            <button onclick="printer.printMasterLedger()" class="bg-indigo-700 text-white px-5 py-2 rounded-xl font-black shadow-lg text-[10px] uppercase tracking-widest transition active:scale-95">Print Master Ledger</button>
                            <button onclick="admin.exportExcel()" class="bg-indigo-950 text-white px-5 py-2 rounded-xl font-black shadow-lg text-[10px] uppercase tracking-widest transition active:scale-95">Excel Export</button>
                        </div>
                    </div>
                    <div class="flex gap-2 font-bold font-bold"><select id="filter-class" class="border-2 border-gray-100 rounded-xl bg-white px-4 font-bold font-bold font-bold" onchange="admin.renderStudents()"></select><input type="text" id="filter-search" class="border-2 border-gray-100 rounded-xl flex-1 shadow-sm px-4 py-2 font-bold font-bold font-bold" placeholder="Search records..." oninput="admin.renderStudents()"></div>
                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-x-auto">
                        <table class="min-w-full text-sm font-bold font-bold font-bold">
                            <thead class="bg-gray-50 border-b font-black text-gray-600 uppercase text-[10px] tracking-widest font-bold"><tr><th class="p-5 text-left">ID</th><th class="p-5 text-left">Name</th><th class="p-5 text-left">Class</th><th class="p-5 text-left text-orange-600">Old Fee</th><th class="p-5 text-left">Academic Due</th><th class="p-5 text-left font-black">Net Balance</th><th class="p-5 text-right">Actions</th></tr></thead>
                            <tbody id="student-list-body" class="divide-y divide-gray-100 font-bold font-bold font-bold"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-blog" class="admin-content hidden space-y-6 font-bold">
                    <h2 class="text-2xl font-black text-indigo-950 uppercase tracking-tight font-black uppercase font-bold font-bold">Daily Board</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 font-bold">
                        <div class="bg-white p-6 rounded-3xl shadow border h-fit font-bold">
                            <h3 class="font-black border-b pb-2 mb-4 uppercase tracking-widest text-[10px] text-indigo-400">New Alert</h3>
                            <form onsubmit="admin.addUpdate(event)" class="space-y-4 font-bold">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-bold mb-1">Class</label><select id="update-class" class="w-full border p-3 rounded-xl bg-white font-bold"></select></div>
                                    <div><label class="block text-xs font-bold mb-1">Category</label><select id="update-category" class="w-full border p-3 rounded-xl bg-white font-bold"><option>Homework</option><option>Class Test</option><option>Event</option><option>General News</option></select></div>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-xs font-bold mb-1">Notice Date</label>
                                    <input type="date" id="update-date" class="w-full border p-3 rounded-xl bg-white font-bold" required>
                                </div>
                                <textarea id="update-text" class="w-full border p-4 rounded-xl h-32 font-bold" placeholder="Notice details..." required></textarea>
                                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase tracking-widest text-xs hover:bg-blue-700 shadow-md transition font-bold font-bold">Publish Update</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow h-[650px] overflow-y-auto border font-bold font-bold"><h3 class="font-black border-b pb-2 mb-4 uppercase tracking-widest text-[10px] text-indigo-400 font-black font-bold font-bold">History</h3><ul id="admin-updates-list" class="space-y-3 font-bold font-bold font-bold"></ul></div>
                    </div>
                </div>

                <div id="tab-data" class="admin-content hidden space-y-6 font-bold">
                    <h2 class="text-2xl font-black text-indigo-950 uppercase tracking-tight font-black uppercase font-bold font-bold font-bold font-bold font-bold">System Maintenance</h2>
                </div>
            </div>
        </div>

        <!-- PROFILE MODAL -->
        <div id="profile-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-70 hidden-modal modal no-print p-4">
            <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[3rem] shadow-2xl flex flex-col overflow-hidden font-bold">
                <div class="bg-blue-900 text-white p-6 flex justify-between items-center"><h2 id="modal-title" class="text-2xl font-black uppercase tracking-tighter"></h2><p class="text-[10px] opacity-80 font-mono font-black tracking-[0.2em]">ID: <span id="modal-admn"></span></p><button onclick="admin.closeModal()" class="text-white hover:text-yellow-400 transition font-bold"><span class="material-symbols-outlined text-4xl font-bold">close</span></button></div>
                <div class="flex-1 overflow-y-auto p-10 bg-gray-50">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="space-y-6">
                            <div class="bg-white p-5 rounded-lg shadow border border-gray-100 text-sm font-bold text-indigo-950 leading-loose">
                                <h4 class="font-black text-gray-400 text-[10px] uppercase mb-3 text-center tracking-[0.2em] border-b pb-2 font-bold font-bold font-bold font-bold">Record Info</h4>
                                <p>Grade: <span id="modal-class"></span></p>
                                <p>Parent/Guardian: <span id="modal-father"></span></p>
                                <p>Mobile: <span id="modal-contact"></span></p>
                                <div id="modal-slip-box" class="hidden mt-4 border-t pt-4 space-y-2 font-bold">
                                    <button onclick="admin.viewSlip()" class="w-full bg-indigo-50 text-indigo-700 p-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-indigo-100 transition shadow-sm border border-indigo-100 font-bold">
                                        <span class="material-symbols-outlined text-sm font-bold">visibility</span> View Slip
                                    </button>
                                </div>
                            </div>
                            <div class="bg-blue-50 p-5 rounded-3xl border border-blue-200 shadow-sm text-xs text-blue-900 font-bold space-y-2">
                                <div class="flex justify-between font-black font-bold font-bold"><span>Target:</span> <span id="modal-fee-academic"></span></div>
                                <div class="flex justify-between font-black text-orange-600 font-bold font-bold"><span>Old Fee:</span> <span id="modal-fee-old"></span></div>
                                <div class="flex justify-between font-black text-green-700 font-bold font-bold"><span>Total Paid:</span> <span id="modal-fee-paid"></span></div>
                                <div class="border-t border-blue-200 pt-3 flex justify-between text-red-600 text-base font-black uppercase font-bold font-bold font-bold font-bold"><span>Balance:</span> <span id="modal-fee-due"></span></div>
                            </div>
                            <button onclick="printer.printLedger()" class="w-full bg-white border-2 border-slate-200 p-4 rounded-2xl font-black shadow-sm flex items-center justify-center gap-2 hover:bg-slate-50 transition uppercase tracking-tighter text-xs font-bold font-bold">Print Student Ledger</button>
                        </div>
                        <div class="lg:col-span-2 space-y-6 font-bold font-bold font-bold font-bold">
                            <div class="bg-white p-8 rounded-3xl shadow border border-gray-100 font-bold font-bold">
                                <h4 class="font-black text-gray-800 mb-6 text-center uppercase tracking-[0.4em] text-[10px] border-b pb-2 font-bold font-bold">Record Payment</h4>
                                <form onsubmit="admin.payFee(event)" class="grid grid-cols-2 gap-6 items-end font-bold font-bold font-bold">
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block font-bold font-bold">Receipt #</label><input type="text" id="pay-rec" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 focus:border-blue-500 outline-none font-bold font-bold" required></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block font-bold font-bold">Date</label><input type="date" id="pay-date" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 focus:border-blue-500 outline-none font-bold font-bold" required></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block font-bold font-bold">Ledger</label><select id="pay-category" class="w-full border-2 border-gray-50 bg-gray-50 rounded-xl p-3 font-bold outline-none font-bold font-bold"><option>Academic Fee</option><option>Old Fee</option></select></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block text-green-600 font-bold font-bold">Amount (₹)</label><input type="number" id="pay-amt" class="w-full border-2 border-green-500 p-3 rounded-xl font-black text-green-700 text-xl outline-none font-bold font-bold" required></div>
                                    <button type="submit" class="col-span-2 bg-green-600 text-white py-4 rounded-2xl font-black hover:bg-green-700 shadow transition active:scale-95 uppercase tracking-widest text-xs font-bold font-bold font-bold font-bold">Record Collection</button>
                                </form>
                            </div>
                            <div class="bg-white rounded-3xl shadow border overflow-hidden font-bold font-bold font-bold font-bold font-bold">
                                <table class="w-full text-xs text-left font-bold font-bold font-bold">
                                    <tbody id="modal-history" class="divide-y divide-gray-100 font-bold font-bold font-bold"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="delete-modal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-80 hidden-modal modal font-bold"><div class="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl border border-gray-200 font-bold"><span class="material-symbols-outlined text-6xl text-red-600 mb-2 font-bold font-bold font-bold font-bold">security</span><h3 class="text-xl font-black mb-4 text-red-600 uppercase tracking-widest font-bold font-bold font-bold">Pin Required</h3><input type="password" id="delete-password" class="w-full border-2 border-gray-100 p-5 rounded-2xl text-center mb-8 focus:border-red-500 outline-none font-black text-3xl tracking-widest font-bold font-bold" placeholder="••••"><div class="grid grid-cols-2 gap-4 font-black font-bold font-bold font-bold"><button onclick="admin.closeDeleteModal()" class="bg-gray-100 py-3 rounded-2xl text-gray-600 hover:bg-gray-200 transition uppercase text-[10px] tracking-widest font-bold font-bold">Cancel</button><button onclick="admin.confirmDelete()" class="bg-red-600 text-white py-3 rounded-2xl hover:bg-red-700 shadow-lg transition uppercase text-[10px] tracking-widest font-bold font-bold font-bold">Purge Record</button></div></div></div>

        <div id="printable-area" class="hidden"></div>
    </div>

    <script>
        // GLOBAL UTILITIES
        const parseVideoId = (vUrl) => {
            if (!vUrl) return null;
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/;
            const match = vUrl.match(regex);
            return match ? match[1] : null;
        };

        // APP LOGIC & STATE
        let state = {
            isLoggedIn: false, activeStudentId: null, activeHomeCategory: 'All',
            fees: { "Nursery": 15000, "LKG": 16000, "UKG": 17000, "1st Class": 18000, "2nd Class": 19000, "3rd Class": 20000, "4th Class": 21000, "5th Class": 22000, "6th Class": 23000, "7th Class": 24000, "8th Class": 25000, "9th Class": 28000, "10th Class": 30000 },
            students: [],
            updates: [ { id: 1, text: 'Admissions for 2024-25 session are currently open. Contact school office for registration.', category: 'General News', classGrade: 'All', subject: 'None', date: new Date().toISOString().split('T')[0] } ],
            blogPosts: [ { id: 1, title: 'Integrated LEAD Curriculum Launch', date: '2024-03-22', type: 'youtube', url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ' } ]
        };

        const ui = {
            showToast: (msg, isError = false) => {
                const toast = document.getElementById('status-toast');
                const icon = document.getElementById('toast-icon');
                if(!toast) return;
                document.getElementById('toast-msg').innerText = msg;
                icon.innerText = isError ? 'error' : 'check_circle';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        };

        const auth = {
            login: (e) => {
                e.preventDefault();
                if(document.getElementById('userid').value === 'admin' && document.getElementById('password').value === '123') {
                    state.isLoggedIn = true; router.navigate('admin');
                    ui.showToast('Access Authorized');
                } else ui.showToast('Invalid PIN', true);
            },
            logout: () => { state.isLoggedIn = false; router.navigate('home'); }
        };

        const router = {
            navigate: (view) => {
                if(view === 'admin' && !state.isLoggedIn) return router.navigate('login');
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${view}`);
                if (target) target.classList.remove('hidden');
                if(view === 'home') home.init();
                if(view === 'admin') admin.init();
                window.scrollTo(0,0);
            }
        };

        const home = {
            init: () => {
                const classOpts = Object.keys(state.fees).map(c => `<option value="${c}">${c}</option>`).join('');
                document.querySelectorAll('#home-class-filter').forEach(s => s.innerHTML = `<option value="All">All Classes</option>` + classOpts);
                home.renderUpdates();
                home.renderBlog();
                home.startTextSlider();
            },
            startTextSlider: () => {
                let slides = document.querySelectorAll('#hero-text-slider .slide');
                let current = 0;
                if(window.textInterval) clearInterval(window.textInterval);
                window.textInterval = setInterval(() => {
                    if(slides.length > 0){
                        slides[current].classList.remove('active');
                        current = (current + 1) % slides.length;
                        slides[current].classList.add('active');
                    }
                }, 4500);
            },
            playMedia: (containerId, type, url) => {
                const container = document.getElementById(containerId);
                if(!container) return;

                const getInstaEmbedUrl = (iUrl) => {
                    let clean = iUrl.split('?')[0];
                    if(!clean.endsWith('/')) clean += '/';
                    return clean + 'embed/';
                };

                let playerHtml = '';
                if(type === 'youtube') {
                    let vidId = parseVideoId(url);
                    playerHtml = `<iframe width="100%" height="100%" src="https://www.youtube-nocookie.com/embed/${vidId}?autoplay=1&rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen referrerpolicy="no-referrer-when-downgrade" sandbox="allow-scripts allow-same-origin allow-presentation allow-popups"></iframe>`;
                } else if(type === 'local_video') {
                    playerHtml = `<video width="100%" height="100%" controls autoplay class="rounded-2xl shadow-inner"><source src="${url}" type="video/mp4">Your browser does not support video.</video>`;
                } else if(type === 'instagram') {
                    playerHtml = `<iframe width="100%" height="100%" src="${getInstaEmbedUrl(url)}" scrolling="no" allowtransparency="true" referrerpolicy="no-referrer"></iframe>`;
                }

                container.innerHTML = playerHtml;
                container.classList.remove('cursor-pointer');
            },
            renderBlog: () => {
                document.getElementById('blog-posts-feed').innerHTML = state.blogPosts.map((p, idx) => {
                    let mediaPlaceholder = '';
                    const containerId = `blog-media-${idx}`;

                    if(p.type === 'image') {
                        mediaPlaceholder = `<img src="${p.url}" class="w-full h-80 object-cover rounded-3xl shadow-md" onerror="this.src='https://placehold.co/600x800?text=Post'">`;
                    } else if(p.type === 'local_video') {
                        mediaPlaceholder = `
                        <div id="${containerId}" class="video-container shadow-md" onclick="home.playMedia('${containerId}', '${p.type}', '${p.url}')">
                             <div class="play-overlay"><span class="material-symbols-outlined play-button-icon">play_circle</span></div>
                             <video muted playsinline preload="auto" class="w-full h-full object-cover">
                                <source src="${p.url}" type="video/mp4">
                             </video>
                        </div>`;
                    } else if(p.type === 'youtube') {
                        let vidId = parseVideoId(p.url);
                        let thumbUrl = `https://img.youtube.com/vi/${vidId}/hqdefault.jpg`;
                        mediaPlaceholder = `
                        <div id="${containerId}" class="video-container shadow-md" onclick="home.playMedia('${containerId}', '${p.type}', '${p.url}')">
                            <img src="${thumbUrl}" class="w-full h-full object-cover" onerror="this.src='https://img.youtube.com/vi/${vidId}/mqdefault.jpg'">
                            <div class="play-overlay"><span class="material-symbols-outlined play-button-icon">play_circle</span></div>
                        </div>`;
                    } else if(p.type === 'instagram') {
                        mediaPlaceholder = `
                        <div id="${containerId}" class="video-container vertical shadow-md" onclick="home.playMedia('${containerId}', '${p.type}', '${p.url}')">
                             <div class="play-overlay"><span class="material-symbols-outlined play-button-icon">play_circle</span></div>
                             <div class="flex flex-col items-center justify-center h-full text-indigo-300 bg-slate-50 uppercase font-black text-[9px] tracking-widest">
                                <span class="material-symbols-outlined text-4xl mb-2 text-indigo-900">video_library</span>Tap to Play Reel
                             </div>
                        </div>`;
                    }

                    return `
                    <div class="bg-white rounded-[3rem] p-5 shadow-sm border border-indigo-50 group transition-all hover:shadow-2xl font-bold">
                        ${mediaPlaceholder}
                        <div class="p-6">
                            <div class="flex items-center gap-2 text-slate-400 text-[10px] font-black uppercase tracking-widest mb-3">
                                <span class="material-symbols-outlined text-sm">schedule</span> ${p.date}
                            </div>
                            <h3 class="font-black text-xl text-indigo-950 mb-4 group-hover:text-indigo-600 transition leading-tight uppercase tracking-tighter">${p.title}</h3>
                            <div class="flex justify-between items-center border-t border-slate-50 pt-4">
                                <a href="${p.url}" target="_blank" class="text-indigo-600 font-black text-[9px] uppercase tracking-widest flex items-center gap-1 hover:underline">
                                    <span class="material-symbols-outlined text-xs">open_in_new</span> Link
                                </a>
                                <span class="text-[9px] uppercase font-black text-slate-300 tracking-widest">${p.type.replace('_', ' ')}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('') || '<div class="col-span-full text-center py-20 opacity-30 font-black tracking-widest uppercase">No blog posts found</div>';
            },
            setCategory: (cat) => {
                state.activeHomeCategory = cat;
                document.querySelectorAll('.cat-pill').forEach(btn => {
                    if(btn.innerText.toUpperCase() === cat.toUpperCase() || (cat === 'All' && btn.innerText === 'ALL')) {
                        btn.classList.add('bg-white', 'text-indigo-950'); btn.classList.remove('bg-indigo-900', 'text-indigo-200');
                    } else {
                        btn.classList.remove('bg-white', 'text-indigo-950'); btn.classList.add('bg-indigo-900', 'text-indigo-200');
                    }
                });
                home.renderUpdates();
            },
            renderUpdates: () => {
                const classFilter = document.getElementById('home-class-filter').value;
                const filtered = state.updates.filter(u => (u.classGrade === 'All' || u.classGrade === classFilter) && (state.activeHomeCategory === 'All' || u.category === state.activeHomeCategory));
                document.getElementById('updates-feed').innerHTML = filtered.map(u => `
                    <li class="update-card glass-card p-6 border-l-4 ${u.category === 'Homework' ? 'border-emerald-500' : u.category === 'Class Test' ? 'border-rose-500' : 'border-indigo-500'}">
                        <div class="flex justify-between items-start mb-3"><span class="text-[10px] font-black uppercase text-slate-400 tracking-widest font-black font-bold font-bold">${u.category}</span><span class="date-highlight font-black font-bold">${u.date}</span></div>
                        <p class="text-sm font-bold text-indigo-950 leading-relaxed tracking-tight font-black font-bold">${u.text}</p>
                    </li>`).join('') || '<div class="text-center py-24 opacity-20 font-black uppercase tracking-widest font-bold">Empty Board</div>';
            }
        };

        const admin = {
            init: () => {
                admin.switchTab('dashboard');
                const opts = Object.keys(state.fees).map(c => `<option value="${c}">${c}</option>`).join('');
                document.querySelectorAll('#admit-class, #update-class, #filter-class').forEach(s => {
                    s.innerHTML = (s.id === 'filter-class' || s.id === 'update-class' ? '<option value="All">All Classes</option>' : '') + opts;
                });
                
                // Safe initialization for date fields
                const updateDate = document.getElementById('update-date');
                if (updateDate) updateDate.valueAsDate = new Date();
                
                const blogDate = document.getElementById('blog-date');
                if (blogDate) blogDate.valueAsDate = new Date();
            },
            switchTab: (tab) => {
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`tab-${tab}`);
                if (target) target.classList.remove('hidden');
                document.querySelectorAll('.admin-tab').forEach(b => {
                    b.classList.remove('bg-blue-800', 'text-white');
                    if(b.dataset.tab === tab) b.classList.add('bg-blue-800', 'text-white');
                });
                if(tab === 'dashboard') admin.renderDash();
                if(tab === 'students') admin.renderStudents();
                if(tab === 'blog') admin.renderHistory();
                if(tab === 'manage_blog') admin.renderBlogList();
            },
            renderDash: () => {
                let tExp = 0, tCol = 0, tOldRem = 0;
                state.students.forEach(s => {
                    tExp += s.totalFee + s.oldDue; tCol += s.paid;
                    const paidOld = s.history.filter(h => h.category === 'Old Fee').reduce((sum, h) => sum + h.amount, 0);
                    tOldRem += Math.max(0, s.oldDue - paidOld);
                });
                document.getElementById('stat-total').innerText = `₹${tExp.toLocaleString()}`;
                document.getElementById('stat-old').innerText = `₹${tOldRem.toLocaleString()}`;
                document.getElementById('stat-collected').innerText = `₹${tCol.toLocaleString()}`;
                document.getElementById('stat-pending').innerText = `₹${Math.max(0, tExp - tCol).toLocaleString()}`;
                const cv = document.getElementById('feeChart');
                if(!cv) return;
                const ctx = cv.getContext('2d');
                if(window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, { type: 'line', data: { labels: ['Target', 'Collection', 'Balance'], datasets: [{ label: 'Fees Progress', data: [tExp, tCol, tExp-tCol], borderColor: '#1e3a8a', tension: 0.4, fill: true, backgroundColor: 'rgba(30, 58, 138, 0.05)', pointRadius: 5 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            },
            updateFeePreview: () => { document.getElementById('admit-fee').value = state.fees[document.getElementById('admit-class').value] || 0; },
            submitAdmission: (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const sId = Date.now();
                
                const processAdmission = (slipData) => {
                    state.students.push({ 
                        id: sId, 
                        admnNo: fd.get('admnNo'), 
                        name: fd.get('name'), 
                        father: fd.get('father'), 
                        contact: fd.get('contact'), 
                        classGrade: fd.get('classGrade'), 
                        totalFee: parseFloat(fd.get('totalFee')), 
                        oldDue: parseFloat(fd.get('oldDue') || 0), 
                        paid: 0, 
                        history: [],
                        concessionSlipName: fd.get('concessionSlip')?.name || 'None',
                        concessionSlipData: slipData
                    });

                    const init = parseFloat(fd.get('initialPay') || 0);
                    if(init > 0) { 
                        const s = state.students.find(x => x.id === sId); 
                        s.paid = init; 
                        s.history.push({ receiptNo: 'REC-'+sId.toString().slice(-4), date: new Date().toISOString().split('T')[0], mode: 'Cash', amount: init, category: 'Academic Fee' }); 
                    }
                    ui.showToast('Admission Recorded'); 
                    e.target.reset(); 
                    admin.switchTab('students');
                    admin.renderDash();
                };

                const slipFile = document.getElementById('admit-slip').files[0];
                if (slipFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => processAdmission(event.target.result);
                    reader.readAsDataURL(slipFile);
                } else {
                    processAdmission(null);
                }
            },
            renderStudents: () => {
                const cls = document.getElementById('filter-class').value;
                const txt = document.getElementById('filter-search').value.toLowerCase();
                const filtered = state.students.filter(s => (cls === 'All' || s.classGrade === cls) && (s.name.toLowerCase().includes(txt) || s.admnNo.toLowerCase().includes(txt)));
                document.getElementById('student-list-body').innerHTML = filtered.map(s => {
                    const remOld = Math.max(0, s.oldDue - s.paid);
                    const remAcad = s.totalFee - Math.max(0, s.paid - s.oldDue);
                    const totalDue = remOld + remAcad;
                    return `<tr class="hover:bg-blue-50 transition cursor-pointer border-b font-bold" onclick="admin.openModal(${s.id})">
                        <td class="p-4 font-mono text-slate-400 text-xs">${s.admnNo}</td><td class="p-4 font-black text-slate-700">${s.name}</td><td class="p-4 font-medium text-slate-500 font-bold font-bold font-bold">${s.classGrade}</td>
                        <td class="p-4 text-orange-600 font-bold font-bold font-bold font-bold font-bold">₹${remOld.toLocaleString()}</td><td class="p-4 text-slate-400 font-bold tracking-tighter font-bold font-bold font-bold font-bold">₹${s.totalFee.toLocaleString()}</td>
                        <td class="p-4 text-blue-600 font-black tracking-tighter font-bold font-bold font-bold font-bold">₹${remAcad.toLocaleString()}</td><td class="p-4 font-black ${ totalDue > 0 ? 'text-red-600' : 'text-green-600' } tracking-tight font-bold font-bold font-bold font-bold">₹${totalDue.toLocaleString()}</td>
                        <td class="p-4 text-right font-bold font-bold font-bold font-bold font-bold font-bold"><button class="bg-blue-900 text-white px-3 py-1 rounded shadow-sm text-[10px] uppercase font-bold tracking-widest transition hover:bg-blue-800 font-bold font-bold font-bold font-bold font-bold">Manage</button></td></tr>`;
                }).join('');
            },
            openModal: (id) => {
                state.activeStudentId = id; const s = state.students.find(x => x.id === id);
                document.getElementById('modal-title').innerText = s.name; document.getElementById('modal-admn').innerText = s.admnNo;
                document.getElementById('modal-class').innerText = s.classGrade; document.getElementById('modal-father').innerText = s.father;
                document.getElementById('modal-contact').innerText = s.contact;
                
                const slipBox = document.getElementById('modal-slip-box');
                if (s.concessionSlipData) slipBox.classList.remove('hidden');
                else slipBox.classList.add('hidden');

                document.getElementById('modal-fee-academic').innerText = `₹${s.totalFee.toLocaleString()}`;
                document.getElementById('modal-fee-old').innerText = `₹${s.oldDue.toLocaleString()}`;
                document.getElementById('modal-fee-paid').innerText = `₹${s.paid.toLocaleString()}`;
                document.getElementById('modal-fee-due').innerText = `₹${((s.totalFee + s.oldDue) - s.paid).toLocaleString()}`;
                
                document.getElementById('modal-history').innerHTML = [...s.history].reverse().map((h) => `
                <tr>
                    <td class="p-4 font-bold text-slate-400 tracking-tighter uppercase text-[10px]">${h.date}</td>
                    <td class="p-4 font-black text-blue-900 uppercase text-[10px] tracking-widest">${h.category}</td>
                    <td class="p-4 text-right font-black text-emerald-600 tracking-tight">₹${h.amount.toLocaleString()}</td>
                    <td class="p-4 text-right">
                        <button onclick="printer.printReceipt(${s.id}, '${h.receiptNo}')" class="text-indigo-600 hover:text-indigo-900">
                            <span class="material-symbols-outlined text-sm">print</span>
                        </button>
                    </td>
                </tr>`).join('');
                
                document.getElementById('profile-modal').classList.remove('hidden-modal');
                document.getElementById('pay-rec').value = 'REC-' + Date.now().toString().slice(-6);
                document.getElementById('pay-date').valueAsDate = new Date();
            },
            viewSlip: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                if (s && s.concessionSlipData) {
                    const win = window.open();
                    win.document.write('<iframe src="' + s.concessionSlipData + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
                }
            },
            closeModal: () => document.getElementById('profile-modal').classList.add('hidden-modal'),
            showDeleteConfirm: () => { document.getElementById('delete-password').value = ''; document.getElementById('delete-modal').classList.remove('hidden-modal'); },
            closeDeleteModal: () => document.getElementById('delete-modal').classList.add('hidden-modal'),
            confirmDelete: () => { if(document.getElementById('delete-password').value === '123') { state.students = state.students.filter(s => s.id !== state.activeStudentId); admin.closeDeleteModal(); admin.closeModal(); admin.renderStudents(); admin.renderDash(); ui.showToast('Profile Purged'); } else ui.showToast('Access Denied', true); },
            payFee: (e) => { e.preventDefault(); const s = state.students.find(x => x.id === state.activeStudentId); const amt = parseFloat(document.getElementById('pay-amt').value); s.paid += amt; s.history.push({ receiptNo: document.getElementById('pay-rec').value, date: document.getElementById('pay-date').value, category: document.getElementById('pay-category').value, mode: 'Cash', amount: amt }); admin.openModal(s.id); admin.renderStudents(); admin.renderDash(); ui.showToast('Saved'); },
            
            addUpdate: (e) => {
                e.preventDefault();
                state.updates.unshift({ id: Date.now(), text: document.getElementById('update-text').value, category: document.getElementById('update-category').value, classGrade: document.getElementById('update-class').value, subject: 'None', date: document.getElementById('update-date').value });
                ui.showToast('Posted!'); document.getElementById('update-text').value = ''; admin.renderHistory();
            },
            renderHistory: () => { document.getElementById('admin-updates-list').innerHTML = state.updates.map(u => `<li class="bg-slate-50 p-4 rounded-xl flex justify-between items-center border border-gray-100 mb-3 shadow-sm group font-bold"><div><div class="text-[9px] font-black text-gray-400 uppercase tracking-widest font-bold font-bold font-bold font-bold">${u.category} • ${u.classGrade}</div><div class="text-sm font-bold text-gray-800 font-black tracking-tight font-bold font-bold font-bold font-bold">${u.text}</div><div class="text-[9px] mt-1 font-bold text-blue-600 tracking-wider font-black font-bold font-bold font-bold font-bold">${u.date}</div></div><button onclick="admin.deleteUpdate(${u.id})" class="text-red-600 bg-white shadow-sm w-10 h-10 rounded-full flex items-center justify-center transition active:scale-75 group-hover:bg-red-600 group-hover:text-white shadow-inner font-bold font-bold font-bold font-bold font-bold"><span class="material-symbols-outlined text-sm font-bold font-bold font-bold font-bold font-bold">delete</span></button></li>`).join(''); },
            deleteUpdate: (id) => { state.updates = state.updates.filter(u => u.id !== id); admin.renderHistory(); ui.showToast('Notice Removed'); },
            
            addBlogPost: (e) => {
                e.preventDefault();
                state.blogPosts.unshift({ id: Date.now(), title: document.getElementById('blog-title').value, date: document.getElementById('blog-date').value, type: document.getElementById('blog-type').value, url: document.getElementById('blog-url').value });
                ui.showToast('Blog Post Published'); 
                document.getElementById('blog-title').value = '';
                document.getElementById('blog-url').value = '';
                admin.renderBlogList(); home.renderBlog();
            },
            renderBlogList: () => {
                document.getElementById('admin-blog-list').innerHTML = state.blogPosts.map(p => {
                    let previewMarkup = '';
                    if(p.type === 'image') previewMarkup = `<img src="${p.url}" class="w-12 h-12 rounded-lg object-cover shadow-sm">`;
                    else if(p.type === 'youtube') previewMarkup = `<img src="https://img.youtube.com/vi/${parseVideoId(p.url)}/hqdefault.jpg" class="w-12 h-12 rounded-lg object-cover shadow-sm">`;
                    else previewMarkup = `<div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center text-slate-400"><span class="material-symbols-outlined">play_circle</span></div>`;

                    return `<li class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100 flex justify-between items-center group font-bold font-bold">
                        <div class="flex items-center gap-4">
                            ${previewMarkup}
                            <div>
                                <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest font-black font-bold font-bold font-bold">${p.type} • ${p.date}</div>
                                <div class="text-sm font-bold text-slate-800 font-black tracking-tight uppercase font-bold font-bold font-bold">${p.title}</div>
                            </div>
                        </div>
                        <button onclick="admin.deleteBlogPost(${p.id})" class="text-red-600 bg-white shadow-sm w-10 h-10 rounded-full flex items-center justify-center transition active:scale-75 group-hover:bg-red-600 group-hover:text-white shadow-inner transition font-bold font-bold font-bold"><span class="material-symbols-outlined text-sm font-bold font-bold font-bold">delete</span></button></li>`;
                }).join('');
            },
            deleteBlogPost: (id) => { state.blogPosts = state.blogPosts.filter(p => p.id !== id); admin.renderBlogList(); home.renderBlog(); ui.showToast('Post Purged'); },

            exportExcel: () => { const data = state.students.map(s => ({"ID": s.admnNo, "Name": s.name, "Class": s.classGrade, "Net Balance": (s.totalFee + s.oldDue) - s.paid})); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Students"); XLSX.writeFile(wb, `SSV_Backup.xlsx`); },
            exportData: () => { const dlAnchor = document.createElement('a'); dlAnchor.setAttribute("href", "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state))); dlAnchor.setAttribute("download", `SSV_Full_System_Backup.json`); dlAnchor.click(); },
            importData: (e) => { const reader = new FileReader(); reader.onload = (event) => { try { state = JSON.parse(event.target.result); admin.init(); ui.showToast('Full System Restored'); } catch(ex){ ui.showToast('Error', true); } }; reader.readAsText(e.target.files[0]); }
        };

        const printer = { 
            printMasterLedger: () => {
                const printable = document.getElementById('printable-area');
                const rows = state.students.map(s => {
                    const remOld = Math.max(0, s.oldDue - s.paid);
                    const remAcad = s.totalFee - Math.max(0, s.paid - s.oldDue);
                    const totalDue = remOld + remAcad;
                    return `
                        <tr>
                            <td style="border:1px solid #ddd; padding:8px;">${s.admnNo}</td>
                            <td style="border:1px solid #ddd; padding:8px;">${s.name}</td>
                            <td style="border:1px solid #ddd; padding:8px;">${s.classGrade}</td>
                            <td style="border:1px solid #ddd; padding:8px; text-align:right;">₹${remOld.toLocaleString()}</td>
                            <td style="border:1px solid #ddd; padding:8px; text-align:right;">₹${remAcad.toLocaleString()}</td>
                            <td style="border:1px solid #ddd; padding:8px; text-align:right;">₹${s.paid.toLocaleString()}</td>
                            <td style="border:1px solid #ddd; padding:8px; text-align:right; font-weight:bold; color:${totalDue > 0 ? 'red' : 'green'};">₹${totalDue.toLocaleString()}</td>
                        </tr>`;
                }).join('');

                printable.innerHTML = `
                    <div style="padding:20px; font-family: sans-serif;">
                        <center>
                            <h1 style="margin:0; color:#1e3a8a;">SRI SAI VIDYALAYAM</h1>
                            <p style="margin:5px 0;">MASTER FEE LEDGER - ${new Date().toLocaleDateString()}</p>
                            <hr style="border: 1px solid #1e3a8a; margin: 15px 0;"/>
                        </center>
                        <table style="width:100%; border-collapse:collapse; font-size:12px;">
                            <thead>
                                <tr style="background:#f1f5f9;">
                                    <th style="border:1px solid #ddd; padding:8px; text-align:left;">Admn ID</th>
                                    <th style="border:1px solid #ddd; padding:8px; text-align:left;">Student Name</th>
                                    <th style="border:1px solid #ddd; padding:8px; text-align:left;">Class</th>
                                    <th style="border:1px solid #ddd; padding:8px; text-align:right;">Rem. Old Fee</th>
                                    <th style="border:1px solid #ddd; padding:8px; text-align:right;">Rem. Acad. Fee</th>
                                    <th style="border:1px solid #ddd; padding:8px; text-align:right;">Total Paid</th>
                                    <th style="border:1px solid #ddd; padding:8px; text-align:right;">Net Balance</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
                window.print();
            },
            printLedger: () => {
                const s = state.students.find(x => x.id === state.activeStudentId);
                const printable = document.getElementById('printable-area');
                printable.innerHTML = `
                    <div style="border: 2px solid #1e3a8a; padding: 30px; font-family: sans-serif;">
                        <center>
                            <h1 style="margin:0; color:#1e3a8a;">SRI SAI VIDYALAYAM</h1>
                            <hr style="border: 1px solid #1e3a8a;"/>
                            <h3>STUDENT LEDGER STATEMENT</h3>
                        </center>
                        <table style="width:100%; margin:20px 0; border-collapse:collapse; font-size:14px;">
                            <tr><td style="padding:5px;"><b>Student:</b> ${s.name}</td><td style="text-align:right;"><b>Admn ID:</b> ${s.admnNo}</td></tr>
                            <tr><td style="padding:5px;"><b>Class:</b> ${s.classGrade}</td><td style="text-align:right;"><b>Guardian:</b> ${s.father}</td></tr>
                        </table>
                        <table style="width:100%; border:1px solid #ddd; border-collapse:collapse; font-size:13px;">
                            <thead style="background:#f1f5f9;">
                                <tr>
                                    <th style="border:1px solid #ddd; padding:10px; text-align:left;">Date</th>
                                    <th style="border:1px solid #ddd; padding:10px; text-align:left;">Category</th>
                                    <th style="border:1px solid #ddd; padding:10px; text-align:left;">Receipt #</th>
                                    <th style="border:1px solid #ddd; padding:10px; text-align:right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${s.history.map(h => `
                                    <tr>
                                        <td style="border:1px solid #ddd; padding:10px;">${h.date}</td>
                                        <td style="border:1px solid #ddd; padding:10px;">${h.category}</td>
                                        <td style="border:1px solid #ddd; padding:10px;">${h.receiptNo}</td>
                                        <td style="border:1px solid #ddd; padding:10px; text-align:right;">₹${h.amount.toLocaleString()}</td>
                                    </tr>`).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background:#f8fafc; font-weight:bold;">
                                    <td colspan="3" style="border:1px solid #ddd; padding:10px; text-align:right;">Total Paid:</td>
                                    <td style="border:1px solid #ddd; padding:10px; text-align:right;">₹${s.paid.toLocaleString()}</td>
                                </tr>
                                <tr style="background:#fff1f1; font-weight:bold; color:red;">
                                    <td colspan="3" style="border:1px solid #ddd; padding:10px; text-align:right;">Outstanding Balance:</td>
                                    <td style="border:1px solid #ddd; padding:10px; text-align:right;">₹${((s.totalFee + s.oldDue) - s.paid).toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>`;
                window.print();
            },
            printReceipt: (studentId, receiptNo) => {
                const s = state.students.find(x => x.id === studentId);
                const h = s.history.find(x => x.receiptNo === receiptNo);
                const printable = document.getElementById('printable-area');
                printable.innerHTML = `
                    <div style="border: 4px double #1e3a8a; padding: 30px; max-width: 650px; margin: auto; position: relative; font-family: sans-serif;">
                        <center>
                            <h1 style="margin:0; color:#1e3a8a;">SRI SAI VIDYALAYAM</h1>
                            <p style="margin:5px 0; font-size:12px;">Pulagalipalem, Pendurthi, Visakhapatnam, AP - 531173</p>
                            <div style="background:#1e3a8a; color:white; padding:5px 25px; display:inline-block; border-radius:20px; margin-top:10px; font-weight:bold;">FEES RECEIPT</div>
                        </center>
                        <div style="margin-top:40px; line-height:2.5; border: 1px solid #eee; padding: 20px; border-radius: 15px;">
                            <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; margin-bottom: 15px;">
                                <span><b>Receipt No:</b> ${h.receiptNo}</span>
                                <span><b>Date:</b> ${h.date}</span>
                            </div>
                            <div><b>Student Name:</b> ${s.name}</div>
                            <div><b>Admission ID:</b> ${s.admnNo} &nbsp;&nbsp; <b>Class:</b> ${s.classGrade}</div>
                            <div><b>Payment Category:</b> ${h.category}</div>
                            <div style="margin-top:25px; padding:20px; border: 2px solid #1e3a8a; background:#f0f7ff; display:flex; justify-content:space-between; align-items:center; border-radius:10px;">
                                <span style="font-size:18px;"><b>AMOUNT PAID:</b></span>
                                <span style="font-size:28px; font-weight:900; color:#1e3a8a;">₹${h.amount.toLocaleString()}/-</span>
                            </div>
                        </div>
                    </div>`;
                window.print();
            }
        };

        // INITIALIZE
        router.navigate('home');
    </script>
</body>
</html>
